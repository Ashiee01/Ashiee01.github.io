<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">

        <!-- prevent caching -->
        <!--<meta http-equiv="cache-control" content="max-age=0" />
        <meta http-equiv="cache-control" content="no-cache" />
        <meta http-equiv="expires" content="0" />
        <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
        <meta http-equiv="pragma" content="no-cache" />-->

        <title>AI Chat &amp; Roleplay (free, no sign-up, fast, unlimited)</title>
        <meta name="description" content="A free &quot;Character AI&quot; chat using Perchance&apos;s new AI text generation feature - chat with AI characters. Just create a character and a scenario for the chat/roleplay, and send a message. Talk to AI characters, no login/sign-up needed - completely free! üòå An AI chat generator that&apos;s fast and has no limits on daily usage. Can do basically any character/scenario type - stories, anime characters, warrior cats roleplay, funny/silly/cute/wholesome, friend/companion/romantic/boyfriend/girlfriend AI/chatbot, movie and TV show characters - if you can describe it, then you can probably create your own chat bot for it. Basically a CAI / Character AI alternative. WARNINGS: (1) Everything the AI says is made up. (2) Inappropriate content (i.e. 18+ chat messages) should only be produced if explicitely prompted. If needed, guide the AI using the &apos;scenario&apos; input - i.e. you can describe your own &apos;filter&apos; / restrictions to the AI.">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <link rel="icon" type="image/png" href="/favicon-32x32-white-bg.png" sizes="32x32">
        <link rel="icon" type="image/png" href="/favicon-16x16-white-bg.png" sizes="16x16">
        
        
        <meta property="og:type" content="website" />
        <!-- <meta property="og:url" content="https://perchance.org/..." />  -->
        <meta property="og:image" content="https://perchance.org/api/getGeneratorScreenshot?generatorName=ai-chat" />
        <!-- <meta property="og:description" content="..." /> -->

        <link rel="preconnect" href="https://3ed577a8ef2db1575c94395be05e8192.perchance.org">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="preconnect" href="https://fonts.googleapis.com">

        <script>
          window.name = window.location.pathname; // for Notification.onclick to not open a new window if that generator is open already
        </script>

    </head>  
    <body style="overscroll-behavior:none;"> <!-- due to overscroll iframe bug in chrome -->
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
        <script>window.mdded4sfef4dsedddse1d34344 = `Error: Ad blocker preventing proper page load?`;</script>
        <script>
          (async function() {
            let sadf5456 = `r i  o t`['replace'](/ /g, "");
            let lkjsfh83 = `s et Ti m e o ut`['replace'](/ /g, "");
            let sdf435i3hkf = "document";
            let a = window[sdf435i3hkf].body;
            while(! window[sadf5456]) await new Promise(r =>  window[lkjsfh83](r,1000));
            await new Promise(r =>  window[lkjsfh83](r,1000));
            if( !window .da_Zz3qe33sEsZ1 || !window.hu_8urej4) {
              a. innerHTML = window. mdded4sfef4dsedddse1d34344;
              window[`successfulPag${""}Load`] = false;
            }
          })();
          window.js0nparse = JSON.parse;
        </script>

        <script>
        // COMPATABILITY TESTING:
        window.canExecuteModernJavascript = true;
        try {

          var str = "";
          str += "\n(async () => { await new Promise(resolve => setTimeout(resolve, 500)); console.log('async/await is supported'); })();";
          str += "\nlet arr = [1,2,3]; for(let a of arr) { arr[0]+=a; }; console.log('let a of arr supported');";
          str += "\nvar m = [1,2,3].map(n => n+1);";
          str += "\nvar k = [...[1,2,3]];";
          str += "\nvar a = (function(a=3) { return a+1; })();";

          window.eval(str);

        } catch(e) {
          window.canExecuteModernJavascript = false;
          // var message = "<div style='overflow:hidden;height:0px;'><h1>Create a Random Generator</h1><p>Perhance is a platform that allows you to create your own custom random generators. You could use it to create your own random text generator for a tabletop RPG, or to make your own random name generator, or to simply create a generator which selects a random item from your list with different weights. You can also save your generator so it has a permalink that you can share with your friends.</p><p>Perchance is based around creating lists which reference other lists. You can adjust the odds of items in each list so that when you randomly select an item from that list, they all have the likelihoods that you've specified. If you'd like to learn how to make a random text generator with Perchance, you should check out the tutorial. It explains all the basic features of the Perchance engine and should get you up and running in only 10 or 20 minutes. Perchance has many powerful features that you don't need to learn from the start, but can learn later if you want to create particularly complex generators.</p><p>I created Perchance because most people are still creating random generators in excel. Those work all right, but excel and other spreadsheets aren't really made for that purpose, so there's a lot to be desired in terms of functionality and ease of use. Whatever you're using it for, I hope you find Perchance useful! You might like to check out our <a href='http://reddit.com/r/perchance'>community forum</a> where you can ask questions and share your random generator creations.</p></div>(„ÄçÔæüÔæõÔæü)ÔΩ£ Sorry! Perchance uses cutting edge browser features that are only available in the latest versions of Chrome and Firefox. All modern browsers will eventually be supported, but for now you'll need to use one of those two. Sorry again for the inconvenience!";
          // //window.alert(message);
          // document.body.innerHTML = message;
        }
        </script>


        <div id="generator-description" style="height:20px; width:20px; z-index:-10; overflow:hidden; position:fixed; bottom:-100px;"><!-- will be filled with description after iframe execution --></div>

        <style>
          .cm-syntax-style1 { color: #f18c16; }
          .cm-syntax-style2 { color: #2795EE; }
          .cm-syntax-style3-comment { color: #A0A1A7; }
        </style>

        <!-- PRELOADED DATA -->
        <script id="preloaded-generator-data" type="notjs">%7B%22name%22:%22ai-chat%22,%22modelText%22:%22ai%20=%20%7Bimport:ai-text-plugin%7D%5Cnupload%20=%20%7Bimport:upload-plugin%7D%5CncommentsPlugin%20=%20%7Bimport:comments-plugin%7D%5CnfullscreenButton%20=%20%7Bimport:fullscreen-button-plugin%7D%5Cn%5CnbotName%20=%20%5BbotNameEl.value.trim()%20%7C%7C%20%5C%22Bot%5C%22%5D%5CnuserName%20=%20%5BuserNameEl.value.trim()%20%7C%7C%20%5C%22User%5C%22%5D%5Cn%5Cninstruction%20%5Cn%20%20$output%20=%20%5Bthis.joinItems(%5C%22%5C%5Cn%5C%22)%5D%5Cn%20%20Please%20write%20the%20next%2010%20messages%20for%20the%20following%20chat/RP%20between%20%5BbotName%5D%20and%20%5BuserName%5D.%5Cn%20%20#%20Here's%20%5BbotName%5D's%20description/personality:%5Cn%20%20---%5Cn%20%20%3C%3C%3CBOT_DESCRIPTION_PLACEHOLDER%3E%3E%3E%5Cn%20%20---%5Cn%20%20#%20Here's%20%5BuserName%5D's%20description/personality:%5Cn%20%20---%5Cn%20%20%3C%3C%3CUSER_DESCRIPTION_PLACEHOLDER%3E%3E%3E%5Cn%20%20---%5Cn%20%20#%20Here's%20the%20scenario:%5Cn%20%20---%5Cn%20%20%3C%3C%3CSCENARIO_PLACEHOLDER%3E%3E%3E%5Cn%20%20---%5Cn%20%20#%20Here's%20what%20has%20happened%20so%20far:%5Cn%20%20---%5Cn%20%20%3C%3C%3CCHAT_LOGS_PLACEHOLDER%3E%3E%3E%5Cn%20%20---%5Cn%20%20Your%20task%20is%20to%20write%20the%20next%2010%20messages%20in%20this%20chat/roleplay%20between%20%5BuserName%5D%20and%20%5BbotName%5D.%20There%20should%20be%20a%20blank%20new%20line%20between%20messages.%5Cn%20%20%5Bthis.nextMessageDraftOrInstruction%20%7C%7C%20writingInstructionsEl.value.trim()%20?%20%5C%22You%20may%20add%20'(OOC:%20...)'%20to%20indicate%20'out%20of%20character'%20notes%20-%20i.e.%20rough%20ideas%20about%20what/how%20you're%20going%20to%20write%20in%20the%20next%20few%20messages.%5C%22%20:%20%5C%22%5C%22%5D%20//%20we%20trick%20the%20AI%20into%20thinking%20that%20*it*%20wrote%20the%20writing%20instructions,%20since%20we're%20putting%20the%20writing%20instructions%20in%20the%20response%20rather%20than%20in%20this%20instruction%20prompt.%5Cn%20%20Use%20*asterisks*%20for%20actions/thoughts/etc.%20in%20usual%20roleplay%20style.%5Cn%20%20IMPORTANT:%20Never%20try%20to%20%5C%22wrap%20up%5C%22%20the%20roleplay.%20This%20is%20a%20never-ending%20roleplay/chat.%20Keep%20the%20story%20going!%5Cn%20%20Multi-line%20messages%20are%20not%20allowed%20-%20each%20individual%20message%20must%20be%20a%20single%20paragraph.%5Cn%20%20Avoid%20unnecessary%20and%20unoriginal%20repetition%20of%20previous%20messages.%5Cn%20%20//%20we%20tell%20it%20to%20write%2010%20messages,%20but%20we'll%20actually%20stop%20it%20after%20the%20first%20message%20via%20%60stopSequences%60%20-%20this%20is%20to%20make%20it%20less%20likely%20to%20try%20to%20%5C%22wrap%20up%5C%22%20the%20chat%20in%20the%20next%20message%20because%20it%20thinks%20it%20has%2010%20messages%20to%20write.%5Cn%20%20Write%20the%20next%2010%20messages%20-%20remember%20to%20make%20them%20interesting,%20authentic,%20descriptive,%20natural,%20engaging,%20and%20creative.%5Cn%20%20%5Cn%5CngetLastMessage()%20=%3E%5Cn%20%20let%20lastMessage%20=%20chatLogsEl.value.trim().replace(/%5C%5Cn+/g,%20%5C%22%5C%5Cn%5C%5Cn%5C%22).split(%5C%22%5C%5Cn%5C%5Cn%5C%22).pop();%5Cn%20%20let%20name%20=%20lastMessage?.split(%5C%22:%5C%22)%5B0%5D.trim();%5Cn%20%20let%20content%20=%20lastMessage?.split(%5C%22:%5C%22).slice(1).join(%5C%22:%5C%22).trim();%5Cn%20%20return%20%7Bname,%20content%7D;%5Cn%5CnlastMessageIsEmpty()%20=%3E%5Cn%20%20return%20getLastMessage().content%20===%20%5C%22%5C%22;%5Cn%5CngetNextTurnName()%20=%3E%5Cn%20%20if(chatLogsEl.value.trim()%20===%20%5C%22%5C%22)%20%7B%5Cn%20%20%20%20return%20botName;%5Cn%20%20%7D%5Cn%20%20//%20we%20need%20to%20work%20out%20who's%20turn%20it%20is%20next,%20so%20we%20can%20set%20the%20startWith%20to%20%5C%22%3Cname%3E:%20%5C%22%20where%20%3Cname%3E%20is%20the%20character%20who%20is%20going%20to%20speak%20next.%5Cn%20%20let%20%7Bname,%20content%7D%20=%20getLastMessage();%5Cn%20%20if(content%20===%20%5C%22%5C%22)%20%7B%5Cn%20%20%20%20return%20name;%20//%20if%20the%20message%20content%20is%20empty,%20then%20we%20assume%20the%20user%20wants%20to%20generate%20a%20message%20with%20that%20name%5Cn%20%20%7D%20else%20%7B%5Cn%20%20%20%20let%20nextName;%5Cn%20%20%20%20if(name%20===%20botName)%20%7B%20nextName%20=%20userName;%20%7D%20else%20%7B%20nextName%20=%20botName;%20%7D%5Cn%20%20%20%20return%20nextName;%5Cn%20%20%7D%5Cn%5CngetStarterText(opts)%20=%3E%5Cn%20%20if(!opts)%20opts%20=%20%7B%7D;%5Cn%20%20//%20We%20make%20the%20AI%20start%20with%20the%20last%205%20messages,%20rather%20than%20putting%20all%20the%20messages%20in%20the%20instruction.%20I%20think%20this%20might%20make%20the%20AI%20less%20likely%20to%20repeat%20the%20last%20message%20since%20it%20can%20more%20easily%20%5C%22see%5C%22%20what%20it%20just%20wrote.%5Cn%20%20let%20lastFewMessagesArr%20=%20chatLogsEl.value.trim().split(%5C%22%5C%5Cn%5C%5Cn%5C%22).slice(-5);%5Cn%20%20if(writingInstructionsEl.value.trim()%20%7C%7C%20opts.nextMessageDraftOrInstruction)%20%7B%5Cn%20%20%20%20//%20Add%20the%20writing%20instructions%20if%20they%20have%20specified%20that%5Cn%20%20%20%20let%20lastMessage%20=%20lastFewMessagesArr.pop();%5Cn%20%20%20%20%5Cn%20%20%20%20if(writingInstructionsEl.value.trim())%20lastFewMessagesArr.push(%60(OOC:%20I'm%20going%20to%20keep%20these%20writing%20instructions%20in%20mind%20as%20I%20write:%20$%7BwritingInstructionsEl.value.trim().replace(/%5C%5Cn+/g,%20%5C%22%20%5C%22)%7D)%60);%5Cn%20%20%20%20//%20if(opts.nextMessageDraftOrInstruction)%20lastFewMessagesArr.push(%60(OOC:%20$%7BwritingInstructionsEl.value.trim()%20?%20%5C%22Also,%20the%5C%22%20:%20%5C%22The%5C%22%7D%20message%20below%20will%20be%20a%20longer,%20more%20creative,%20and%20much-improved%20rewrite%20of%20this%20message:%20%5C%22$%7Bopts.nextMessageDraftOrInstruction.replace(/%5C%5Cn+/g,%20%5C%22%20%5C%22).replace(/%5C%22/g,%20%5C%22'%5C%22)%7D%5C%22%20%3C--%20I'm%20going%20to%20make%20sure%20the%20message%20below%20contains%20*all*%20details%20of%20this%20instruction/idea,%20and%20that%20it's%20basically%20a%20masterpiece%20of%20creative%20writing.)%60);%5Cn%20%20%20%20if(opts.nextMessageDraftOrInstruction)%20lastFewMessagesArr.push(%60(OOC:%20$%7BwritingInstructionsEl.value.trim()%20?%20%5C%22Also,%20note%5C%22%20:%20%5C%22Note%5C%22%7D%20that%20the%20message%20below%20is%20a%20longer%20and%20better%20version%20of%20this%20idea:%20%5C%22$%7Bopts.nextMessageDraftOrInstruction.replace(/%5C%5Cn+/g,%20%5C%22%20%5C%22).replace(/%5C%22/g,%20%5C%22'%5C%22)%7D%5C%22)%60);%5Cn%20%20%20%20%5Cn%20%20%20%20lastFewMessagesArr.push(lastMessage);%5Cn%20%20%7D%5Cn%20%20let%20lastFewMessagesText%20=%20lastFewMessagesArr.join(%5C%22%5C%5Cn%5C%5Cn%5C%22).trim();%5Cn%20%20if(opts.continueMode)%20%7B%5Cn%20%20%20%20return%20lastFewMessagesText.trim();%5Cn%20%20%7D%20else%20if(lastMessageIsEmpty())%20%7B%5Cn%20%20%20%20return%20lastFewMessagesText.trim();%20//%20if%20last%20message%20is%20empty,%20then%20we%20already%20have%20the%20%5C%22%5C%5Cn%5C%5Cn%3Cname%3E:%5C%22%20part,%20so%20we%20don't%20need%20to%20add%20it%5Cn%20%20%7D%20else%20%7B%5Cn%20%20%20%20return%20lastFewMessagesText.trim()%20+%20%5C%22%5C%5Cn%5C%5Cn%5C%22%20+%20getNextTurnName()%20+%20%5C%22:%5C%22;%5Cn%20%20%7D%5Cn%20%20%5CnupdateVisibilityOfReplyButtonsAndSelectors()%20=%3E%5Cn%20%20if(inputEl.value.trim()%20===%20%5C%22%5C%22)%20%7B%5Cn%20%20%20%20sendAsCharacterCtn.style.display%20=%20%5C%22none%5C%22;%5Cn%20%20%20%20autoRespondCtn.style.display%20=%20%5C%22none%5C%22;%5Cn%20%20%20%20quickReplyButtonsCtn.style.display%20=%20%5C%22flex%5C%22;%5Cn%20%20%7D%20else%20%7B%5Cn%20%20%20%20sendAsCharacterCtn.style.display%20=%20%5C%22flex%5C%22;%5Cn%20%20%20%20quickReplyButtonsCtn.style.display%20=%20%5C%22none%5C%22;%5Cn%20%20%20%20if(autoImproveCheckboxEl.checked)%20%7B%5Cn%20%20%20%20%20%20autoRespondCtn.style.display%20=%20%5C%22none%5C%22;%5Cn%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20autoRespondCtn.style.display%20=%20%5C%22flex%5C%22;%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%5Cnasync%20handleSendButtonClick(opts)%20=%3E%5Cn%20%20chatLogsEl.value%20=%20chatLogsEl.value.trim();%5Cn%20%20%5Cn%20%20rateLastMessageBadBtn.disabled%20=%20true;%5Cn%20%20rateLastMessageGoodBtn.disabled%20=%20true;%5Cn%20%20rateLastMessageBadBtn.style.opacity%20=%201;%5Cn%20%20rateLastMessageGoodBtn.style.opacity%20=%201;%5Cn%20%20%5Cn%20%20let%20generatedTextAndThereWereNoErrors%20=%20false;%5Cn%20%20let%20temporarilyRemovedPrefixChatLogsForStreamingRenderPerformance%20=%20null;%5Cn%20%20try%20%7B%5Cn%20%20%20%20chatLogsEl.value%20=%20chatLogsEl.value.replace(/%5C%5Cn+/g,%20%5C%22%5C%5Cn%5C%5Cn%5C%22);%20//%20ensure%20exactly%202%20newlines%20between%20all%20messages,%20and%20no%20newlines%20within%20a%20message%5Cn%20%20%20%20let%20nextMessageDraftOrInstruction%20=%20null;%5Cn%20%20%20%20%5Cn%20%20%20%20//%20if%20the%20input%20box%20contains%20some%20text,%20then%20they%20have%20explicitely%20selected%20a%20character%20to%20reply%20with,%20so%20we%20need%20to%20remove%20any%20'empty'%20messages%20from%20the%20end%20of%20the%20chat%5Cn%20%20%20%20if(inputEl.value.trim()%20!==%20%5C%22%5C%22%20&&%20opts.mode%20===%20%5C%22normal%5C%22)%20%7B%5Cn%20%20%20%20%20%20let%20i%20=%200;%5Cn%20%20%20%20%20%20while(chatLogsEl.value.trim()%20!==%20%5C%22%5C%22%20&&%20lastMessageIsEmpty())%20%7B%5Cn%20%20%20%20%20%20%20%20if(chatLogsEl.value.trim().slice(-1)%20!==%20%5C%22:%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20break;%20//%20just%20an%20extra%20safety%20guard%20to%20prevent%20deleting%20non-empty%20messages%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20chatLogsEl.value%20=%20chatLogsEl.value.split(%5C%22%5C%5Cn%5C%5Cn%5C%22).slice(0,%20-1).join(%5C%22%5C%5Cn%5C%5Cn%5C%22);%5Cn%20%20%20%20%20%20%20%20if(i++%20%3E%2010000)%20return%20alert(%5C%22There%20was%20an%20error%20in%20the%20code.%20Please%20report%20this%20error%20in%20the%20feedback%20box%20with%20error%20code%20'243'.%5C%22);%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D%5Cn%20%20%20%20%5Cn%20%20%20%20window.nextMessageDraftOrInstruction_prevMessage%20=%20null;%5Cn%20%20%20%20%5Cn%20%20%20%20if(opts.mode%20===%20%5C%22normal%5C%22%20%7C%7C%20opts.mode%20===%20%5C%22regen%5C%22)%20%7B%5Cn%20%20%20%20%20%20//%20if%20they're%20in%20auto-improve%20mode,%20then%20inputEl%20actually%20contains%20the%20%5C%22instruction%5C%22%20or%20%5C%22draft%5C%22%20for%20the%20next%20message,%20not%20the%20message%20itself%5Cn%20%20%20%20%20%20if(autoImproveCheckboxEl.checked%20&&%20inputEl.value.trim()%20!==%20%5C%22%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20nextMessageDraftOrInstruction%20=%20inputEl.value.trim();%5Cn%20%20%20%20%20%20%20%20inputEl.value%20=%20%5C%22%5C%22;%5Cn%20%20%20%20%20%20%20%20if(!chatLogsEl.value.endsWith(sendAsCharacterSelectEl.value+%5C%22:%5C%22))%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20chatLogsEl.value%20+=%20'%5C%5Cn%5C%5Cn'+sendAsCharacterSelectEl.value+':';%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20updateVisibilityOfReplyButtonsAndSelectors();%5Cn%20%20%20%20%20%20%20%20window.nextMessageDraftOrInstruction_prevMessage%20=%20nextMessageDraftOrInstruction;%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D%5Cn%20%20%20%20%5Cn%20%20%20%20if(opts.mode%20===%20%5C%22normal%5C%22)%20%7B%5Cn%20%20%20%20%20%20//%20if%20there's%20some%20text%20in%20the%20input%20box,%20we%20add%20that%20text%20to%20the%20chat%20logs%20with%20the%20user%20character's%20name%20at%20the%20start%5Cn%20%20%20%20%20%20if(inputEl.value.trim()%20!==%20%5C%22%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20if(chatLogsEl.value.trim()%20!==%20%5C%22%5C%22)%20chatLogsEl.value%20+=%20%5C%22%5C%5Cn%5C%5Cn%5C%22;%5Cn%20%20%20%20%20%20%20%20chatLogsEl.value%20+=%20(sendAsCharacterSelectEl.value%20%7C%7C%20userName)+%5C%22:%20%5C%22+inputEl.value.trim();%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20chatLogsEl.scrollTop%20=%20chatLogsEl.scrollHeight;%5Cn%20%20%20%20%20%20%20%20inputEl.value%20=%20%5C%22%5C%22;%5Cn%20%20%20%20%20%20%20%20localStorage.input%20=%20%5C%22%5C%22;%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20//%20inputEl%20is%20now%20empty,%20so%20we%20appropriately%20adjust%20visible%20reply%20buttons/selectors:%5Cn%20%20%20%20%20%20%20%20updateVisibilityOfReplyButtonsAndSelectors();%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20if(!autoRespondCheckboxEl.checked)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20return;%20//%20no%20response%20needed%20-%20user%20wants%20to%20e.g.%20manually%20use%20quick%20reply%20buttons%20to%20choose%20responding%20character%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%5Cn%5Cn%20%20%20%20%20%20if(chatLogsEl.value.trim()%20===%20%5C%22%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20chatLogsEl.value%20+=%20getNextTurnName()%20+%20%5C%22:%5C%22;%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20if(!lastMessageIsEmpty())%20%7B%5Cn%20%20%20%20%20%20%20%20chatLogsEl.value%20+=%20%5C%22%5C%5Cn%5C%5Cn%5C%22%20+%20getNextTurnName()%20+%20%5C%22:%5C%22;%20//%20add%20two%20new%20lines%20and%20the%20name%20of%20the%20person%20speaking%20next,%20ready%20for%20the%20response%20that%20the%20AI%20is%20about%20to%20write%20into%20the%20chat%20logs%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D%5Cn%20%20%20%20%5Cn%20%20%20%20chatLogsEl.scrollTop%20=%20chatLogsEl.scrollHeight;%5Cn%20%20%20%20%5Cn%20%20%20%20sendMessageBtn.disabled%20=%20true;%5Cn%20%20%20%20regenMessageBtn.disabled%20=%20true;%5Cn%20%20%20%20deleteLastMessageBtn.disabled%20=%20true;%5Cn%20%20%20%20quickReplyButtonsCtn.querySelectorAll(%5C%22button%5C%22).forEach(el%20=%3E%20el.disabled=true);%5Cn%20%20%20%20continueMessageBtn.style.display%20=%20'none';%5Cn%20%20%20%20undoDeleteLastMessageCtn.style.display%20=%20%5C%22none%5C%22;%5Cn%5Cn%20%20%20%20//%20note:%20if%20this%20%60handleSendButtonClick%60%20function%20is%20being%20called%20by%20the%20regen%20function,%20then%20the%20regen%20function%20will%20re-enable%20these%20as%20needed:%5Cn%20%20%20%20regenPrevButton.disabled%20=%20true;%5Cn%20%20%20%20regenNextButton.disabled%20=%20true;%5Cn%20%20%20%20%5Cn%20%20%20%20let%20gotFirstChunk%20=%20false;%5Cn%20%20%20%20let%20pendingObj%20=%20ai(%7B%5Cn%20%20%20%20%20%20instruction:%20()%20=%3E%20%7B%5Cn%20%20%20%20%20%20%20%20//%20the%20reason%20we%20construct%20this%20with%20a%20function%20rather%20than%20just%20putting%20it%20all%20in%20the%20actual%20%60instruction%60%20list%20is%20kind%20of%20technical%20-%20it's%20because%20we%20don't%20want%20to%20evaluate%20square/curly%20blocks%20that%20happen%20to%20be%20in%20the%20chat%20logs,%20scenario,%20or%20character%20descriptions%5Cn%20%20%20%20%20%20%20%20instruction.nextMessageDraftOrInstruction%20=%20nextMessageDraftOrInstruction;%5Cn%20%20%20%20%20%20%20%20let%20output%20=%20instruction.evaluateItem;%5Cn%20%20%20%20%20%20%20%20let%20botDescription%20=%20botDescriptionEl.value.trim()%20%7C%7C%20%5C%22(Not%20specified.)%5C%22;%5Cn%20%20%20%20%20%20%20%20let%20userDescription%20=%20userDescriptionEl.value.trim()%20%7C%7C%20%5C%22(Not%20specified.)%5C%22;%5Cn%20%20%20%20%20%20%20%20let%20scenario%20=%20scenarioEl.value.trim()%20%7C%7C%20%5C%22(None%20specified.%20Freeform.)%5C%22;%5Cn%20%20%20%20%20%20%20%20//%20for%20the%20chat%20logs,%20we%20leave%20off%20the%20last%205%20messages,%20since%20we'll%20put%20them%20in%20the%20%60startWith%60%20instead%20of%20the%20%60instruction%60%20(I%20think%20this%20might%20make%20the%20AI%20less%20likely%20to%20repeat%20itself%20as%20the%20chat%20gets%20longer,%20since%20if%20the%20most%20recent%20messages%20are%20in%20the%20response,%20then%20it%20might%20be%20able%20to%20more%20easily%20%5C%22see%5C%22%20what%20it%20just%20wrote)%5Cn%20%20%20%20%20%20%20%20let%20chatLogs%20=%20chatLogsEl.value.trim().split(%5C%22%5C%5Cn%5C%5Cn%5C%22).slice(0,%20-5).join(%5C%22%5C%5Cn%5C%5Cn%5C%22).trim()%20%7C%7C%20%5C%22(No%20chat%20messages%20yet.%20This%20is%20the%20beginning%20of%20the%20chat.)%5C%22;%5Cn%20%20%20%20%20%20%20%20output%20=%20output.replace(%5C%22%3C%3C%3CBOT_DESCRIPTION_PLACEHOLDER%3E%3E%3E%5C%22,%20botDescription.replaceAll(%5C%22%7B%7Buser%7D%7D%5C%22,%20userName).replaceAll(%5C%22%7B%7Bchar%7D%7D%5C%22,%20botName));%5Cn%20%20%20%20%20%20%20%20output%20=%20output.replace(%5C%22%3C%3C%3CUSER_DESCRIPTION_PLACEHOLDER%3E%3E%3E%5C%22,%20userDescription.replaceAll(%5C%22%7B%7Buser%7D%7D%5C%22,%20userName).replaceAll(%5C%22%7B%7Bchar%7D%7D%5C%22,%20botName));%5Cn%20%20%20%20%20%20%20%20output%20=%20output.replace(%5C%22%3C%3C%3CSCENARIO_PLACEHOLDER%3E%3E%3E%5C%22,%20scenario);%5Cn%20%20%20%20%20%20%20%20output%20=%20output.replace(%5C%22%3C%3C%3CCHAT_LOGS_PLACEHOLDER%3E%3E%3E%5C%22,%20chatLogs);%5Cn%20%20%20%20%20%20%20%20return%20output;%5Cn%20%20%20%20%20%20%7D,%5Cn%20%20%20%20%20%20startWith:%20()%20=%3E%20%7B%5Cn%20%20%20%20%20%20%20%20let%20continueMode%20=%20opts.mode%20===%20%5C%22continue%5C%22%20%7C%7C%20opts.mode%20===%20%5C%22regen%5C%22;%5Cn%20%20%20%20%20%20%20%20return%20getStarterText(%7BcontinueMode,%20nextMessageDraftOrInstruction%7D);%5Cn%20%20%20%20%20%20%7D,%5Cn%20%20%20%20%20%20stopSequences:%20%5B%5C%22%5C%5Cn%5C%22%5D,%20//%20%3C--%20This%20means%20if%20the%20AI%20generates%20a%20new%20line%20(i.e.%20the%20gap%20between%20messages),%20it'll%20stop.%20So%20it%20ensures%20that%20the%20AI%20only%20generates%20one%20message.%5Cn%20%20%20%20%20%20onChunk:%20(data)%20=%3E%20%7B%5Cn%20%20%20%20%20%20%20%20if(data.isFromStartWith)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20//%20onChunk%20gives%20us%20all%20chunks%20of%20the%20AI's%20response,%20including%20the%20startWith%20text%20that%20we%20specified,%20so%20we%20skip%20that%20text%20-%20we%20only%20want%20to%20output%20the%20stuff%20that%20the%20AI%20actuall%20wrote%20into%20the%20chat%20logs%5Cn%20%20%20%20%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20if(!gotFirstChunk)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20if(chatLogsEl.value.length%20%3E%2050000)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20prevPageScrollTop%20=%20document.scrollingElement.scrollTop;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20temporarilyRemovedPrefixChatLogsForStreamingRenderPerformance%20=%20chatLogsEl.value.slice(0,%20-50000)%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20chatLogsEl.value%20=%20chatLogsEl.value.slice(-50000);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20document.scrollingElement.scrollTop%20=%20prevPageScrollTop;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20gotFirstChunk%20=%20true;%5Cn%20%20%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20%20%20chatLogsEl.value%20+=%20data.textChunk;%20//%20we're%20manually%20adding%20each%20chunk%20of%20generated%20text%20to%20the%20%5C%22chatLogsEl%5C%22%20text%20box,%20rather%20than%20using%20%60outputTo%60,%20since%20%60outputTo%60%20would%20clear%20all%20the%20existing%20text%20and%20only%20add%20the%20*response*,%20whereas%20we%20want%20to%20preserve%20all%20the%20existing%20text,%20and%20just%20add%20the%20response%20to%20the%20end.%20%5Cn%20%20%20%20%20%20%20%20%20%20if(chatLogsEl.scrollTop%20%3E%20(chatLogsEl.scrollHeight%20-%20chatLogsEl.offsetHeight)-30)%20%7B%20//%20%3C--%20if%20the%20text%20box%20is%20already%20scrolled%20near%20the%20end%20of%20the%20text%5Cn%20%20%20%20%20%20%20%20%20%20%20%20chatLogsEl.scrollTop%20=%2099999999;%20//%20scroll%20down%20to%20bottom%20of%20text%20box%20as%20story%20streams%20in%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D,%5Cn%20%20%20%20%7D);%20//%20trigger%20AI%20to%20respond%5Cn%20%20%20%20loaderEl.innerHTML%20=%20pendingObj.loadingIndicatorHtml;%20%5Cn%20%20%20%20%5Cn%20%20%20%20window.lastMessagePendingObj%20=%20pendingObj;%5Cn%5Cn%20%20%20%20setTimeout(()%20=%3E%20%7B%5Cn%20%20%20%20%20%20chatLogsEl.scrollTop%20=%20999999999;%20//%20%3C--%20scroll%20to%20the%20bottom%20of%20the%20chat%20logs%5Cn%20%20%20%20%7D,%2050);%20//%20we%20do%20it%2050ms%20after%20they%20click%20send,%20so%20that%20we%20scroll%20down%20*after*%20the%20character's%20name%20has%20been%20added.%20EDIT:%20wait,%20but%20we%20add%20the%20name%20above?%20I%20think%20this%20is%20old%20code%20-%20probably%20not%20needed%20anymore.%5Cn%5Cn%20%20%20%20let%20data%20=%20await%20pendingObj.onFinishPromise;%5Cn%20%20%20%20if(data.stopReason%20!==%20%5C%22error%5C%22)%20generatedTextAndThereWereNoErrors%20=%20true;%5Cn%20%20%20%20//%20we're%20not%20actually%20using%20this%20data,%20but%20I%20do%20want%20to%20await%20the%20promise%20anyway,%20since%20other%20functions%20currently%20expect%20%60await%20handleSendButtonClick()%60%20to%20resolve%20when%20generation%20is%20finished%5Cn%20%20%7D%20catch(e)%20%7B%5Cn%20%20%20%20console.error(e);%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20if(temporarilyRemovedPrefixChatLogsForStreamingRenderPerformance)%20%7B%5Cn%20%20%20%20//%20page%20scroll%20messes%20up%20when%20we%20add%20prefix%20logs%20back,%20so%20we%20need%20to%20save%20+%20restore:%5Cn%20%20%20%20let%20prevPageScrollTop%20=%20document.scrollingElement.scrollTop;%5Cn%20%20%20%20chatLogsEl.value%20=%20temporarilyRemovedPrefixChatLogsForStreamingRenderPerformance%20+%20chatLogsEl.value;%5Cn%20%20%20%20chatLogsEl.scrollTop%20=%20999999999;%5Cn%20%20%20%20document.scrollingElement.scrollTop%20=%20prevPageScrollTop;%5Cn%20%20%7D%5Cn%5Cn%20%20sendMessageBtn.disabled%20=%20false;%5Cn%20%20regenMessageBtn.disabled%20=%20false;%5Cn%20%20deleteLastMessageBtn.disabled%20=%20false;%5Cn%20%20quickReplyButtonsCtn.querySelectorAll(%5C%22button%5C%22).forEach(el%20=%3E%20el.disabled=false);%5Cn%20%20%5Cn%20%20if(generatedTextAndThereWereNoErrors)%20%7B%5Cn%20%20%20%20rateLastMessageBadBtn.disabled%20=%20false;%5Cn%20%20%20%20rateLastMessageGoodBtn.disabled%20=%20false;%5Cn%20%20%7D%5Cn%5Cn%20%20loaderEl.innerHTML%20=%20%5C%22%5C%22;%20//%20clear%20the%20loading%20indicator%5Cn%20%20let%20pageScrollTop%20=%20document.scrollingElement.scrollTop;%5Cn%20%20chatLogsEl.value%20=%20chatLogsEl.value.trim();%20//%20remove%20newlines/spaces%20from%20start%20and%20end%20of%20chatlog%5Cn%20%20document.scrollingElement.scrollTop%20=%20pageScrollTop;%20//%20otherwise%20chrome's%20%5C%22layout%20shift%20prevention%5C%22%20messes%20with%20the%20page%20scroll%20height%5Cn%20%20localStorage.chatLogs%20=%20chatLogsEl.value;%20//%20save%20chat%20logs%20to%20localStorage%20so%20it's%20still%20there%20even%20if%20the%20page%20is%20reloaded%5Cn%5Cn%20%20chatLogsDeleteBtn.style.display%20=%20'';%5Cn%20%20deleteAndRegenLastMessageCtn.style.display%20=%20'flex';%5Cn%20%20updateCharacterNameViews();%5Cn%5Cn%20%20if(localStorage.sendCount%20===%20undefined%20%7C%7C%20isNaN(Number(localStorage.sendCount)))%20localStorage.sendCount%20=%20%5C%220%5C%22;%5Cn%20%20localStorage.sendCount%20=%20Number(localStorage.sendCount)%20+%201;%5Cn%20%20triggerTipIfNeeded();%5Cn%20%20updateLastMessageButtonsDisplayIfNeeded();%5Cn%5Cn%5Cn//%20async%20copySessionShareLink()%20=%3E%5Cn//%20%20%20if(!botNameEl.value.trim()%20%7C%7C%20!userNameEl.value.trim())%20%7B%5Cn//%20%20%20%20%20alert(%5C%22Please%20add%20at%20least%20the%20character%20names%20before%20creating%20a%20share%20link.%5C%22);%5Cn//%20%20%20%20%20return;%5Cn//%20%20%20%7D%5Cn//%20%20%20shareSessionBtn.textContent%20=%20%5C%22%E2%9C%85%20copied!%5C%22;%5Cn//%20%20%20setTimeout(()%20=%3E%20shareSessionBtn.textContent%20=%20%5C%22%F0%9F%94%97%20share%20this%20chat%5C%22,%201500);%5Cn//%20%20%20let%20shareData%20=%20%7B%5Cn//%20%20%20%20%20aiChat:%20getCurrentChatData(),%5Cn//%20%20%20%7D;%5Cn//%20%20%20navigator.clipboard.writeText(%60https://perchance.org/$%7Bwindow.generatorName%7D#$%7BJSON.stringify(shareData)%7D%60);%5Cn%5CnupdateLastMessageButtonsDisplayIfNeeded()%20=%3E%5Cn%20%20if(localStorage.sendCount%20&&%20Number(localStorage.sendCount)%20%3E%205)%20%7B%5Cn%20%20%20%20//%20rating%20buttons%20only%20get%20shown%20after%20several%20messages%20to%20reduce%20clutter%20for%20newbies.%5Cn%20%20%20%20//%20and%20when%20we%20show%20rating%20buttons,%20we%20reduce%20the%20size%20of%20the%20others%20so%20the%20buttons%20fit%20on%20mobile%20(since%20hopefully%20they%20know%20what%20those%20buttons%20do%20by%20now,%20so%20they%20don't%20need%20the%20%5C%22full%5C%22%20label)%5Cn%20%20%20%20rateLastMessageCtn.style.display%20=%20%5C%22%5C%22;%20%5Cn%20%20%20%20askForRatingsNoticeEl.style.display%20=%20%5C%22%5C%22;%20%5Cn%20%20%20%20deleteLastMessageBtn.textContent%20=%20deleteLastMessageBtn.dataset.shortContent;%5Cn%20%20%20%20regenMessageBtn.textContent%20=%20regenMessageBtn.dataset.shortContent;%5Cn%20%20%7D%5Cn%5Cnasync%20rateLastMessage(rating)%20=%3E%5Cn%20%20if(!window.lastMessagePendingObj)%20return;%5Cn%20%20%5Cn%20%20if(!localStorage.knowsHowRatingsWork)%20%7B%5Cn%20%20%20%20if(!confirm(%5C%22Your%20ratings%20help%20improve%20Perchance's%20AI%20plugin,%20which%20powers%20this%20chat.%20Please%20do%20not%20submit%20ratings%20if%20your%20chat%20includes%20personal%20info.%5C%5Cn%5C%5CnContinue?%5C%22))%20return;%5Cn%20%20%20%20localStorage.knowsHowRatingsWork%20=%20%5C%221%5C%22;%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20let%20score%20=%20rating===%5C%22good%5C%22%20?%201%20:%200;%5Cn%20%20rateLastMessageBadBtn.disabled%20=%20true;%5Cn%20%20rateLastMessageGoodBtn.disabled%20=%20true;%5Cn%20%20if(rating%20===%20%5C%22good%5C%22)%20%7B%5Cn%20%20%20%20rateLastMessageBadBtn.style.opacity%20=%200.2;%5Cn%20%20%7D%20else%20%7B%5Cn%20%20%20%20rateLastMessageGoodBtn.style.opacity%20=%200.2;%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20if(!window.recentRatingReasonCounts)%20window.recentRatingReasonCounts%20=%20%7B%7D;%5Cn%20%20let%20reasonCountEntries%20=%20Object.entries(window.recentRatingReasonCounts).sort((a,b)%20=%3E%20b%5B1%5D-a%5B1%5D);%5Cn%20%20if(reasonCountEntries.length%20%3E%2010)%20reasonCountEntries%20=%20reasonCountEntries.slice(0,%2010);%5Cn%20%20window.recentRatingReasonCounts%20=%20Object.fromEntries(reasonCountEntries);%5Cn%20%20recentRatingReasonsDataList.innerHTML%20=%20%20reasonCountEntries.map(e%20=%3E%20%60%3Coption%20value=%5C%22$%7Be%5B0%5D.replace(/%3C/g,%20%5C%22&lt;%5C%22).replace(/%5C%22/g,%20%5C%22&quot;%5C%22)%7D%5C%22%3E%3C/option%3E%60).join(%5C%22%5C%22);%5Cn%20%20%5Cn%20%20let%20reasonResolver;%5Cn%20%20let%20reasonFinishPromise%20=%20new%20Promise(r%20=%3E%20reasonResolver=r);%5Cn%20%20ratingReasonEl.value%20=%20%5C%22%5C%22;%5Cn%20%20ratingReasonCtn.style.display%20=%20%5C%22%5C%22;%5Cn%20%20ratingReasonEl.focus();%5Cn%20%20await%20new%20Promise(r%20=%3E%20setTimeout(r,%20100));%5Cn%20%20%5Cn%20%20//%20if%20they%20click%20anywhere%20other%20than%20the%20reason%20input,%20then%20we%20resolve%20with%20the%20current%20contents%20of%20the%20reason%20box%5Cn%20%20function%20windowClickHandler(event)%20%7B%5Cn%20%20%20%20if(!ratingReasonCtn.contains(event.target))%20%7B%5Cn%20%20%20%20%20%20reasonResolver(ratingReasonEl.value);%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%20%20window.addEventListener(%5C%22click%5C%22,%20windowClickHandler);%5Cn%20%20%5Cn%20%20//%20if%20they%20press%20enter,%20then%20we%20resolve%20too%5Cn%20%20function%20enterKeydownHandler(event)%20%7B%5Cn%20%20%20%20if(event.key%20===%20'Enter')%20%7B%5Cn%20%20%20%20%20%20reasonResolver(ratingReasonEl.value);%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%20%20ratingReasonEl.addEventListener(%5C%22keydown%5C%22,%20enterKeydownHandler);%5Cn%20%20%5Cn%20%20let%20reason%20=%20await%20reasonFinishPromise;%5Cn%20%20if(reason.length%20%3C%20100)%20window.recentRatingReasonCounts%5Breason%5D%20=%20(window.recentRatingReasonCounts%5Breason%5D%20%7C%7C%200)%20+%201;%5Cn%20%20%5Cn%20%20ratingReasonCtn.style.display%20=%20'none';%5Cn%20%20window.removeEventListener(%5C%22click%5C%22,%20windowClickHandler);%5Cn%20%20ratingReasonEl.removeEventListener(%5C%22keydown%5C%22,%20enterKeydownHandler);%5Cn%20%20window.lastMessagePendingObj.submitUserRating(%7Bscore,%20reason%7D);%5Cn%20%20%5Cn%20%20%5Cn%5CnsaveChatDataToUsersDevice()%20=%3E%20%5Cn%20%20let%20data%20=%20getCurrentChatData();%5Cn%20%20let%20filename%20=%20prompt(%5C%22Choose%20a%20filename:%5C%22,%20(data.userName+%5C%22-%5C%22+data.botName).replace(/%5B%5Ea-zA-Z0-9%5C%5C-_%5D/g,%20%5C%22%5C%22));%5Cn%20%20if(filename%20===%20null)%20return;%5Cn%20%20filename%20+=%20%5C%22.ai-chat.json%5C%22;%5Cn%20%20let%20blob%20=%20new%20Blob(%5BJSON.stringify(data,%20null,%202)%5D,%20%7B%20type:%20'application/json'%20%7D);%5Cn%20%20let%20url%20=%20URL.createObjectURL(blob);%5Cn%20%20let%20a%20=%20document.createElement('a');%5Cn%20%20a.href%20=%20url;%5Cn%20%20a.download%20=%20filename;%5Cn%20%20a.click();%5Cn%20%20URL.revokeObjectURL(url);%5Cn%20%20%5Cnasync%20loadChatDataFromUsersDevice()%20=%3E%5Cn%20%20return%20new%20Promise((resolve,%20reject)%20=%3E%20%7B%5Cn%20%20%20%20let%20input%20=%20document.createElement('input');%5Cn%20%20%20%20input.type%20=%20'file';%5Cn%20%20%20%20input.accept%20=%20'application/json,%20text/json,%20text/plain,%20application/JSON,%20.json';%5Cn%5Cn%20%20%20%20input.onchange%20=%20async%20(event)%20=%3E%20%7B%5Cn%20%20%20%20%20%20let%20file%20=%20event.target.files%5B0%5D;%5Cn%20%20%20%20%20%20if%20(file)%20%7B%5Cn%20%20%20%20%20%20%20%20try%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20let%20content%20=%20await%20file.text();%5Cn%20%20%20%20%20%20%20%20%20%20let%20data%20=%20JSON.parse(content);%5Cn%20%20%20%20%20%20%20%20%20%20if(data.format%20===%20%5C%22perchance-ai-chat-v1%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20if((botDescriptionEl.value+userDescriptionEl.value+scenarioEl.value+chatLogsEl.value+writingInstructionsEl.value).trim()%20!==%20%5C%22%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20confirmed%20=%20confirm(%5C%22Loading%20this%20data%20will%20overwrite%20your%20current%20chat.%20Continue?%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(!confirmed)%20return;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20loadDataIntoTextAreasAndLocalStorage(data);%5Cn%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20alert(%5C%22Unknown%20save%20file%20format.%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D%20catch%20(error)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20alert(%5C%22There%20was%20an%20error%20while%20loading%20that%20chat%20file.%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20reject(error);%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D;%5Cn%5Cn%20%20%20%20input.click();%5Cn%20%20%7D);%5Cn%5CnloadDataIntoTextAreasAndLocalStorage(data)%20=%3E%5Cn%20%20//%20put%20data%20in%20input%20boxes:%5Cn%20%20botNameEl.value%20=%20data.botName;%5Cn%20%20userNameEl.value%20=%20data.userName;%5Cn%20%20botDescriptionEl.value%20=%20data.botDescription;%5Cn%20%20userDescriptionEl.value%20=%20data.userDescription;%5Cn%20%20scenarioEl.value%20=%20data.scenario;%5Cn%20%20chatLogsEl.value%20=%20data.chatLogs;%5Cn%20%20writingInstructionsEl.value%20=%20data.writingInstructions;%5Cn%20%20//%20put%20data%20in%20localstorage:%5Cn%20%20localStorage.botName%20=%20data.botName;%5Cn%20%20localStorage.userName%20=%20data.userName;%5Cn%20%20localStorage.botDescription%20=%20data.botDescription;%5Cn%20%20localStorage.userDescription%20=%20data.userDescription;%5Cn%20%20localStorage.scenario%20=%20data.scenario;%5Cn%20%20localStorage.chatLogs%20=%20data.chatLogs;%5Cn%20%20localStorage.writingInstructions%20=%20data.writingInstructions;%5Cn%5Cnasync%20generateShareLinkForChat()%20=%3E%20%5Cn%20%20if(!window.CompressionStream)%20%7B%5Cn%20%20%20%20alert(%5C%22Share%20links%20use%20a%20feature%20that's%20only%20available%20in%20modern%20browsers.%20Please%20upgrade%20your%20browser%20to%20the%20latest%20version%20to%20use%20this%20feature.%5C%22);%5Cn%20%20%20%20return;%5Cn%20%20%7D%5Cn%20%20if((botDescriptionEl.value+userDescriptionEl.value+scenarioEl.value).trim()%20===%20%5C%22%5C%22)%20%7B%5Cn%20%20%20%20alert(%5C%22You%20need%20to%20add%20character%20descriptions%20and%20a%20scenario%20before%20sharing.%5C%22);%5Cn%20%20%20%20return;%5Cn%20%20%7D%5Cn%20%20shareLinkCtn.style.display%20=%20%5C%22none%5C%22;%5Cn%20%20%5Cn%20%20shareChatBtn.disabled%20=%20true;%5Cn%20%20shareChatBtn.textContent%20=%20%5C%22%E2%8F%B3%20uploading%20current%20chat%20data...%5C%22;%5Cn%20%20%5Cn%20%20let%20chatDataJson%20=%20JSON.stringify(getCurrentChatData());%5Cn%20%20%5Cn%20%20//%20convert%20json%20text%20to%20blob:%5Cn%20%20chatDataJson%20=%20chatDataJson.replace(/#/g,%20%5C%22%2523%5C%22);%20//%20since%20hash%20is%20a%20special%20character%20in%20dataurls%20(like%20normal%20URLs)%5Cn%20%20let%20blob%20=%20await%20fetch(%5C%22data:text/plain;charset=utf-8,%5C%22+chatDataJson).then(res%20=%3E%20res.blob());%5Cn%20%20%5Cn%20%20//%20compress%20blob:%5Cn%20%20let%20compressedBlob%20=%20await%20compressBlobWithGzip(blob);%5Cn%20%20%5Cn%20%20let%20%7B%20url,%20size,%20error%20%7D%20=%20await%20upload(compressedBlob);%5Cn%20%20if(error)%20%7B%5Cn%20%20%20%20shareChatLinkInputEl.value%20=%20%60error:%20$%7Berror%7D%60;%5Cn%20%20%7D%20else%20%7B%5Cn%20%20%20%20shareChatLinkInputEl.value%20=%20%60https://perchance.org/$%7Bwindow.generatorName%7D#data=%60+url.replace(%5C%22https://user-uploads.perchance.org/file/%5C%22,%20%5C%22uup1:%5C%22);%5Cn%20%20%7D%5Cn%20%20shareLinkCtn.style.display%20=%20%5C%22%5C%22;%5Cn%20%20shareChatBtn.textContent%20=%20%5C%22%F0%9F%94%97%20share%20this%20chat%5C%22;%5Cn%20%20shareChatBtn.disabled%20=%20false;%5Cn%20%20shareChatBtn.style.display%20=%20%5C%22none%5C%22;%5Cn%5Cnasync%20compressBlobWithGzip(blob)%20=%3E%5Cn%20%20const%20cs%20=%20new%20CompressionStream('gzip');%5Cn%20%20const%20compressedStream%20=%20blob.stream().pipeThrough(cs);%5Cn%20%20let%20outputBlob%20=%20await%20new%20Response(compressedStream).blob();%5Cn%20%20return%20new%20Blob(%5BoutputBlob%5D,%20%7B%20type:%20%5C%22application/gzip%5C%22%20%7D);%20//%20%3C--%20to%20add%20the%20correct%20mime%20type%5Cn%20%5Cnasync%20loadDataFromUrlHash()%20=%3E%20%5Cn%20%20let%20success%20=%20false;%5Cn%20%20if(!window.DecompressionStream)%20%7B%5Cn%20%20%20%20alert(%5C%22Character%20share%20links%20use%20a%20browser%20feature%20that's%20only%20available%20in%20modern%20browsers.%20Please%20upgrade%20your%20browser%20to%20the%20latest%20version%20to%20allow%20for%20loading%20data%20from%20character%20share%20links.%5C%22);%5Cn%20%20%20%20return%20%7Bsuccess,%20error:%5C%22browser_compat%5C%22%7D;%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20let%20loadingModal%20=%20document.createElement('div');%5Cn%20%20loadingModal.innerHTML%20=%20%60%3Cdiv%20style=%5C%22position:%20fixed;%20top:%200;%20left:%200;%20width:%20100%25;%20height:%20100%25;%20background-color:%20rgba(0,%200,%200,%200.5);%20z-index:%209999;%20display:%20flex;%20justify-content:%20center;%20align-items:%20center;%5C%22%3E%5Cn%20%20%20%20%3Cdiv%20style=%5C%22padding:%2020px;%20background-color:%20var(--box-color);%20border-radius:%208px;%5C%22%3E%5Cn%20%20%20%20%20%20%E2%8F%B3%20loading%20chat%20data...%5Cn%20%20%20%20%3C/div%3E%5Cn%20%20%3C/div%3E%60;%5Cn%20%20loadingModal%20=%20loadingModal.firstElementChild;%5Cn%20%20document.body.append(loadingModal);%5Cn%20%20%5Cn%20%20try%20%7B%5Cn%20%20%20%20let%20hashText%20=%20window.location.hash.slice(1);%5Cn%20%20%20%20if(!hashText.startsWith(%5C%22data=%5C%22))%20%7B%5Cn%20%20%20%20%20%20throw%20new%20Error(%5C%22Invalid%20share%20URL.%5C%22);%5Cn%20%20%20%20%7D%5Cn%20%20%20%20let%20fileUrl%20=%20hashText.replace(/%5Edata=/,%20%5C%22%5C%22);%5Cn%20%20%20%20if(fileUrl.startsWith(%5C%22uup1:%5C%22))%20%7B%5Cn%20%20%20%20%20%20fileUrl%20=%20fileUrl.replace(%5C%22uup1:%5C%22,%20%5C%22https://user-uploads.perchance.org/file/%5C%22);%5Cn%20%20%20%20%7D%5Cn%20%20%20%20let%20fetchOptions%20=%20%7B%7D;%5Cn%20%20%20%20if(window.AbortSignal%20&&%20AbortSignal.timeout)%20fetchOptions.signal%20=%20AbortSignal.timeout(10000);%5Cn%20%20%20%20let%20blob%20=%20await%20fetch(fileUrl,%20fetchOptions).then(res%20=%3E%20res.blob());%5Cn%20%20%20%20let%20text;%5Cn%20%20%20%20if(fileUrl.endsWith(%5C%22.gz%5C%22))%20%7B%5Cn%20%20%20%20%20%20let%20decompressedBlob%20=%20await%20decompressBlobWithGzip(blob);%5Cn%20%20%20%20%20%20text%20=%20await%20decompressedBlob.text();%5Cn%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20text%20=%20await%20blob.text();%5Cn%20%20%20%20%7D%5Cn%20%20%20%20let%20data%20=%20JSON.parse(text);%5Cn%20%20%20%20if(data.format%20===%20%5C%22perchance-ai-chat-v1%5C%22)%20%7B%5Cn%20%20%20%20%20%20if((%20(localStorage.botDescription%7C%7C%5C%22%5C%22)%20+%20(localStorage.userDescription%7C%7C%5C%22%5C%22)%20+%20(localStorage.scenario%7C%7C%5C%22%5C%22)%20+%20(localStorage.chatLogs%7C%7C%5C%22%5C%22)%20+%20(localStorage.writingInstructions%7C%7C%5C%22%5C%22)%20).trim()%20!==%20%5C%22%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20let%20confirmed%20=%20confirm(%5C%22%F0%9D%97%9B%F0%9D%97%B2%F0%9D%97%AE%F0%9D%97%B1%F0%9D%98%80%20%F0%9D%98%82%F0%9D%97%BD:%20You're%20loading%20a%20chat%20share%20link.%20This%20will%20overwrite%20your%20existing%20chat.%20%F0%9D%97%96%F0%9D%97%BC%F0%9D%97%BB%F0%9D%98%81%F0%9D%97%B6%F0%9D%97%BB%F0%9D%98%82%F0%9D%97%B2?%5C%5Cn%5C%5Cn(Note:%20You%20can%20click%20cancel%20and%20then%20load%20the%20share%20link%20in%20your%20browser's%20incognito/private%20mode%20to%20avoid%20overwriting%20your%20current%20chat,%20or%20just%20save%20your%20existing%20chat%20first.)%5C%22);%5Cn%20%20%20%20%20%20%20%20if(!confirmed)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20loadingModal.remove();%5Cn%20%20%20%20%20%20%20%20%20%20return%20%7Bsuccess,%20error:%5C%22loading_cancelled_by_user%5C%22%7D;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20loadDataIntoTextAreasAndLocalStorage(data);%5Cn%20%20%20%20%20%20success%20=%20true;%5Cn%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20alert(%5C%22Unknown%20chat%20data%20format.%5C%22);%5Cn%20%20%20%20%7D%5Cn%20%20%7D%20catch(e)%20%7B%5Cn%20%20%20%20alert(%60Failed%20to%20load%20chat%20data:%20$%7Be.message%7D%60);%5Cn%20%20%20%20console.error(e);%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20loadingModal.remove();%5Cn%20%20return%20%7Bsuccess%7D;%5Cn%20%20%5Cnasync%20decompressBlobWithGzip(blob)%20=%3E%5Cn%20%20const%20ds%20=%20new%20DecompressionStream(%5C%22gzip%5C%22);%5Cn%20%20const%20decompressedStream%20=%20blob.stream().pipeThrough(ds);%5Cn%20%20return%20await%20new%20Response(decompressedStream).blob();%5Cn%5CngetCurrentChatData()%20=%3E%5Cn%20%20return%20%7B%5Cn%20%20%20%20format:%20%5C%22perchance-ai-chat-v1%5C%22,%5Cn%20%20%20%20botName:%20botNameEl.value.trim(),%5Cn%20%20%20%20userName:%20userNameEl.value.trim(),%5Cn%20%20%20%20botDescription:%20botDescriptionEl.value.trim(),%5Cn%20%20%20%20userDescription:%20userDescriptionEl.value.trim(),%5Cn%20%20%20%20scenario:%20scenarioEl.value.trim(),%5Cn%20%20%20%20chatLogs:%20chatLogsEl.value.trim(),%5Cn%20%20%20%20writingInstructions:%20writingInstructionsEl.value.trim(),%5Cn%20%20%7D;%5Cn%5CndeleteLastMessage()%20=%3E%5Cn%20%20let%20messages%20=%20chatLogsEl.value.trim().split('%5C%5Cn%5C%5Cn');%5Cn%20%20chatLogsEl.value%20=%20messages.slice(0,%20-1).join('%5C%5Cn%5C%5Cn');%5Cn%20%20window.lastMessageDeleted%20=%20messages.at(-1);%5Cn%20%20undoDeleteLastMessageCtn.style.display%20=%20%5C%22%5C%22;%5Cn%20%20clearTimeout(window.hideUndoDeleteLastMessageCtnTimeout);%5Cn%20%20window.hideUndoDeleteLastMessageCtnTimeout%20=%20setTimeout(()%20=%3E%20%7B%5Cn%20%20%20%20undoDeleteLastMessageCtn.style.display%20=%20%5C%22none%5C%22;%5Cn%20%20%7D,%204000);%5Cn%20%20updateDeleteButtonVisibility();%5Cn%20%20regenPrevButton.disabled%20=%20true;%5Cn%20%20regenNextButton.disabled%20=%20true;%5Cn%20%20window.nextMessageDraftOrInstruction_prevMessage%20=%20null;%5Cn%20%20%5CnundoDeleteLastMessage()%20=%3E%5Cn%20%20chatLogsEl.value%20+=%20'%5C%5Cn%5C%5Cn'+window.lastMessageDeleted;%5Cn%20%20undoDeleteLastMessageCtn.style.display%20=%20'none';%5Cn%20%20updateRegenPrevNextButtonVisibility();%5Cn%5CnsimpleHash(str)%20=%3E%5Cn%20%20let%20sum%20=%200;%5Cn%20%20for(let%20i%20=%200;%20i%20%3C%20str.length;%20i++)%20%7B%5Cn%20%20%20%20sum%20=%20Math.imul(31,%20sum)%20+%20str%5Bi%5D.charCodeAt(0)%20%7C%200;%5Cn%20%20%7D%5Cn%20%20return%20sum;%5Cn%20%20%5CnupdateRegenPrevNextButtonVisibility()%20=%3E%5Cn%20%20//%20note%20that%20this%20will%20clear%20%60window.currentRegenAlternatives%60%20if%20current%20context%20doesn't%20match%20its%20associated%20%60window.currentRegenContextHash%60%5Cn%20%20regenPrevButton.disabled%20=%20true;%5Cn%20%20regenNextButton.disabled%20=%20true;%5Cn%20%20let%20messages%20=%20chatLogsEl.value.trim().split('%5C%5Cn%5C%5Cn');%5Cn%20%20let%20currentLastMessage%20=%20messages.at(-1);%5Cn%20%20let%20currentContextMessagesText%20=%20messages.slice(0,%20-1).join('%5C%5Cn%5C%5Cn');%5Cn%20%20let%20currentRegenContextHash%20=%20simpleHash(currentContextMessagesText);%5Cn%20%20if(currentRegenContextHash%20!==%20window.currentRegenContextHash)%20%7B%5Cn%20%20%20%20window.currentRegenAlternatives%20=%20%5BcurrentLastMessage%5D;%5Cn%20%20%20%20window.currentRegenContextHash%20=%20currentRegenContextHash;%5Cn%20%20%7D%20else%20%7B%5Cn%20%20%20%20let%20currentLastMessageRegenIndex%20=%20window.currentRegenAlternatives.findIndex(m%20=%3E%20m%20===%20currentLastMessage);%5Cn%20%20%20%20if(currentLastMessageRegenIndex%20===%20-1)%20%7B%5Cn%20%20%20%20%20%20console.error(%5C%22this%20shouldn't%20happen?%20because%20the%20hash%20matched,%20so%20it%20should%20at%20least%20have%20the%20current%20message%20in%20the%20window.currentRegenAlternatives%20array%5C%22);%5Cn%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20if(currentLastMessageRegenIndex%20%3E%200)%20regenPrevButton.disabled%20=%20false;%5Cn%20%20%20%20%20%20if(currentLastMessageRegenIndex%20%3C%20window.currentRegenAlternatives.length-1)%20regenNextButton.disabled%20=%20false;%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%5Cnasync%20regenLastMessage()%20=%3E%5Cn%20%20regenMessageBtn.disabled%20=%20true;%5Cn%20%20if(window.nextMessageDraftOrInstruction_prevMessage%20&&%20inputEl.value.trim()%20===%20%5C%22%5C%22)%20%7B%5Cn%20%20%20%20inputEl.value%20=%20window.nextMessageDraftOrInstruction_prevMessage;%5Cn%20%20%7D%5Cn%20%20let%20messages%20=%20chatLogsEl.value.trim().split('%5C%5Cn%5C%5Cn');%5Cn%20%20let%20currentLastMessage%20=%20messages.at(-1);%5Cn%20%20let%20currentContextMessagesText%20=%20messages.slice(0,%20-1).join('%5C%5Cn%5C%5Cn');%5Cn%20%20let%20currentRegenContextHash%20=%20simpleHash(currentContextMessagesText);%5Cn%20%20if(currentRegenContextHash%20!==%20window.currentRegenContextHash)%20%7B%5Cn%20%20%20%20window.currentRegenAlternatives%20=%20%5BcurrentLastMessage%5D;%5Cn%20%20%20%20window.currentRegenContextHash%20=%20currentRegenContextHash;%5Cn%20%20%7D%5Cn%20%20let%20%7Bname,%20content%7D%20=%20getLastMessage();%5Cn%20%20chatLogsEl.value%20=%20currentContextMessagesText;%5Cn%20%20chatLogsEl.value%20+=%20%5C%22%5C%5Cn%5C%5Cn%5C%22%20+%20%20name%20+%20%5C%22:%5C%22;%5Cn%20%20await%20handleSendButtonClick(%7Bmode:%5C%22regen%5C%22%7D);%5Cn%20%20%7B%5Cn%20%20%20%20let%20%7Bname,%20content%7D%20=%20getLastMessage();%5Cn%20%20%20%20window.currentRegenAlternatives.push(%60$%7Bname%7D:%20$%7Bcontent%7D%60);%5Cn%20%20%7D%5Cn%20%20regenPrevButton.disabled%20=%20false;%5Cn%20%20regenNextButton.disabled%20=%20true;%5Cn%20%20regenMessageBtn.disabled%20=%20false;%5Cn%20%20%5CnprevRegenMessage()%20=%3E%5Cn%20%20let%20messages%20=%20chatLogsEl.value.trim().split('%5C%5Cn%5C%5Cn');%5Cn%20%20let%20currentLastMessage%20=%20messages.at(-1);%5Cn%20%20let%20currentLastMessageRegenIndex%20=%20window.currentRegenAlternatives.findIndex(m%20=%3E%20m%20===%20currentLastMessage);%5Cn%20%20if(currentLastMessageRegenIndex%20===%200)%20%7B%5Cn%20%20%20%20console.error(%5C%22tried%20to%20go%20to%20prev%20index%20when%20it%20was%20already%20zero%5C%22);%5Cn%20%20%20%20return;%5Cn%20%20%7D%5Cn%20%20window.currentRegenAlternatives%5Cn%20%20chatLogsEl.value%20=%20messages.slice(0,%20-1).join('%5C%5Cn%5C%5Cn')%20+%20%5C%22%5C%5Cn%5C%5Cn%5C%22%20+%20window.currentRegenAlternatives%5BcurrentLastMessageRegenIndex-1%5D;%5Cn%20%20if(currentLastMessageRegenIndex-1%20===%200)%20%7B%5Cn%20%20%20%20regenPrevButton.disabled%20=%20true;%5Cn%20%20%7D%5Cn%20%20regenNextButton.disabled%20=%20false;%5Cn%20%20%5CnnextRegenMessage()%20=%3E%5Cn%20%20let%20messages%20=%20chatLogsEl.value.trim().split('%5C%5Cn%5C%5Cn');%5Cn%20%20let%20currentLastMessage%20=%20messages.at(-1);%5Cn%20%20let%20currentLastMessageRegenIndex%20=%20window.currentRegenAlternatives.findIndex(m%20=%3E%20m%20===%20currentLastMessage);%5Cn%20%20if(currentLastMessageRegenIndex%20===%20window.currentRegenAlternatives.length-1)%20%7B%5Cn%20%20%20%20console.error(%5C%22tried%20to%20go%20to%20next%20index%20when%20it%20was%20already%20max%5C%22);%5Cn%20%20%20%20return;%5Cn%20%20%7D%5Cn%20%20window.currentRegenAlternatives%5Cn%20%20chatLogsEl.value%20=%20messages.slice(0,%20-1).join('%5C%5Cn%5C%5Cn')%20+%20%5C%22%5C%5Cn%5C%5Cn%5C%22%20+%20window.currentRegenAlternatives%5BcurrentLastMessageRegenIndex+1%5D;%5Cn%20%20if(currentLastMessageRegenIndex+1%20===%20window.currentRegenAlternatives.length-1)%20%7B%5Cn%20%20%20%20regenNextButton.disabled%20=%20true;%5Cn%20%20%7D%5Cn%20%20regenPrevButton.disabled%20=%20false;%5Cn%20%20%5CnundoRegenLastMessage()%20=%3E%5Cn%20%20if(!window.lastMessageDeletedForRegen)%20%7B%5Cn%20%20%20%20console.error(%5C%22Tried%20to%20undo%20regen%20when%20we%20had%20already%20undone%20it?%5C%22)%5Cn%20%20%20%20return;%5Cn%20%20%7D%5Cn%20%20let%20messages%20=%20chatLogsEl.value.trim().split('%5C%5Cn%5C%5Cn');%5Cn%20%20window.lastMessageDeletedForRegen%20=%20null;%5Cn%20%20chatLogsEl.value%20=%20messages.slice(0,%20-1).join('%5C%5Cn%5C%5Cn');%5Cn%20%20chatLogsEl.value%20+=%20'%5C%5Cn%5C%5Cn'+window.lastMessageDeletedForRegen;%5Cn%20%20undoRegenMessageCtn.style.display%20=%20'none';%5Cn%5CnloadChatDataFromLocalStorage()%20=%3E%5Cn%20%20//%20Notice%20that%20we%20have%20oninput=%5C%22localStorage.blah=this.value%5C%22%20on%20the%20above%20input%20boxes.%5Cn%20%20//%20That%20saves%20their%20value%20to%20localStorage%20whenever%20they%20are%20changed.%5Cn%20%20//%20So%20during%20the%20initial%20page%20load,%20we%20load%20those%20values%20from%20localStorage%20if%20they%20exist.%5Cn%20%20//%20NOTE:%20You%20could%20simply%20use%20%60perchance.org/remember-plugin%60%20like%20%60%5Bremember(root,%20%5C%22@inputs%5C%22)%5D%60%20rather%20than%20this%20big%20mess.%5Cn%20%20if(localStorage.userName)%20userNameEl.value%20=%20localStorage.userName;%5Cn%20%20if(localStorage.botName)%20botNameEl.value%20=%20localStorage.botName;%5Cn%20%20if(localStorage.botDescription)%20botDescriptionEl.value%20=%20localStorage.botDescription;%5Cn%20%20if(localStorage.userDescription)%20userDescriptionEl.value%20=%20localStorage.userDescription;%5Cn%20%20if(localStorage.scenario)%20scenarioEl.value%20=%20localStorage.scenario;%5Cn%20%20if(localStorage.chatLogs)%20chatLogsEl.value%20=%20localStorage.chatLogs;%5Cn%20%20if(localStorage.writingInstructions)%20writingInstructionsEl.value%20=%20localStorage.writingInstructions;%5Cn%20%20if(localStorage.input)%20inputEl.value%20=%20localStorage.input;%5Cn%5CntriggerTipIfNeeded()%20=%3E%5Cn%20%20if(!localStorage.tipsSeen)%20localStorage.tipsSeen%20=%20%5C%22%5C%22;%5Cn%20%20//%20can%20add%20tip%20based%20on%20e.g.%20text%20that%20is%20at%20the%20end%20of%20the%20chat%20logs,%20or%20whatever%20you%20want.%5Cn%20%20//%20here%20I'm%20just%20using%20sendCount%20as%20a%20simple%20way%20to%20add%20%5C%22introduction%5C%22%20tips%20as%20they%20go.%5Cn%20%20let%20sendCount%20=%20Number(localStorage.sendCount);%5Cn%20%20%7B%5Cn%20%20%20%20let%20tipName%20=%20%5C%22editInitialMessages1%5C%22;%5Cn%20%20%20%20if(sendCount%20===%205%20&&%20!localStorage.tipsSeen.includes(%60%7C$%7BtipName%7D%7C%60))%20%7B%5Cn%20%20%20%20%20%20tipMessageEl.innerHTML%20=%20%60Tip:%20A%20character's%20first%20few%20messages%20will%20heavily%20influence%20the%20way%20that%20character%20talks%20for%20the%20rest%20of%20the%20conversation.%20If%20the%20character%20isn't%20talking%20in%20the%20style%20you%20want,%20be%20sure%20to%20click%20the%20message%20and%20edit%20it%20to%20the%20desired%20style.%60;%5Cn%20%20%20%20%20%20tipEl.style.display%20=%20%5C%22%5C%22;%5Cn%20%20%20%20%20%20localStorage.tipsSeen%20+=%20%60%7C$%7BtipName%7D%7C%60;%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%20%20%7B%5Cn%20%20%20%20let%20tipName%20=%20%5C%22repetition1%5C%22;%5Cn%20%20%20%20if(sendCount%20===%2040%20&&%20!localStorage.tipsSeen.includes(%60%7C$%7BtipName%7D%7C%60))%20%7B%5Cn%20%20%20%20%20%20tipMessageEl.innerHTML%20=%20%60Tip:%20If%20the%20AI%20%3Cb%3Erepeats%20itself%3C/b%3E,%20you%20should%20click%20the%20message%20and%20edit%20it%20to%20remove%20the%20repetition!%20Otherwise%20it'll%20be%20more%20likely%20to%20repeat%20messages%20in%20the%20future.%20You%20can%20edit%20any%20message%20by%20simply%20clicking%20on%20it.%20And,%20in%20general,%20if%20you%20let%20the%20AI%20write%20badly,%20its%20quality%20will%20become%20worse%20as%20the%20chat%20goes%20on,%20so%20%3Cb%3Ealways%20edit%20or%20delete%20the%20messages%20that%20you%20don't%20like%3C/b%3E.%60;%5Cn%20%20%20%20%20%20tipEl.style.display%20=%20%5C%22%5C%22;%5Cn%20%20%20%20%20%20localStorage.tipsSeen%20+=%20%60%7C$%7BtipName%7D%7C%60;%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%5Cn%5CngetRecentCharacterNames()%20=%3E%5Cn%20%20let%20recentMessages%20=%20chatLogsEl.value.trim().split(%5C%22%5C%5Cn%5C%5Cn%5C%22).slice(-300).filter(m%20=%3E%20m.trim());%5Cn%20%20let%20recentNames%20=%20recentMessages.filter(m%20=%3E%20m.includes(%5C%22:%5C%22)).map(m%20=%3E%20m.trim().split(%5C%22:%5C%22)%5B0%5D.trim());%5Cn%20%20recentNames.push(botName.evaluateItem);%5Cn%20%20recentNames.push(userName.evaluateItem);%5Cn%20%20recentNames.push(%5C%22Narrator%5C%22);%5Cn%20%20recentNames%20=%20recentNames.filter(n%20=%3E%20n.length%20%3C%2050);%20//%20in%20case%20of%20e.g.%20a%20manually-added%20paragraph%20of%20writing%20between%20messages%20(i.e.%20that%20doesn't%20have%20a%20name%20at%20the%20start,%20but%20happens%20to%20have%20a%20colon)%5Cn%20%20//%20let%20uniqueNames%20=%20Array.from(new%20Set(recentNames));%5Cn%20%20//%20let%20uniqueNames%20=%20Object.entries(nameHist).sort((a,b)%20=%3E%20b%5B1%5D-a%5B1%5D).map(e%20=%3E%20e%5B0%5D);%5Cn%20%20let%20nameHist%20=%20recentNames.reduce((a,v)%20=%3E%20(a%5Bv%5D=(a%5Bv%5D%7C%7C0)+1,%20a),%20%7B%7D);%5Cn%20%20//%20sort%20them%20by%20number%20first,%20and%20then%20if%20their%20number%20is%20within%2010%20of%20another%20(to%20prevent%20constant%20order%20swapping%20with%20each%20new%20message%20submitted),%20use%20alphabetical%5Cn%20%20let%20sortedUniqueNames%20=%20Object.entries(nameHist).map(e%20=%3E%20%5Be%5B0%5D,%20Math.round(e%5B1%5D/10)%5D).sort((%5BaName,%20aCount%5D,%20%5BbName,%20bCount%5D)%20=%3E%20bCount%20-%20aCount%20%7C%7C%20aName.localeCompare(bName)).map((%5Bname%5D)%20=%3E%20name);%5Cn%20%20return%20sortedUniqueNames;%5Cn%5CnupdateCharacterNameViews()%20=%3E%5Cn%20%20let%20recentCharacterNames%20=%20getRecentCharacterNames();%5Cn%20%20quickReplyButtonsCtn.innerHTML%20=%20recentCharacterNames.map(n%20=%3E%20%60%3Cbutton%20data-name=%5C%22$%7Bn.replace(/%5C%22/g,%20%5C%22&quot;%5C%22)%7D%5C%22%20style=%5C%22font-size:75%25;%5C%22%3E%F0%9F%97%A3%EF%B8%8F%20$%7Bn%7D%3C/button%3E%60).join(%5C%22%5C%22);%5Cn%20%20quickReplyButtonsCtn.querySelectorAll(%5C%22button%5C%22).forEach(btn%20=%3E%20%7B%5Cn%20%20%20%20btn.onclick%20=%20function()%20%7B%5Cn%20%20%20%20%20%20chatLogsEl.value%20=%20chatLogsEl.value.trim();%5Cn%20%20%20%20%20%20if(!chatLogsEl.value.endsWith('%5C%5Cn%5C%5Cn'+this.dataset.name+':'))%20%7B%5Cn%20%20%20%20%20%20%20%20chatLogsEl.value%20+=%20'%5C%5Cn%5C%5Cn'+this.dataset.name+':';%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20handleSendButtonClick(%7Bmode:%5C%22normal%5C%22%7D);%5Cn%20%20%20%20%7D;%5Cn%20%20%7D);%5Cn%20%20let%20btn%20=%20document.createElement(%5C%22button%5C%22);%5Cn%20%20btn.style.cssText%20=%20%5C%22font-size:75%25;%5C%22;%5Cn%20%20btn.textContent%20=%20%5C%22+%5C%22;%5Cn%20%20btn.onclick%20=%20function()%20%7B%5Cn%20%20%20%20let%20characterName%20=%20prompt(%5C%22Enter%20the%20name%20of%20the%20new%20character%20that%20you'd%20like%20to%20enter%20the%20chat.%20You%20can%20describe%20extra%20characters%20in%20the%20'Scenario'%20box%20if%20needed.%5C%22);%5Cn%20%20%20%20if(characterName%20===%20null%20%7C%7C%20characterName.trim()%20===%20%5C%22%5C%22)%20return;%5Cn%20%20%20%20characterName%20=%20characterName.trim();%5Cn%20%20%20%20chatLogsEl.value%20=%20chatLogsEl.value.trim();%5Cn%20%20%20%20chatLogsEl.value%20+=%20'%5C%5Cn%5C%5Cn'+characterName.trim()+':';%5Cn%20%20%20%20handleSendButtonClick(%7Bmode:%5C%22normal%5C%22%7D);%5Cn%20%20%20%20chatLogsDeleteBtn.dataset.mode%20=%20'delete';%5Cn%20%20%7D;%5Cn%20%20quickReplyButtonsCtn.append(btn);%5Cn%20%20%5Cn%20%20//%20update%20the%20%5C%22send%20as%5C%22%20%3Cselect%3E%20element,%20ensuring%20user%20character%20is%20first%20by%20default,%20and%20preserving%20previously-selected%20value%20if%20that%20character%20still%20'exists'%5Cn%20%20let%20userNameEvaluated%20=%20userName.evaluateItem;%5Cn%20%20let%20existingSendAsValue%20=%20sendAsCharacterSelectEl.value;%5Cn%20%20sendAsCharacterSelectEl.innerHTML%20=%20%5BuserNameEvaluated,%20...recentCharacterNames.filter(n%20=%3E%20n%20!==%20userNameEvaluated)%5D.map(n%20=%3E%20%60%3Coption%3E$%7Bn%7D%3C/option%3E%60).join(%5C%22%5C%22);%5Cn%20%20sendAsCharacterSelectEl.innerHTML%20+=%20%60%3Coption%20value=%5C%22~~~NEW_CHAR~~~%5C%22%3E%F0%9D%97%A1%F0%9D%97%B2%F0%9D%98%84...%3C/option%3E%60;%5Cn%20%20if(recentCharacterNames.includes(existingSendAsValue))%20sendAsCharacterSelectEl.value%20=%20existingSendAsValue;%5Cn%20%20%5Cn%20%20document.querySelectorAll(%5C%22.containsCharName%5C%22).forEach(el%20=%3E%20update(el));%5Cn%20%20%5Cn%5CnupdateDeleteButtonVisibility()%20=%3E%5Cn%20%20botDescriptionDeleteBtn.style.display%20=%20botDescriptionEl.value.trim()%20?%20%5C%22%5C%22%20:%20%5C%22none%5C%22;%5Cn%20%20userDescriptionDeleteBtn.style.display%20=%20userDescriptionEl.value.trim()%20?%20%5C%22%5C%22%20:%20%5C%22none%5C%22;%5Cn%20%20scenarioDeleteBtn.style.display%20=%20scenarioEl.value.trim()%20?%20%5C%22%5C%22%20:%20%5C%22none%5C%22;%5Cn%20%20chatLogsDeleteBtn.style.display%20=%20chatLogsEl.value.trim()%20?%20%5C%22%5C%22%20:%20%5C%22none%5C%22;%5Cn%20%20writingInstructionsDeleteBtn.style.display%20=%20writingInstructionsEl.value.trim()%20?%20%5C%22%5C%22%20:%20%5C%22none%5C%22;%5Cn%5CngenerateCharacterDescription(botOrUser,%20buttonEl)%20=%3E%5Cn%20%20let%20descriptionEl%20=%20botOrUser==%5C%22bot%5C%22%20?%20botDescriptionEl%20:%20userDescriptionEl;%5Cn%20%20let%20nameEl%20=%20botOrUser==%5C%22bot%5C%22%20?%20botNameEl%20:%20userNameEl;%5Cn%20%20%5Cn%20%20if(botOrUser==%5C%22bot%5C%22)%20botDescriptionDeleteBtn.dataset.mode='delete';%5Cn%20%20else%20userDescriptionDeleteBtn.dataset.mode='delete';%5Cn%20%20%5Cn%20%20let%20warningText%20=%20%5C%22%5C%22;%5Cn%20%20if(descriptionEl.value.trim()%20!==%20%5C%22%5C%22)%20warningText%20=%20%5C%22The%20existing%20description%20will%20be%20cleared.%20%5C%22;%5Cn%20%20let%20inspiration%20=%20prompt(%60$%7BwarningText%7DType%20some%20keywords%20or%20ideas%20below%20(optional),%20and%20then%20click%20OK.%60);%5Cn%20%20if(inspiration%20===%20null)%20return;%20//%20%3C--%20they%20clicked%20cancel%5Cn%20%20buttonEl.disabled%20=%20true;%5Cn%20%20buttonEl.textContent%20=%20%5C%22%E2%8C%9B%20loading...%5C%22;%5Cn%20%20descriptionEl.value%20=%20%5C%22%5C%22;%5Cn%20%20%5Cn%20%20let%20startWith%20=%20%5C%22Name:%5C%22;%5Cn%20%20if(nameEl.value.trim())%20startWith%20=%20%60Name:%20$%7BnameEl.value.trim()%7D%5C%5CnAppearance:%60;%5Cn%20%20let%20responseObj%20=%20ai(%7B%5Cn%20%20%20%20instruction:%20%60Write%20a%20creative,%20interesting,%20description%20of%20a%20character%20using%20the%20following%20keywords/prompt/ideas%20as%20inspiration:%20$%7Binspiration%20%7C%7C%20%5C%22(None%20provided.%20Just%20be%20creative!)%5C%22%7D%5C%5Cn%5C%5CnYour%20description%20should%20include%20the%20name,%20age,%20appearance,%20personality,%20and%20character%20background.%20Keep%20it%20short.%20Be%20creative!%60,%5Cn%20%20%20%20startWith,%5Cn%20%20%20%20onChunk:%20function(data)%20%7B%5Cn%20%20%20%20%20%20descriptionEl.value%20+=%20data.textChunk;%5Cn%20%20%20%20%20%20descriptionEl.scrollTop%20=%2099999999;%20//%20scroll%20down%20to%20bottom%20of%20text%20box%5Cn%20%20%20%20%7D,%5Cn%20%20%20%20onFinish:%20function(data)%20%7B%5Cn%20%20%20%20%20%20buttonEl.disabled%20=%20false;%5Cn%20%20%20%20%20%20buttonEl.textContent%20=%20%5C%22%E2%9C%A8%20generate%5C%22;%5Cn%20%20%20%20%20%20if(botOrUser==%5C%22bot%5C%22)%20localStorage.botDescription%20=%20botDescriptionEl.value;%5Cn%20%20%20%20%20%20else%20localStorage.userDescription%20=%20userDescriptionEl.value;%5Cn%20%20%20%20%20%20updateDeleteButtonVisibility();%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20if(botOrUser==%5C%22bot%5C%22)%20resizeTextAreaHeightToFitContent(botDescriptionEl);%5Cn%20%20%20%20%20%20else%20resizeTextAreaHeightToFitContent(userDescriptionEl);%5Cn%20%20%20%20%7D,%5Cn%20%20%7D);%5Cn%5Cn%5Cn%5CngenerateScenarioDescription(buttonEl)%20=%3E%5Cn%20%20if(botNameEl.value.trim()%20===%20%5C%22%5C%22%20%7C%7C%20userNameEl.value.trim()%20===%20%5C%22%5C%22%20%7C%7C%20botDescriptionEl.value.trim()%20===%20%5C%22%5C%22%20%7C%7C%20userDescriptionEl.value.trim()%20===%20%5C%22%5C%22)%20%7B%5Cn%20%20%20%20alert(%5C%22Please%20fill%20in%20character%20names%20and%20descriptions%20first.%5C%22);%5Cn%20%20%20%20return;%5Cn%20%20%7D%5Cn%20%20let%20warningText%20=%20%5C%22%5C%22;%5Cn%20%20if(scenarioEl.value.trim()%20!==%20%5C%22%5C%22)%20warningText%20=%20%5C%22The%20existing%20scenario%20description%20will%20be%20cleared.%20%5C%22;%5Cn%20%20window.scenarioInspiration%20=%20prompt(%60$%7BwarningText%7DType%20some%20keywords%20or%20ideas%20below%20(optional),%20and%20then%20click%20OK.%60,%20window.lastScenarioInspirationIdea);%5Cn%20%20if(window.scenarioInspiration%20===%20null)%20return;%20//%20%3C--%20they%20clicked%20cancel%5Cn%20%20window.lastScenarioInspirationIdea%20=%20window.scenarioInspiration;%5Cn%20%20buttonEl.disabled%20=%20true;%5Cn%20%20buttonEl.textContent%20=%20%5C%22%E2%8C%9B%20loading...%5C%22;%5Cn%20%20scenarioEl.value%20=%20%5C%22%5C%22;%5Cn%20%20%5Cn%20%20let%20responseObj%20=%20ai(%7B%5Cn%20%20%20%20instruction:%20scenarioGenerationPrompt.evaluateItem,%5Cn%20%20%20%20startWith:%20%5C%22The%20scenario%20begins%20with%5C%22,%5Cn%20%20%20%20stopSequences:%20%5B%5C%22%5C%5Cn%5C%5Cn%5C%22%5D,%5Cn%20%20%20%20onChunk:%20function(data)%20%7B%5Cn%20%20%20%20%20%20scenarioEl.value%20+=%20data.textChunk;%5Cn%20%20%20%20%20%20scenarioEl.scrollTop%20=%2099999999;%20//%20scroll%20down%20to%20bottom%20of%20text%20box%5Cn%20%20%20%20%7D,%5Cn%20%20%20%20onFinish:%20function(data)%20%7B%5Cn%20%20%20%20%20%20buttonEl.disabled%20=%20false;%5Cn%20%20%20%20%20%20buttonEl.textContent%20=%20%5C%22%E2%9C%A8%20generate%5C%22;%5Cn%20%20%20%20%20%20localStorage.scenario%20=%20scenarioEl.value;%5Cn%20%20%20%20%20%20updateDeleteButtonVisibility();%5Cn%20%20%20%20%20%20resizeTextAreaHeightToFitContent(scenarioEl);%5Cn%20%20%20%20%7D,%5Cn%20%20%7D);%5Cn%20%20%5CnscenarioGenerationPrompt%5Cn%20%20I'm%20going%20to%20get%20you%20to%20write%20a%20creative,%20interesting%20chat/roleplay%20scenario%20using%20the%20following%20keywords/prompt/ideas%20as%20inspiration:%20%5Bwindow.scenarioInspiration%20%7C%7C%20%5C%22(None%20provided.%20Just%20be%20creative!)%5C%22%5D%5Cn%20%20The%20scenario%20should%20be%20based%20on%20these%20two%20characters:%5Cn%20%20#%20Character%201:%20%5BbotNameEl.value.trim()%5D%5Cn%20%20%5BbotDescriptionEl.value.trim().replaceAll(%5C%22%7B%7Buser%7D%7D%5C%22,%20userName).replaceAll(%5C%22%7B%7Bchar%7D%7D%5C%22,%20botName)%5D%5Cn%20%20%5C%5Cn%5Cn%20%20#%20Character%202:%20%5BuserNameEl.value.trim()%5D%5Cn%20%20%5BuserDescriptionEl.value.trim().replaceAll(%5C%22%7B%7Buser%7D%7D%5C%22,%20userName).replaceAll(%5C%22%7B%7Bchar%7D%7D%5C%22,%20botName)%5D%5Cn%20%20%5C%5Cn%5Cn%20%20Your%20task%20is%20to%20write%20an%20interesting,%20creative,%20engaging%20chat/roleplay%20scenario%20between%20the%20above%20two%20characters.%20As%20mentioned%20above,%20it%20should%20be%20based%20on%20these%20keywords/ideas/topics/instructions:%20%5Bwindow.scenarioInspiration%20%7C%7C%20%5C%22(None%20provided.%20Just%20be%20creative!)%5C%22%5D%5Cn%20%20The%20scenario%20should%20be%20a%20single%20SHORT%20paragraph%20that%20sets%20up%20the%20beginning%20of%20the%20chat/roleplay%20so%20it%20goes%20in%20an%20interesting%20and%20fun%20direction.%5Cn%20%20Be%20creative!%20Just%20provide%20a%20one-paragraph%20%5C%22spark%5C%22%20to%20get%20the%20chat/roleplay%20going.%5Cn%20%20$output%20=%20%5Bthis.joinItems(%5C%22%5C%5Cn%5C%22)%5D%5Cn%20%20%5Cn%5CnresizeTextAreaHeightToFitContent(textArea,%20opts)%20=%3E%5Cn%20%20if(!opts)%20opts%20=%20%7B%7D;%5Cn%20%20textArea.style.height%20=%200+%5C%22px%5C%22;%5Cn%20%20let%20height%20=%20textArea.scrollHeight+10;%5Cn%20%20if(opts.min%20!==%20undefined%20&&%20height%20%3C%20opts.min)%20%7B%5Cn%20%20%20%20height%20=%20opts.min;%5Cn%20%20%7D%5Cn%20%20textArea.style.height%20=%20%60$%7Bheight%7Dpx%60;%5Cn%5Cn%5Cnasync%20generateCharactersAndScenario()%20=%3E%5Cn%20%20let%20inspiration%20=%20prompt(%5C%22Enter%20a%20few%20keywords/ideas%20and%20the%20AI%20will%20use%20them%20to%20generate%20the%20characters%20and%20the%20scenario:%5C%22,%20window.lastCharactersAndScenarioInspirationIdea);%5Cn%20%20if(inspiration%20===%20null)%20return;%5Cn%20%20window.lastCharactersAndScenarioInspirationIdea%20=%20inspiration;%5Cn%20%20inspiration%20=%20inspiration.trim();%5Cn%20%20let%20inspirationInstruction%20=%20inspiration%20?%20%5C%22You%20MUST%20use%20these%20instructions/ideas%20as%20inspiration:%20%5C%22+inspiration+%5C%22%5C%5CnTry%20to%20make%20your%20best%20guess%20at%20the%20intention/idea%20behind%20these%20user-provided%20instructions/ideas,%20and%20then%20invent%20a%20creative%20and%20fascinating%20scenario%20based%20on%20those%20intentions.%5C%22%20:%20%5C%22%5C%22;%5Cn%5Cn%20%20let%20fullInstruction%20=%20charactersAndScenarioGenerationPrompt.evaluateItem.replace(%5C%22##inspirationPlaceholder##%5C%22,%20inspirationInstruction);%5Cn%5Cn%20%20botDescriptionDeleteBtn.dataset.mode%20=%20'delete';%5Cn%20%20userDescriptionDeleteBtn.dataset.mode%20=%20'delete';%5Cn%20%20scenarioDeleteBtn.dataset.mode%20=%20'delete';%5Cn%20%20%5Cn%20%20generateCharactersAndScenarioBtn.disabled%20=%20true;%5Cn%20%20generateCharactersAndScenarioBtn.textContent%20=%20%5C%22%E2%8C%9B%20loading...%5C%22;%5Cn%20%20%5Cn%20%20function%20render(text)%20%7B%5Cn%20%20%20%20let%20lines%20=%20text.split(%5C%22%5C%5Cn%5C%22).map(l%20=%3E%20l.trim()).filter(l%20=%3E%20l.includes(%5C%22:%5C%22));%5Cn%20%20%20%20let%20char1%20=%20lines.find(l%20=%3E%20l.startsWith(%5C%22CHARACTER%201%20NAME:%5C%22))?.trim().split(%5C%22:%5C%22).slice(1).join(%5C%22:%5C%22).trim();%5Cn%20%20%20%20let%20char2%20=%20lines.find(l%20=%3E%20l.startsWith(%5C%22CHARACTER%202%20NAME:%5C%22))?.trim().split(%5C%22:%5C%22).slice(1).join(%5C%22:%5C%22).trim();%5Cn%20%20%20%20let%20desc1%20=%20lines.find(l%20=%3E%20l.startsWith(%5C%22CHARACTER%201%20DESCRIPTION:%5C%22))?.trim().split(%5C%22:%5C%22).slice(1).join(%5C%22:%5C%22).trim();%5Cn%20%20%20%20let%20desc2%20=%20lines.find(l%20=%3E%20l.startsWith(%5C%22CHARACTER%202%20DESCRIPTION:%5C%22))?.trim().split(%5C%22:%5C%22).slice(1).join(%5C%22:%5C%22).trim();%5Cn%20%20%20%20let%20scenario%20=%20text.split(%5C%22STARTING%20SCENARIO:%5C%22)%5B1%5D?.trim().replace(/%5C%5Cn+/g,%20%5C%22%5C%5Cn%5C%5Cn%5C%22);%5Cn%20%20%20%20botNameEl.value%20=%20char1%20%7C%7C%20%5C%22%5C%22;%5Cn%20%20%20%20userNameEl.value%20=%20char2%20%7C%7C%20%5C%22%5C%22;%5Cn%20%20%20%20botDescriptionEl.value%20=%20desc1%20%7C%7C%20%5C%22%5C%22;%5Cn%20%20%20%20userDescriptionEl.value%20=%20desc2%20%7C%7C%20%5C%22%5C%22;%5Cn%20%20%20%20scenarioEl.value%20=%20scenario%20%7C%7C%20%5C%22%5C%22;%5Cn%20%20%20%20resizeTextAreaHeightToFitContent(botDescriptionEl,%20%7Bmin:120%7D);%5Cn%20%20%20%20resizeTextAreaHeightToFitContent(userDescriptionEl,%20%7Bmin:120%7D);%5Cn%20%20%20%20resizeTextAreaHeightToFitContent(scenarioEl,%20%7Bmin:120%7D);%5Cn%20%20%20%20document.querySelectorAll(%5C%22.containsCharName%5C%22).forEach(el%20=%3E%20update(el));%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20let%20outputLength%20=%200;%5Cn%20%20let%20responseObj%20=%20ai(%7B%5Cn%20%20%20%20instruction:%20fullInstruction,%5Cn%20%20%20%20startWith:%20%5C%22CHARACTER%201%20NAME:%5C%22,%5Cn%20%20%20%20onChunk:%20function(data)%20%7B%5Cn%20%20%20%20%20%20outputLength%20+=%20data.textChunk.length;%5Cn%20%20%20%20%20%20generateCharactersAndScenarioBtn.textContent%20=%20%60%E2%8C%9B%20$%7BMath.round(outputLength/5)%7D%20words...%60;%20//%20just%20an%20approximation%5Cn%20%20%20%20%20%20try%20%7B%20render(data.fullTextSoFar);%20%7D%20catch(e)%20%7B%20console.error(e);%20%7D%5Cn%20%20%20%20%7D,%5Cn%20%20%7D);%5Cn%20%20generateCharactersAndScenarioLoaderEl.innerHTML%20=%20responseObj.loadingIndicatorHtml;%5Cn%20%20%5Cn%20%20stopCharAndScenarioGenBtn.style.display%20=%20%5C%22block%5C%22;%5Cn%20%20stopCharAndScenarioGenBtn.onclick%20=%20function()%20%7B%5Cn%20%20%20%20responseObj.stop();%5Cn%20%20%20%20stopCharAndScenarioGenBtn.style.display%20=%20%5C%22none%5C%22;%5Cn%20%20%7D;%5Cn%20%20%5Cn%20%20let%20data%20=%20await%20responseObj.onFinishPromise;%5Cn%20%20console.log(%5C%22generateCharactersAndScenario%20text:%5C%22,%20data.text);%5Cn%20%20render(data.text);%5Cn%20%20stopCharAndScenarioGenBtn.onclick%20=%20null;%5Cn%20%20stopCharAndScenarioGenBtn.style.display%20=%20%5C%22none%5C%22;%5Cn%20%20//%20let%20lines%20=%20data.text.split(%5C%22%5C%5Cn%5C%22).map(l%20=%3E%20l.trim()).filter(l%20=%3E%20l.includes(%5C%22:%5C%22));%5Cn%20%20//%20let%20char1%20=%20lines.find(l%20=%3E%20l.startsWith(%5C%22CHARACTER%201%20NAME:%5C%22))?.trim().split(%5C%22:%5C%22).slice(1).join(%5C%22:%5C%22).trim();%5Cn%20%20//%20let%20char2%20=%20lines.find(l%20=%3E%20l.startsWith(%5C%22CHARACTER%202%20NAME:%5C%22))?.trim().split(%5C%22:%5C%22).slice(1).join(%5C%22:%5C%22).trim();%5Cn%20%20//%20let%20desc1%20=%20lines.find(l%20=%3E%20l.startsWith(%5C%22CHARACTER%201%20DESCRIPTION:%5C%22))?.trim().split(%5C%22:%5C%22).slice(1).join(%5C%22:%5C%22).trim();%5Cn%20%20//%20let%20desc2%20=%20lines.find(l%20=%3E%20l.startsWith(%5C%22CHARACTER%202%20DESCRIPTION:%5C%22))?.trim().split(%5C%22:%5C%22).slice(1).join(%5C%22:%5C%22).trim();%5Cn%20%20//%20let%20scenario%20=%20data.text.split(%5C%22STARTING%20SCENARIO:%5C%22)%5B1%5D?.trim().replace(/%5C%5Cn+/g,%20%5C%22%5C%5Cn%5C%5Cn%5C%22);%5Cn%20%20//%20botNameEl.value%20=%20char1;%5Cn%20%20//%20userNameEl.value%20=%20char2;%5Cn%20%20//%20botDescriptionEl.value%20=%20desc1;%5Cn%20%20//%20userDescriptionEl.value%20=%20desc2;%5Cn%20%20//%20scenarioEl.value%20=%20scenario;%5Cn%20%20%5Cn%20%20resizeTextAreaHeightToFitContent(botDescriptionEl,%20%7Bmin:120%7D);%5Cn%20%20resizeTextAreaHeightToFitContent(userDescriptionEl,%20%7Bmin:120%7D);%5Cn%20%20resizeTextAreaHeightToFitContent(scenarioEl,%20%7Bmin:120%7D);%5Cn%20%20%5Cn%20%20localStorage.botName%20=%20botNameEl.value;%5Cn%20%20localStorage.userName%20=%20userNameEl.value;%5Cn%20%20localStorage.botDescription%20=%20botDescriptionEl.value;%5Cn%20%20localStorage.userDescription%20=%20userDescriptionEl.value;%5Cn%20%20localStorage.scenario%20=%20scenarioEl.value;%5Cn%5Cn%20%20generateCharactersAndScenarioLoaderEl.innerHTML%20=%20%5C%22%5C%22;%5Cn%20%20setTimeout(()%20=%3E%20%7B%5Cn%20%20%20%20generateCharactersAndScenarioBtn.textContent%20=%20%5C%22%E2%9C%A8%20generate%20characters%5C%22;%5Cn%20%20%20%20generateCharactersAndScenarioBtn.disabled%20=%20false;%5Cn%20%20%7D,%202000);%5Cn%20%20generateCharactersAndScenarioBtn.textContent%20=%20%5C%22%E2%AC%87%EF%B8%8F%20finished%20%E2%AC%87%EF%B8%8F%5C%22;%5Cn%20%20updateCharacterNameViews();%5Cn%20%20updateDeleteButtonVisibility();%5Cn%20%20update();%5Cn%20%20%5CncharactersAndScenarioGenerationPrompt%5Cn%20%20Your%20task%20is%20to%20come%20up%20with%20an%20interesting%20and%20creative%20chat/RP%20scenario%20with%20two%20characters.%20Ensure%20that%20what%20you%20write%20is%20creative,%20subtle,%20authentic,%20interesting,%20descriptive,%20and%20at%20the%20level%20of%20an%20internationally%20acclaimed,%20award-winning%20fiction%20author.%20Try%20to%20be%20creative%20and%20avoid%20boring%20cliches.%5Cn%20%20%5B%5C%22%5C%22%5D%5Cn%20%20You%20must%20use%20this%20EXACT%20template%20for%20your%20response:%5Cn%20%20---%5Cn%20%20CHARACTER%201%20NAME:%20(the%20first%20character's%20given%20name%20or%20nickname)%5Cn%20%20CHARACTER%201%20DESCRIPTION:%20(a%204-sentence%20description%20and%20personality%20of%20the%20first%20character)%5Cn%20%20CHARACTER%202%20NAME:%20(the%20second%20character's%20given%20name%20or%20nickname)%5Cn%20%20CHARACTER%202%20DESCRIPTION:%20(a%204-sentence%20description%20and%20personality%20of%20the%20second%20character)%5Cn%20%20STARTING%20SCENARIO:%20(a%20one-paragraph%20roleplay%20starter%20-%20i.e.%20a%20starting%20scenario%20for%20the%20above%20two%20characters%20that%20is%20interesting,%20creative%20and%20engaging.%20This%20paragraph%20is%20the%20%5C%22spark%5C%22%20to%20get%20the%20chat/roleplay%20going%20-%20i.e.%20it%20%5C%22sets%20the%20scene%5C%22.)%5Cn%20%20---%5Cn%20%20Follow%20the%20above%20template%20EXACTLY,%20replacing%20the%20parentheticals%20with%20actual%20content.%5Cn%20%20##inspirationPlaceholder##%5Cn%20%20$output%20=%20%5Bthis.joinItems(%5C%22%5C%5Cn%5C%22)%5D%5Cn%5Cn%5Cn$meta%5Cn%20%20title%20=%20AI%20Chat%20&%20Roleplay%20(free,%20no%20sign-up,%20fast,%20unlimited)%5Cn%20%20description%20=%20A%20free%20%5C%22Character%20AI%5C%22%20chat%20using%20Perchance's%20new%20AI%20text%20generation%20feature%20-%20chat%20with%20AI%20characters.%20Just%20create%20a%20character%20and%20a%20scenario%20for%20the%20chat/roleplay,%20and%20send%20a%20message.%20Talk%20to%20AI%20characters,%20no%20login/sign-up%20needed%20-%20completely%20free!%20%F0%9F%98%8C%20An%20AI%20chat%20generator%20that's%20fast%20and%20has%20no%20limits%20on%20daily%20usage.%20Can%20do%20basically%20any%20character/scenario%20type%20-%20stories,%20anime%20characters,%20warrior%20cats%20roleplay,%20funny/silly/cute/wholesome,%20friend/companion/romantic/boyfriend/girlfriend%20AI/chatbot,%20movie%20and%20TV%20show%20characters%20-%20if%20you%20can%20describe%20it,%20then%20you%20can%20probably%20create%20your%20own%20chat%20bot%20for%20it.%20Basically%20a%20CAI%20/%20Character%20AI%20alternative.%20WARNINGS:%20(1)%20Everything%20the%20AI%20says%20is%20made%20up.%20(2)%20Inappropriate%20content%20(i.e.%2018+%20chat%20messages)%20should%20only%20be%20produced%20if%20explicitely%20prompted.%20If%20needed,%20guide%20the%20AI%20using%20the%20'scenario'%20input%20-%20i.e.%20you%20can%20describe%20your%20own%20'filter'%20/%20restrictions%20to%20the%20AI.%5Cn%5Cn%5Cn%5CncommentsBannedUsers%5Cn%20%204dafd569d9ba2925c9e7%5Cn%20%2061fb1f2cdce8b2a45566%5Cn%20%20077e8a3a7070ef8753ee%5Cn%20%20c6176e59a16e56d6ebd1%5Cn%20%20475f01f601f7296e1795%5Cn%20%201ef522bfc0e0b04726fe%5Cn%20%2030743893ff00cac07b40%5Cn%20%20207b4a86b9c8cf8e3f7a%5Cn%20%201b99cb216e4ccab2e621%5Cn%20%207d13d56eb4d0e0476a97%5Cn%20%200e074e1bd613d069d222%5Cn%20%20edd8e65b646ae9e2e068%5Cn%20%20f741f6b9ee39352986fc%5Cn%20%205ad3f7d1b0304bf72082%5Cn%20%20eec997bbbc9f046f8ff8%5Cn%20%20ca7a57165f5787cf88a4%5Cn%20%20d7d170b1bbf548ae3638%5Cn%20%20be637eaa304797119acd%5Cn%20%200e78c74c5f9a77d4db5a%5Cn%20%20438c28dc386894293503%5Cn%20%20aa961bb79a20734840e5%5Cn%20%20ff052ab022e5ef70a068%5Cn%20%20a8c2ac60554d819cb8f5%5Cn%20%2011251530e81ee31356e0%5Cn%20%20acff28b65738ae8bdd45%5Cn%20%208fa4467352d56da8cb36%5Cn%20%209b7cd52d178c29f9a345%5Cn%20%20b7056ab30c71eef50bad%5Cn%20%20efc383c36880dd1e1d04%5Cn%20%208ff54b7e7c86df34299c%5Cn%20%201543f059d555546cee00%5Cn%20%207af28ae824cf24ad6ba6%5Cn%20%20abf3df5c8248fecdc19b%5Cn%20%204aa0853d3220fa2de451%5Cn%20%20f1f84a99c8cc6e05a7df%5Cn%20%20612f7c65807081b466ef%5Cn%20%20525bef02fcc597ede909%5Cn%20%2091136fa2eddb04aa4486%5Cn%20%206a949f353ac7c00de62f%5Cn%20%2011e3f9e3e7067cbb39bb%5Cn%20%20078c511806780b093c1c%5Cn%20%2059c3c5f536176c8e7f33%5Cn%20%20e0a872fbcbdecbcb1f5a%5Cn%20%20cb3b92a5a0daf3041074%5Cn%20%2082565d73d3edeabee4b2%5Cn%20%20feaf485e320453c7d3a8%5Cn%20%200c2f42261e9cb646beab%5Cn%20%20c3c44c783c49d7d24d2d%5Cn%20%20f9a8c3bdb0826bbbacfb%5Cn%20%20805ea82081d3e35a3a29%5Cn%20%200a355460c1fc87d21b43%5Cn%20%2018aa714f6d54b732b82d%5Cn%20%202efe053c0743ced16387%5Cn%20%20ca52d7634fccf9138a35%5Cn%20%20e99a04469c4ff70dcba0%5Cn%20%2087ba81889f3bbb4f8938%5Cn%20%2050960ba005b0b20ac164%5Cn%20%20ca11e183b0b05f99ffb0%5Cn%20%206ef2c2771cfc05ae4e61%5Cn%20%204457a3a800a01a953839%5Cn%20%2059ee95c2fe69dc025355%5Cn%20%207d2ee53550cfc0e01acd%5Cn%20%20867d7fc56fa2d5164383%22,%22outputTemplate%22:%22%3Ch1%20style=%5C%22margin-bottom:0.5rem%5C%22%3EAI%20Chat%3C/h1%3E%20%5Cn%3Cp%20style=%5C%22font-size:80%25;%5C%22%3Epsst.%20%3Ca%20href=%5C%22https://perchance.org/ai-character-chat%5C%22%20target=%5C%22_blank%5C%22%20style=%5C%22font-weight:bold;%20color:#2bbb00;%5C%22%3Eclick%20here%3C/a%3E%20to%20try%20out%20a%20different%20character%20chat%20interface.%3C/p%3E%20%5Cn%3Cdiv%20style=%5C%22display:flex;%20flex-direction:column;%20justify-content:center;%20align-items:center;%20max-width:98%25;%20width:700px;%20margin:0%20auto;%5C%22%3E%20%5Cn%20%20%5Cn%20%20%3Cp%20style=%5C%22font-size:80%25;%20margin-bottom:0rem;%20text-align:justify;%5C%22%3EThis%20is%20a%20demonstration%20of%20what's%20possible%20with%20Perchance's%20new%20%3Ca%20href=%5C%22/ai-text-plugin%5C%22%20target=%5C%22_blank%5C%22%3EAI%20Text%20Plugin%3C/a%3E.%20I'll%20improve%20the%20interface%20a%20bit%20at%20some%20point,%20but%20for%20now%20it's%20pretty%20minimal.%20Try%20creating%20a%20character%20and%20a%20scenario%20below,%20and%20see%20what's%20possible%20using%20this%20new%20plugin!%20You%20can%20also%20try%20%3Ca%20href=%5C%22https://perchance.org/ai-story-generator%5C%22%20target=%5C%22_blank%5C%22%20style=%5C%22font-weight:bold;%5C%22%3Ewriting%20a%20story%3C/a%3E%20or%20%3Ca%20href=%5C%22https://perchance.org/ai-text-adventure%5C%22%20target=%5C%22_blank%5C%22%20style=%5C%22font-weight:bold;%5C%22%3Egoing%20on%20an%20adventure%3C/a%3E%20or%20%3Ca%20href=%5C%22https://perchance.org/ai-generated-hierarchical-world%5C%22%20target=%5C%22_blank%5C%22%20style=%5C%22font-weight:bold;%5C%22%3Eexploring%20a%20new%20planet%3C/a%3E.%20Then%20head%20to%20the%20%3Ca%20href=%5C%22/ai-text-plugin%5C%22%20target=%5C%22_blank%5C%22%3Eplugin%20page%3C/a%3E%20to%20see%20some%20simple%20examples%20that%20you%20can%20use%20as%20starting%20points%20to%20create%20your%20own%20generators.%3C/p%3E%5Cn%20%20%3Cp%20style=%5C%22font-size:80%25;%20margin-bottom:0.5rem;%20text-align:justify;%5C%22%3ENeed%20some%20character%20ideas%20for%20this%20demo?%20Try%20%3Ca%20href=%5C%22https://perchance.org/ai-character-description%5C%22%20target=%5C%22_blank%5C%22%20style=%5C%22font-weight:bold;%5C%22%3Ecreating%20a%20character%3C/a%3E.%20Or%20click%20the%20'generate%20characters'%20button%20below%20to%20get%20the%20AI%20to%20come%20up%20with%20characters%20and%20a%20scenario%20for%20you%20based%20on%20a%20prompt:%3C/p%3E%5Cn%20%20%3Cp%20style=%5C%22font-size:160%25;%20margin:0.5rem;%5C%22%3E%E2%86%93%3C/p%3E%5Cn%20%20%3Cdiv%20style=%5C%22font-size:85%25;%20margin-bottom:1rem;%20margin-top:1rem;%5C%22%3E%5Cn%20%20%20%20%3Cbutton%20id=%5C%22stopCharAndScenarioGenBtn%5C%22%20style=%5C%22display:none;%20font-size:80%25;%20margin:0%20auto;%20margin-bottom:0.25rem;%5C%22%3E%F0%9F%9B%91%20stop%3C/button%3E%5Cn%20%20%20%20%3Cbutton%20id=%5C%22generateCharactersAndScenarioBtn%5C%22%20onclick=%5C%22generateCharactersAndScenario()%5C%22%20style=%5C%22margin-bottom:0.25rem;%5C%22%3E%E2%9C%A8%20generate%20characters%3C/button%3E%5Cn%3C!--%20%20%20%20%20%3Cbutton%20id=%5C%22shareSessionBtn%5C%22%20onclick=%5C%22copySessionShareLink()%5C%22%20style=%5C%22margin-bottom:0.25rem;%5C%22%3E%F0%9F%94%97%20share%20current%20chat%3C/button%3E%20--%3E%5Cn%20%20%20%20%3Cdiv%20id=%5C%22generateCharactersAndScenarioLoaderEl%5C%22%3E%3C/div%3E%5Cn%20%20%3C/div%3E%5Cn%20%20%5Cn%20%20%3Cdiv%3E%E2%80%94%20Names%20%E2%80%94%3C/div%3E%20%5Cn%20%20%3Cinput%20id=%5C%22botNameEl%5C%22%20tabindex=%5C%221%5C%22%20placeholder=%5C%22The%20bot's%20nickname%5C%22%20oninput=%5C%22localStorage.botName=this.value,%20update(),%20updateCharacterNameViews()%5C%22%3E%5Cn%20%20%3Cinput%20id=%5C%22userNameEl%5C%22%20tabindex=%5C%221%5C%22%20placeholder=%5C%22Your%20nickname%5C%22%20oninput=%5C%22localStorage.userName=this.value,%20update(),%20updateCharacterNameViews()%5C%22%3E%5Cn%20%20%5Cn%20%20%3Cdiv%20style=%5C%22margin-top:2rem;%5C%22%3E%E2%80%94%20%3Cb%20class=%5C%22containsCharName%5C%22%3E%5BbotName%5D%3C/b%3E%20Character%20Description%20%E2%80%94%3C/div%3E%5Cn%20%20%3Cdiv%20style=%5C%22position:relative;%20width:100%25;%5C%22%3E%5Cn%20%20%20%20%3Ctextarea%20id=%5C%22botDescriptionEl%5C%22%20tabindex=%5C%221%5C%22%20placeholder=%5C%22Describe%20who%20the%20bot%20is%20and%20what%20personality%20you%20want%20them%20to%20have.%5C%22%20style=%5C%22width:100%25;%20height:120px;%20resize:vertical;%20display:block;%20padding-bottom:0.5rem;%20padding-top:0.25rem;%5C%22%20oninput=%5C%22localStorage.botDescription=this.value;%20botDescriptionDeleteBtn.dataset.mode='delete';%20botDescriptionDeleteBtn.style.display='';%5C%22%3E%3C/textarea%3E%5Cn%20%20%20%20%3Cdiv%20style=%5C%22position:absolute;%20bottom:0.5rem;%20width:100%25;%20height:0;%5C%22%3E%5Cn%20%20%20%20%20%20%3Cbutton%20id=%5C%22generateBotDescriptionBtn%5C%22%20onclick=%5C%22generateCharacterDescription('bot',%20this);%20botDescriptionDeleteBtn.dataset.mode='delete';%5C%22%20style=%5C%22font-size:70%25;%5C%22%3E%E2%9C%A8%20generate%3C/button%3E%5Cn%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%3Cbutton%20id=%5C%22botDescriptionDeleteBtn%5C%22%20data-mode=%5C%22delete%5C%22%20onclick=%5C%22if(this.dataset.mode==='delete')%20%7B%20window.deletedBotDescription=botDescriptionEl.value;%20botDescriptionEl.value='';%20this.dataset.mode='undo';%20%7D%20else%20%7B%20botDescriptionEl.value=window.deletedBotDescription;%20this.dataset.mode='delete';%20%7D;%20localStorage.botDescription=botDescriptionEl.value;%5C%22%20style=%5C%22position:absolute;%20top:-0.75rem;%20right:0.5rem;%20font-size:60%25;%20display:none;%5C%22%3E%3C/button%3E%5Cn%20%20%20%20%3Cstyle%3E%5Cn%20%20%20%20%20%20#botDescriptionDeleteBtn%5Bdata-mode='delete'%5D:before%20%7B%20content:'%F0%9F%97%91%EF%B8%8F%20delete';%20%7D%5Cn%20%20%20%20%20%20#botDescriptionDeleteBtn%5Bdata-mode='undo'%5D:before%20%7B%20content:'%E2%86%A9%EF%B8%8F%20undo';%20%7D%5Cn%20%20%20%20%3C/style%3E%5Cn%20%20%3C/div%3E%5Cn%20%20%5Cn%20%20%5Cn%20%20%3Cdiv%20style=%5C%22margin-top:2rem;%5C%22%3E%E2%80%94%20%3Cb%20class=%5C%22containsCharName%5C%22%3E%5BuserName%5D%3C/b%3E%20Character%20Description%20%E2%80%94%3C/div%3E%5Cn%20%20%3Cdiv%20style=%5C%22position:relative;%20width:100%25;%5C%22%3E%5Cn%20%20%20%20%3Ctextarea%20id=%5C%22userDescriptionEl%5C%22%20tabindex=%5C%221%5C%22%20placeholder=%5C%22Describe%20the%20character%20that%20*you*%20will%20be%20in%20this%20chat.%5C%22%20style=%5C%22width:100%25;%20height:120px;%20resize:vertical;%20display:block;%20padding-bottom:0.5rem;%20padding-top:0.25rem;%5C%22%20oninput=%5C%22localStorage.userDescription=this.value;%20userDescriptionDeleteBtn.dataset.mode='delete';%20userDescriptionDeleteBtn.style.display='';%5C%22%3E%3C/textarea%3E%5Cn%20%20%20%20%3Cdiv%20style=%5C%22position:absolute;%20bottom:0.5rem;%20width:100%25;%20height:0;%5C%22%3E%5Cn%20%20%20%20%20%20%3Cbutton%20id=%5C%22generateUserDescriptionBtn%5C%22%20onclick=%5C%22generateCharacterDescription('user',%20this);%20userDescriptionDeleteBtn.dataset.mode='delete';%5C%22%20style=%5C%22font-size:70%25;%5C%22%3E%E2%9C%A8%20generate%3C/button%3E%5Cn%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%3Cbutton%20id=%5C%22userDescriptionDeleteBtn%5C%22%20data-mode=%5C%22delete%5C%22%20onclick=%5C%22if(this.dataset.mode==='delete')%20%7B%20window.deletedUserDescription=userDescriptionEl.value;%20userDescriptionEl.value='';%20this.dataset.mode='undo';%20%7D%20else%20%7B%20userDescriptionEl.value=window.deletedUserDescription;%20this.dataset.mode='delete';%20%7D;%20localStorage.userDescription=userDescriptionEl.value;%5C%22%20style=%5C%22position:absolute;%20top:-0.75rem;%20right:0.5rem;%20font-size:60%25;%20display:none;%5C%22%3E%3C/button%3E%5Cn%20%20%20%20%3Cstyle%3E%5Cn%20%20%20%20%20%20#userDescriptionDeleteBtn%5Bdata-mode='delete'%5D:before%20%7B%20content:'%F0%9F%97%91%EF%B8%8F%20delete';%20%7D%5Cn%20%20%20%20%20%20#userDescriptionDeleteBtn%5Bdata-mode='undo'%5D:before%20%7B%20content:'%E2%86%A9%EF%B8%8F%20undo';%20%7D%5Cn%20%20%20%20%3C/style%3E%5Cn%20%20%3C/div%3E%5Cn%20%20%5Cn%20%20%3Cdiv%20style=%5C%22margin-top:2rem;%5C%22%3E%E2%80%94%20Scenario%20&amp;%20Lore%20%E2%80%94%3C/div%3E%5Cn%20%20%3Cdiv%20style=%5C%22position:relative;%20width:100%25;%5C%22%3E%5Cn%20%20%20%20%3Ctextarea%20id=%5C%22scenarioEl%5C%22%20tabindex=%5C%221%5C%22%20placeholder=%5C%22Describe%20the%20scenario,%20lore,%20side%20characters,%20and%20any%20other%20relevant%20information.%5C%22%20style=%5C%22width:100%25;%20height:120px;%20resize:vertical;%20display:block;%20padding-bottom:0.5rem;%20padding-top:0.25rem;%5C%22%20oninput=%5C%22localStorage.scenario=this.value;%20scenarioDeleteBtn.dataset.mode='delete';%20scenarioDeleteBtn.style.display='';%20%5C%22%3E%3C/textarea%3E%5Cn%20%20%20%20%3Cdiv%20style=%5C%22position:absolute;%20bottom:0.5rem;%20width:100%25;%20height:0;%5C%22%3E%5Cn%20%20%20%20%20%20%3Cbutton%20id=%5C%22generateScenarioBtn%5C%22%20onclick=%5C%22generateScenarioDescription(this);%20scenarioDeleteBtn.dataset.mode='delete';%5C%22%20style=%5C%22font-size:70%25;%5C%22%3E%E2%9C%A8%20generate%3C/button%3E%5Cn%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%3Cbutton%20id=%5C%22scenarioDeleteBtn%5C%22%20data-mode=%5C%22delete%5C%22%20onclick=%5C%22if(this.dataset.mode==='delete')%20%7B%20window.deletedScenario=scenarioEl.value;%20scenarioEl.value='';%20this.dataset.mode='undo';%20%7D%20else%20%7B%20scenarioEl.value=window.deletedScenario;%20this.dataset.mode='delete';%20%7D;%20localStorage.scenario=scenarioEl.value;%5C%22%20style=%5C%22position:absolute;%20top:-0.75rem;%20right:0.5rem;%20font-size:60%25;%20display:none;%5C%22%3E%3C/button%3E%5Cn%20%20%20%20%3Cstyle%3E%5Cn%20%20%20%20%20%20#scenarioDeleteBtn%5Bdata-mode='delete'%5D:before%20%7B%20content:'%F0%9F%97%91%EF%B8%8F%20delete';%20%7D%5Cn%20%20%20%20%20%20#scenarioDeleteBtn%5Bdata-mode='undo'%5D:before%20%7B%20content:'%E2%86%A9%EF%B8%8F%20undo';%20%7D%5Cn%20%20%20%20%3C/style%3E%5Cn%20%20%3C/div%3E%5Cn%20%20%5Cn%20%20%3Cdiv%20style=%5C%22margin-top:2rem;%5C%22%3E%E2%80%94%20Chat%20Logs%20%E2%80%94%3C/div%3E%5Cn%20%20%3Cdiv%20style=%5C%22position:relative;%20width:100%25;%5C%22%3E%5Cn%20%20%20%20%3Ctextarea%20id=%5C%22chatLogsEl%5C%22%20placeholder=%5C%22The%20chat%20logs%20will%20show%20up%20here,%20and%20you%20can%20edit%20them.&#10;&#10;The%20text%20here%20is%20completely%20freeform%20-%20for%20example,%20if%20you%20wanted%20to%20add%20a%20narrator%20that%20comes%20in%20every%20now%20and%20then,%20you%20could%20just%20write%20something%20like:&#10;&#10;Narrator:%20Later%20that%20day...&#10;&#10;And%20you%20can%20use%20*asterisks*%20for%20actions,%20and%20stuff%20like%20that.%5C%22%20style=%5C%22width:100%25;%20height:450px;%20max-height:70vh;%20resize:vertical;%20display:block;%20padding-bottom:1.5rem;%5C%22%20oninput=%5C%22localStorage.chatLogs=this.value;%20chatLogsDeleteBtn.dataset.mode='delete';%20chatLogsDeleteBtn.style.display='';%5C%22%20spellcheck=%5C%22false%5C%22%3E%3C/textarea%3E%5Cn%20%20%20%20%3Cdiv%20id=%5C%22loaderEl%5C%22%20style=%5C%22position:absolute;%20bottom:1.5rem;%20right:0.5rem;%5C%22%3E%3C/div%3E%5Cn%20%20%20%20%3Cdiv%20id=%5C%22tipEl%5C%22%20style=%5C%22display:none;%20position:absolute;top:0;left:%200;right:%200;%20font-size:85%25;%5C%22%3E%5Cn%20%20%20%20%20%20%3Cdiv%20style=%5C%22background:%20var(--box-color);padding:%200.5rem;box-shadow:%20rgba(0,%200,%200,%200.75)%200px%201px%204px%200px;%20border:1px%20solid%20#676767;%20border-radius:3px;%20width:95%25;%20max-width:600px;%20margin:0px%20auto;%20margin-top:1rem;%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Cdiv%20id=%5C%22tipMessageEl%5C%22%20style=%5C%22text-align:left;%5C%22%3E%3C/div%3E%5Cn%20%20%20%20%20%20%20%20%3Cbutton%20id=%5C%22tipDismissBtn%5C%22%20style=%5C%22margin-top:0.5rem;%5C%22%20onclick=%5C%22tipEl.style.display='none';%5C%22%3E%E2%9C%85%20understood%3C/button%3E%5Cn%20%20%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%3Cbutton%20id=%5C%22chatLogsDeleteBtn%5C%22%20data-mode=%5C%22delete%5C%22%20onclick=%5C%22if(this.dataset.mode==='delete')%20%7B%20window.deletedChatLogs=chatLogsEl.value;%20chatLogsEl.value='';%20this.dataset.mode='undo';%20%7D%20else%20%7B%20chatLogsEl.value=window.deletedChatLogs;%20this.dataset.mode='delete';%20%7D;%20localStorage.chatLogs=chatLogsEl.value;%5C%22%20style=%5C%22position:absolute;%20top:-0.75rem;%20right:0.5rem;%20font-size:60%25;%20display:none;%5C%22%3E%3C/button%3E%5Cn%20%20%20%20%3Cstyle%3E%5Cn%20%20%20%20%20%20#chatLogsDeleteBtn%5Bdata-mode='delete'%5D:before%20%7B%20content:'%F0%9F%97%91%EF%B8%8F%20delete';%20%7D%5Cn%20%20%20%20%20%20#chatLogsDeleteBtn%5Bdata-mode='undo'%5D:before%20%7B%20content:'%E2%86%A9%EF%B8%8F%20undo';%20%7D%5Cn%20%20%20%20%3C/style%3E%5Cn%20%20%20%20%3Cdiv%20id=%5C%22deleteAndRegenLastMessageCtn%5C%22%20style=%5C%22display:%5BchatLogsEl.value%20?%20'flex'%20:%20'none'%5D;%20margin-top:0.5rem;%20align-items:center;%20justify-content:center;%20position:relative;%20top:-0.5rem;%20height:0.25rem;%5C%22%3E%5Cn%20%20%20%20%20%20%3Cdiv%20id=%5C%22rateLastMessageCtn%5C%22%20style=%5C%22display:none;%20position:relative;%20height:min-content;%20margin-right:1rem;%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Cdiv%20id=%5C%22ratingReasonCtn%5C%22%20style=%5C%22display:none;%20position:absolute;%20text-align:center;%20width:100%25;%20font-size:80%25;%20top:0;%20height:0px;%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style=%5C%22position:absolute;%20bottom:0.25rem;%20text-align:center;%20width:max-content;%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3Cinput%20id=%5C%22ratingReasonEl%5C%22%20list=%5C%22recentRatingReasonsDataList%5C%22%20placeholder=%5C%22(Optional)%20Reason%5C%22%20style=%5C%22width:150px;%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3Cdatalist%20id=%5C%22recentRatingReasonsDataList%5C%22%3E%3C/datalist%3E%5Cn%20%20%20%20%20%20%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%20%20%20%20%3Cbutton%20id=%5C%22rateLastMessageBadBtn%5C%22%20disabled%20onclick=%5C%22rateLastMessage('bad');%5C%22%20style=%5C%22font-size:75%25;%20filter:hue-rotate(300deg);%5C%22%3E%F0%9F%91%8E%3C/button%3E%5Cn%20%20%20%20%20%20%20%20%3Cbutton%20id=%5C%22rateLastMessageGoodBtn%5C%22%20disabled%20onclick=%5C%22rateLastMessage('good');%5C%22%20style=%5C%22font-size:75%25;%20margin-left:0.25rem;%20filter:hue-rotate(35deg)%20saturate(0.9);%5C%22%3E%F0%9F%91%8D%3C/button%3E%5Cn%20%20%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%20%20%3Cdiv%20style=%5C%22position:relative;%20height:min-content;%20margin-left:0.5rem;%20display:flex;%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Cdiv%20id=%5C%22undoRegenMessageCtn%5C%22%20style=%5C%22display:none;%20position:absolute;%20text-align:center;%20width:100%25;%20font-size:80%25;%20top:0;%20height:0px;%5C%22%3E%3Cdiv%20style=%5C%22position:absolute;%20bottom:0.25rem;%20text-align:center;%20width:100%25;%5C%22%3E%3Cbutton%20style=%5C%22width:max-content;%5C%22%20onclick=%5C%22undoRegenLastMessage();%5C%22%3E%E2%86%A9%EF%B8%8F%20undo%3C/button%3E%3C/div%3E%3C/div%3E%5Cn%20%20%20%20%20%20%20%20%3Cbutton%20id=%5C%22regenPrevButton%5C%22%20class=%5C%22regenBtn%5C%22%20onclick=%5C%22prevRegenMessage();%20chatLogsDeleteBtn.dataset.mode='delete';%5C%22%20disabled%20style=%5C%22margin-left:0rem;%20%5C%22%3E%E2%AC%85%EF%B8%8F%3C/button%3E%5Cn%20%20%20%20%20%20%20%20%3Cbutton%20id=%5C%22regenMessageBtn%5C%22%20class=%5C%22regenBtn%5C%22%20onclick=%5C%22regenLastMessage();%20chatLogsDeleteBtn.dataset.mode='delete';%5C%22%20style=%5C%22margin-left:0.5rem;%20min-width:4rem;%5C%22%20data-short-content=%5C%22%F0%9F%94%81%5C%22%3E%F0%9F%94%81%20regen%20last%3C/button%3E%5Cn%20%20%20%20%20%20%20%20%3Cbutton%20id=%5C%22regenNextButton%5C%22%20class=%5C%22regenBtn%5C%22%20onclick=%5C%22nextRegenMessage();%20chatLogsDeleteBtn.dataset.mode='delete';%5C%22%20disabled%20style=%5C%22margin-left:0.5rem;%5C%22%3E%E2%9E%A1%EF%B8%8F%3C/button%3E%5Cn%20%20%20%20%20%20%20%20%3Cstyle%3E%5Cn%20%20%20%20%20%20%20%20%20%20.regenBtn%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20font-size:%2075%25;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20height:%20min-content;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20backdrop-filter:%20blur(200px);%20/*%20this%20is%20a%20hack%20to%20prevent%20background%20from%20being%20transparent%20(due%20to%20user%20agent%20styles%20-%20in%20Chrome,%20at%20least)%20when%20button%20is%20disabled%20*/%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%3C/style%3E%5Cn%20%20%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%20%20%3Cdiv%20style=%5C%22position:relative;%20height:min-content;%20margin-left:1.5rem;%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Cdiv%20id=%5C%22undoDeleteLastMessageCtn%5C%22%20style=%5C%22display:none;%20position:absolute;%20text-align:center;%20width:100%25;%20font-size:80%25;%20top:0;%20height:0px;%5C%22%3E%3Cdiv%20style=%5C%22position:absolute;%20bottom:0.25rem;%20text-align:center;%20width:100%25;%5C%22%3E%3Cbutton%20style=%5C%22width:max-content;%5C%22%20onclick=%5C%22undoDeleteLastMessage();%5C%22%3E%E2%86%A9%EF%B8%8F%20undo%3C/button%3E%3C/div%3E%3C/div%3E%5Cn%20%20%20%20%20%20%20%20%3Cbutton%20id=%5C%22deleteLastMessageBtn%5C%22%20onclick=%5C%22deleteLastMessage();%20localStorage.chatLogs=chatLogsEl.value;%20chatLogsDeleteBtn.dataset.mode='delete';%5C%22%20style=%5C%22font-size:75%25;%20min-width:3rem;%5C%22%20data-short-content=%5C%22%F0%9F%97%91%EF%B8%8F%5C%22%3E%F0%9F%97%91%EF%B8%8F%20delete%20last%3C/button%3E%5Cn%20%20%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%3Cscript%3E%5Cn%20%20%20%20%20%20updateLastMessageButtonsDisplayIfNeeded();%5Cn%20%20%20%20%3C/script%3E%5Cn%20%20%3C/div%3E%5Cn%20%20%5Cn%20%20%5Cn%20%20%3Cdiv%20style=%5C%22position:relative;%20width:100%25;%5C%22%3E%5Cn%20%20%20%20%3Ctextarea%20id=%5C%22inputEl%5C%22%20tabindex=%5C%221%5C%22%20placeholder=%5C%22Write%20a%20message%20here%20and%20click%20send,%20or%20just%20click%20send%20to%20get%20the%20AI%20to%20generate%20the%20next%20message%20for%20you.%20You%20can%20also%20directly%20edit%20the%20chat%20log%20text%20above.%5C%22%20style=%5C%22width:100%25;%20height:85px;%20margin-top:0.5rem;%20resize:vertical;%20display:block;%20font-size:85%25;%5C%22%20onkeydown=%5C%22if(event.which%20===%2013)%20%7B%20event.preventDefault();%20handleSendButtonClick(%7Bmode:'normal'%7D);%20%7D%5C%22%20oninput=%5C%22localStorage.input=this.value;%20updateVisibilityOfReplyButtonsAndSelectors();%5C%22%3E%3C/textarea%3E%5Cn%20%20%20%20%3Cdiv%20style=%5C%22position:absolute;%20bottom:0.5rem;%20width:100%25;%20height:0;%5C%22%3E%5Cn%20%20%20%20%20%20%3Cdiv%20oninput=%5C%22if(!localStorage.knowsWhatAutoImproveFeatureDoes)%20%7B%20alert(this.title);%20localStorage.knowsWhatAutoImproveFeatureDoes='1';%20%7D%5C%22%20title=%5C%22This%20'auto-improve'%20feature%20allows%20you%20write%20a%20very%20short/simple%20message%20(like%20'pick%20up%20the%20apple')%20and%20the%20AI%20will%20expand%20that%20into%20a%20nicely-written%20message%20for%20you.%5C%22%20style=%5C%22display:flex;%20align-items:center;%20border-radius:3px;%20border:1px%20solid%20grey;%20width:min-content;%20background:var(--box-color);%20padding:0.125rem;%20position:absolute;%20bottom:0;%20right:0.5rem;%20font-size:80%25;%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Cinput%20id=%5C%22autoImproveCheckboxEl%5C%22%20type=%5C%22checkbox%5C%22%20style=%5C%22cursor:pointer;%5C%22%20onclick=%5C%22setTimeout(updateVisibilityOfReplyButtonsAndSelectors,%2010)%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Cspan%20style=%5C%22margin-left:0.25rem;%20width:max-content;%20cursor:pointer;%5C%22%20onclick=%5C%22autoImproveCheckboxEl.click();%5C%22%3Eauto-improve%3C/span%3E%5Cn%20%20%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%3C/div%3E%5Cn%20%20%3C/div%3E%5Cn%20%20%3Cdiv%20style=%5C%22display:flex;%20flex-direction:column;%20margin-top:0.5rem;%20align-items:center;%5C%22%3E%5Cn%20%20%20%20%3Cdiv%20style=%5C%22display:flex;margin-bottom:0.5rem;align-items:%20center;%5C%22%3E%5Cn%20%20%20%20%20%20%3Cbutton%20id=%5C%22sendMessageBtn%5C%22%20tabindex=%5C%221%5C%22%20onclick=%5C%22handleSendButtonClick(%7Bmode:'normal'%7D);%20chatLogsDeleteBtn.dataset.mode='delete';%5C%22%20style=%5C%22display:flex;%20font-weight:bold;%20font-size:110%25;%5C%22%3E%F0%9F%93%A8%20send%20message%3C/button%3E%5Cn%20%20%20%20%20%20%3Cdiv%20id=%5C%22sendAsCharacterCtn%5C%22%20style=%5C%22display:none;%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Cspan%20style=%5C%22padding:0%200.25rem;%20display:flex;%20align-items:center;%20font-size:80%25;%20opacity:0.7;%5C%22%3Eas%3C/span%3E%5Cn%20%20%20%20%20%20%20%20%3Cselect%20id=%5C%22sendAsCharacterSelectEl%5C%22%20style=%5C%22height:min-content;%20font-size:80%25;%20max-width:90px;%5C%22%20onchange=%5C%22if(this.value%20===%20'~~~NEW_CHAR~~~')%20%7B%20let%20name%20=%20prompt(%60Enter%20the%20new%20character's%20name:%60);%20if(name%20===%20null)%20%7B%20this.value=this.options%5B0%5D.value;%20%7D%20else%20if(name.trim())%20%7B%20let%20newOption%20=%20document.createElement('option');%20newOption.textContent=name;%20this.insertBefore(newOption,%20this.options%5Bthis.selectedIndex%5D);%20this.value=name;%20%7D%20%7D%5C%22%3E%3C/select%3E%5Cn%20%20%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%3Cdiv%20id=%5C%22autoRespondCtn%5C%22%20style=%5C%22display:flex;%20align-items:center;%20justify-content:center;%20font-size:80%25;%20margin-bottom:0.5rem;%20border:1px%20solid%20grey;%20padding:0.125rem;%20border-radius:3px;%5C%22%3E%5Cn%20%20%20%20%20%20%3Cinput%20id=%5C%22autoRespondCheckboxEl%5C%22%20type=%5C%22checkbox%5C%22%20style=%5C%22cursor:pointer;%5C%22%20checked%20onchange=%5C%22localStorage.user_autoRespond=this.checked%7C%7C'';%5C%22%3E%20%3Cspan%20style=%5C%22opacity:0.7;%20margin-left:0.25rem;%20cursor:pointer;%20user-select:none;%5C%22%20onclick=%5C%22autoRespondCheckboxEl.checked=!autoRespondCheckboxEl.checked;%5C%22%3Eauto-respond%3C/span%3E%5Cn%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%3Cscript%3Eif(localStorage.user_autoResponder)%20autoRespondCheckboxEl.checked%20=%20!!localStorage.user_autoResponder;%3C/script%3E%5Cn%20%20%20%20%3Cdiv%20id=%5C%22quickReplyButtonsCtn%5C%22%20style=%5C%22display:flex;%20gap:0.5rem;%20flex-wrap:wrap;%20justify-content:center;%5C%22%3E%3C/div%3E%5Cn%20%20%20%20%3Cdiv%20id=%5C%22futureSuggestionsCtn%5C%22%20style=%5C%22display:none;%20gap:0.5rem;%20flex-wrap:wrap;%20justify-content:center;%5C%22%3E%3C/div%3E%5Cn%20%20%3C/div%3E%5Cn%20%20%5Cn%20%20%3Cdiv%20style=%5C%22position:relative;%20width:100%25;%20margin-top:1rem;%5C%22%3E%5Cn%20%20%20%20%3Ctextarea%20id=%5C%22writingInstructionsEl%5C%22%20placeholder=%5C%22(Optional)%20Brief%20writing%20instructions%20for%20the%20AI%20-%20e.g.%20writing%20style,%20what%20should%20happen%20next,%20message%20length,%20general%20reminders,%20things%20to%20avoid,%20etc.%5C%22%20style=%5C%22width:100%25;%20height:80px;%20resize:vertical;%20font-size:85%25;%20display:block;%5C%22%20oninput=%5C%22localStorage.writingInstructions=this.value;%20writingInstructionsDeleteBtn.dataset.mode='delete';%20writingInstructionsDeleteBtn.style.display='';%5C%22%20onchange=%5C%22this.value=this.value.replace(/%5C%5Cn+/g,%20'%20')%5C%22%20onkeydown=%5C%22if(event.keyCode%20==%2013)%20%7B%20event.preventDefault();%20%7D%5C%22%3E%3C/textarea%3E%5Cn%20%20%20%20%3Cscript%3Eif(window.innerWidth%20%3E%20600)%20writingInstructionsEl.placeholder%20+=%20%5C%22%20Keep%20this%20pretty%20short%20and%20'to%20the%20point'.%20Use%20the%20scenario/lore%20box%20for%20longer%20stuff.%5C%22%3C/script%3E%5Cn%20%20%20%20%3Cbutton%20id=%5C%22writingInstructionsDeleteBtn%5C%22%20data-mode=%5C%22delete%5C%22%20onclick=%5C%22if(this.dataset.mode==='delete')%20%7B%20window.deletedWritingInstructions=writingInstructionsEl.value;%20writingInstructionsEl.value='';%20this.dataset.mode='undo';%20%7D%20else%20%7B%20writingInstructionsEl.value=window.deletedWritingInstructions;%20this.dataset.mode='delete';%20%7D;%20localStorage.writingInstructions=writingInstructionsEl.value;%5C%22%20style=%5C%22position:absolute;%20top:-0.75rem;%20right:0.5rem;%20font-size:60%25;%20display:none;%5C%22%3E%3C/button%3E%5Cn%20%20%20%20%3Cdiv%20style=%5C%22font-size:75%25;%20opacity:0.7;%20margin-top:0.125rem;%5C%22%3E(remember%20to%20keep%20the%20%5C%22what%20happens%20next%5C%22%20part%20up-to-date%20if%20you%20include%20that%20in%20the%20above%20instructions)%3C/div%3E%5Cn%20%20%20%20%3Cstyle%3E%5Cn%20%20%20%20%20%20#writingInstructionsDeleteBtn%5Bdata-mode='delete'%5D:before%20%7B%20content:'%F0%9F%97%91%EF%B8%8F%20delete';%20%7D%20%5Cn%20%20%20%20%20%20#writingInstructionsDeleteBtn%5Bdata-mode='undo'%5D:before%20%7B%20content:'%E2%86%A9%EF%B8%8F%20undo';%20%7D%5Cn%20%20%20%20%3C/style%3E%5Cn%20%20%3C/div%3E%5Cn%20%20%5Cn%20%20%3Cdiv%20style=%5C%22margin-top:3rem;%5C%22%3E%5Cn%20%20%20%20%3Cbutton%20onclick=%5C%22saveChatDataToUsersDevice()%5C%22%3E%F0%9F%92%BE%20save%20this%20chat%3C/button%3E%5Cn%20%20%20%20%3Cbutton%20onclick=%5C%22loadChatDataFromUsersDevice()%5C%22%3E%F0%9F%93%81%20load%20a%20chat%3C/button%3E%5Cn%20%20%3C/div%3E%5Cn%20%20%5Cn%20%20%3Cdiv%20style=%5C%22margin-top:1rem;%5C%22%3E%5Cn%20%20%20%20%3Cbutton%20id=%5C%22shareChatBtn%5C%22%20onclick=%5C%22generateShareLinkForChat()%5C%22%3E%F0%9F%94%97%20share%20this%20chat%3C/button%3E%5Cn%20%20%20%20%3Cdiv%20id=%5C%22shareLinkCtn%5C%22%20style=%5C%22display:none;%20margin-top:0.5rem;%5C%22%3E%5Cn%20%20%20%20%20%20%3Cinput%20style=%5C%22width:300px;%5C%22%20id=%5C%22shareChatLinkInputEl%5C%22%20disabled%3E%20%3Cbutton%20style=%5C%22min-width:80px;%5C%22%20onclick=%5C%22navigator.clipboard.writeText(shareChatLinkInputEl.value).then(r%20=%3E%20this.innerHTML='%E2%9C%85');%20setTimeout(()%20=%3E%20this.innerHTML='copy%20link',%202000);%5C%22%3Ecopy%20link%3C/button%3E%5Cn%20%20%20%20%20%20%3Cdiv%20style=%5C%22font-size:70%25;%20opacity:0.7;%5C%22%3E(this%20link%20contains%20a%20snapshot%20of%20the%20chat%20data%20at%20the%20time%20the%20link%20was%20generated)%3C/div%3E%5Cn%20%20%20%20%3C/div%3E%5Cn%20%20%3C/div%3E%5Cn%3C/div%3E%5Cn%5Cn%5Cn%3Cscript%3E%5Cn%20%20%20%20function%20chatDataChangedHandler()%20%7B%5Cn%20%20%20%20%20%20shareChatBtn.style.display%20=%20%5C%22%5C%22;%5Cn%20%20%20%20%20%20shareLinkCtn.style.display%20=%20%5C%22none%5C%22;%5Cn%20%20%20%20%7D%5Cn%20%20%20%20botNameEl.addEventListener(%5C%22keydown%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20userNameEl.addEventListener(%5C%22keydown%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20botDescriptionEl.addEventListener(%5C%22keydown%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20userDescriptionEl.addEventListener(%5C%22keydown%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20scenarioEl.addEventListener(%5C%22keydown%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20chatLogsEl.addEventListener(%5C%22keydown%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20writingInstructionsEl.addEventListener(%5C%22keydown%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20%5Cn%20%20%20%20sendMessageBtn.addEventListener(%5C%22click%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20writingInstructionsDeleteBtn.addEventListener(%5C%22click%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20regenPrevButton.addEventListener(%5C%22click%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20regenMessageBtn.addEventListener(%5C%22click%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20regenNextButton.addEventListener(%5C%22click%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20undoRegenMessageCtn.addEventListener(%5C%22click%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20scenarioDeleteBtn.addEventListener(%5C%22click%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20generateScenarioBtn.addEventListener(%5C%22click%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20generateUserDescriptionBtn.addEventListener(%5C%22click%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20userDescriptionDeleteBtn.addEventListener(%5C%22click%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20generateBotDescriptionBtn.addEventListener(%5C%22click%5C%22,%20chatDataChangedHandler);%5Cn%20%20%20%20botDescriptionDeleteBtn.addEventListener(%5C%22click%5C%22,%20chatDataChangedHandler);%5Cn%20%20%3C/script%3E%5Cn%5Cn%3Cscript%3E%5Cn%20%20function%20trackCaretPosition(textArea,%20callback,%20opts=%7B%7D)%20%7B%5Cn%20%20%20%20let%20copy%20=%20createCopy(textArea);%5Cn%20%20%20%20copy.style.visibility%20=%20'hidden';%5Cn%20%20%20%20//%20copy.style.pointerEvents%20=%20'none';%5Cn%20%20%20%20//%20copy.style.color%20=%20'red';%5Cn%20%20%20%20//%20copy.style.opacity%20=%20'0.3';%5Cn%5Cn%20%20%20%20function%20updateShadowPositionAndSize()%20%7B%5Cn%20%20%20%20%20%20let%20rect%20=%20textArea.getBoundingClientRect();%5Cn%20%20%20%20%20%20let%20scrollLeft%20=%20window.pageXOffset%20%7C%7C%20document.documentElement.scrollLeft;%5Cn%20%20%20%20%20%20let%20scrollTop%20=%20window.pageYOffset%20%7C%7C%20document.documentElement.scrollTop;%5Cn%20%20%20%20%20%20copy.style.left%20=%20%60$%7Brect.left%20+%20scrollLeft%7Dpx%60;%5Cn%20%20%20%20%20%20copy.style.top%20=%20%60$%7Brect.top%20+%20scrollTop%7Dpx%60;%5Cn%20%20%20%20%20%20copy.style.width%20=%20%60$%7BtextArea.offsetWidth%7Dpx%60;%5Cn%20%20%20%20%20%20copy.style.height%20=%20%60$%7BtextArea.offsetHeight%7Dpx%60;%5Cn%20%20%20%20%20%20copy.scrollTop%20=%20textArea.scrollTop;%5Cn%20%20%20%20%7D%5Cn%5Cn%20%20%20%20function%20update()%20%7B%5Cn%20%20%20%20%20%20if(!document.activeElement%20===%20textArea)%20%7B%5Cn%20%20%20%20%20%20%20%20return;%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20if(opts.onlyComputePositionWhenAtEndOfText)%20%7B%20//%20this%20option%20is%20for%20performance%20optimization%5Cn%20%20%20%20%20%20%20%20let%20thereIsOnlyWhiteSpaceAfterCaret%20=%20/%5E%5C%5Cs*$/.test(textArea.value.slice(textArea.selectionStart));%5Cn%20%20%20%20%20%20%20%20if(!thereIsOnlyWhiteSpaceAfterCaret)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20callback(null);%5Cn%20%20%20%20%20%20%20%20%20%20return;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20let%20startTime;%5Cn%20%20%20%20%20%20if(window.performance?.now)%20startTime%20=%20performance.now();%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20updateShadowPositionAndSize();%5Cn%20%20%20%20%20%20const%20position%20=%20getCaretPosition(textArea,%20copy);%5Cn%20%20%20%20%20%20callback(position);%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20if(startTime)%20%7B%5Cn%20%20%20%20%20%20%20%20let%20timeTaken%20=%20performance.now()-startTime;%5Cn%20%20%20%20%20%20%20%20if(timeTaken%20%3E%2050)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20console.warn(%60Took%20$%7BtimeTaken%7Dms%20to%20track%20caret%20position%20for%20'continue'%20button.%60)%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D%5Cn%20%20%20%20%5Cn%20%20%20%20let%20debounceTimeoutLength%20=%20100;%5Cn%20%20%20%20if(textArea.value.length%20%3E%20100000)%20debounceTimeoutLength%20=%20400;%5Cn%20%20%20%20setInterval(()%20=%3E%20%7B%5Cn%20%20%20%20%20%20if(textArea.value.length%20%3E%20100000)%20debounceTimeoutLength%20=%20400;%5Cn%20%20%20%20%7D,%2010000);%5Cn%20%20%20%20let%20updateDebounceTimeout%20=%20null;%5Cn%20%20%20%20textArea.addEventListener('input',%20function()%20%7B%5Cn%20%20%20%20%20%20clearTimeout(updateDebounceTimeout);%5Cn%20%20%20%20%20%20updateDebounceTimeout%20=%20setTimeout(()%20=%3E%20update(),%20debounceTimeoutLength);%5Cn%20%20%20%20%7D);%5Cn%20%20%20%20textArea.addEventListener('click',%20function()%20%7B%5Cn%20%20%20%20%20%20clearTimeout(updateDebounceTimeout);%5Cn%20%20%20%20%20%20updateDebounceTimeout%20=%20setTimeout(()%20=%3E%20update(),%20debounceTimeoutLength);%5Cn%20%20%20%20%7D);%5Cn%20%20%20%20textArea.addEventListener('scroll',%20function()%20%7B%5Cn%20%20%20%20%20%20clearTimeout(updateDebounceTimeout);%5Cn%20%20%20%20%20%20updateDebounceTimeout%20=%20setTimeout(()%20=%3E%20update(),%20debounceTimeoutLength);%5Cn%20%20%20%20%7D);%5Cn%20%20%20%20textArea.addEventListener('keydown',%20function(e)%20%7B%5Cn%20%20%20%20%20%20if(%5B%5C%22ArrowRight%5C%22,%20%5C%22ArrowLeft%5C%22,%20%5C%22ArrowUp%5C%22,%20%5C%22ArrowDown%5C%22%5D.includes(e.key))%20%7B%5Cn%20%20%20%20%20%20%20%20clearTimeout(updateDebounceTimeout);%5Cn%20%20%20%20%20%20%20%20updateDebounceTimeout%20=%20setTimeout(()%20=%3E%20update(),%20debounceTimeoutLength);%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D);%5Cn%5Cn%20%20%20%20let%20resizeObserver%20=%20new%20ResizeObserver(()%20=%3E%20updateShadowPositionAndSize());%5Cn%20%20%20%20resizeObserver.observe(textArea);%5Cn%5Cn%20%20%20%20let%20mutationObserver%20=%20new%20MutationObserver(mutations%20=%3E%20%7B%5Cn%20%20%20%20%20%20for(const%20mutation%20of%20mutations)%20%7B%5Cn%20%20%20%20%20%20%20%20if(Array.from(mutation.removedNodes).includes(textArea))%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20copy.remove();%5Cn%20%20%20%20%20%20%20%20%20%20mutationObserver.disconnect();%5Cn%20%20%20%20%20%20%20%20%20%20resizeObserver.disconnect();%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D);%5Cn%20%20%20%20mutationObserver.observe(textArea.parentNode,%20%7B%20childList:%20true%20%7D);%5Cn%5Cn%20%20%20%20function%20createCopy(textArea)%20%7B%5Cn%20%20%20%20%20%20let%20copy%20=%20document.createElement('div');%5Cn%20%20%20%20%20%20let%20style%20=%20getComputedStyle(textArea);%5Cn%5Cn%20%20%20%20%20%20let%20propertiesToCopy%20=%20%5B'overflow-x',%20'overflow-y',%20'display',%20'font-family',%20'font-size',%20'font-weight',%20'word-wrap',%20'white-space',%20'padding-left',%20'padding-right',%20'padding-top',%20'padding-bottom',%20'border-left-width',%20'border-top-width',%20'border-right-width',%20'border-bottom-width',%20'border-style',%20'text-align'%5D;%5Cn%20%20%20%20%20%20propertiesToCopy.forEach(key%20=%3E%20copy.style%5Bkey%5D%20=%20style%5Bkey%5D);%5Cn%5Cn%20%20%20%20%20%20Object.assign(copy.style,%20%7B%5Cn%20%20%20%20%20%20%20%20position:%20'absolute',%5Cn%20%20%20%20%20%20%20%20left:%20%60$%7BtextArea.offsetLeft%7Dpx%60,%5Cn%20%20%20%20%20%20%20%20top:%20%60$%7BtextArea.offsetTop%7Dpx%60,%5Cn%20%20%20%20%20%20%7D);%5Cn%5Cn%20%20%20%20%20%20document.body.appendChild(copy);%5Cn%20%20%20%20%20%20return%20copy;%5Cn%20%20%20%20%7D%5Cn%5Cn%20%20%20%20function%20getCaretPosition(textArea,%20copy)%20%7B%5Cn%20%20%20%20%20%20let%20%7B%20selectionStart,%20selectionEnd%20%7D%20=%20textArea;%5Cn%20%20%20%20%20%20let%20value%20=%20textArea.value;%5Cn%20%20%20%20%20%20let%20phantomNewline%20=%20false;%5Cn%5Cn%20%20%20%20%20%20if(selectionStart%20===%20selectionEnd%20&&%20value%5BselectionStart%20-%201%5D%20===%20'%5C%5Cn')%20%7B%5Cn%20%20%20%20%20%20%20%20phantomNewline%20=%20true;%5Cn%20%20%20%20%20%20%7D%5Cn%5Cn%20%20%20%20%20%20copy.textContent%20=%20phantomNewline%20?%20value.substring(0,%20selectionStart)%20+%20'%20'%20+%20value.substring(selectionStart)%20:%20value;%5Cn%5Cn%20%20%20%20%20%20if(!copy.firstChild)%20%7B%5Cn%20%20%20%20%20%20%20%20let%20style%20=%20getComputedStyle(textArea);%5Cn%20%20%20%20%20%20%20%20return%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20x:%20textArea.offsetLeft%20+%20parseFloat(style.paddingLeft),%5Cn%20%20%20%20%20%20%20%20%20%20y:%20textArea.offsetTop%20+%20parseFloat(style.paddingTop),%5Cn%20%20%20%20%20%20%20%20%7D;%5Cn%20%20%20%20%20%20%7D%5Cn%5Cn%20%20%20%20%20%20let%20range%20=%20document.createRange();%5Cn%20%20%20%20%20%20range.setStart(copy.firstChild,%20phantomNewline%20?%20selectionStart%20+%201%20:%20selectionStart);%5Cn%20%20%20%20%20%20range.setEnd(copy.firstChild,%20phantomNewline%20?%20selectionEnd%20+%201%20:%20selectionEnd);%5Cn%5Cn%20%20%20%20%20%20const%20rect%20=%20range.getBoundingClientRect();%5Cn%20%20%20%20%20%20const%20scrollLeft%20=%20window.pageXOffset%20%7C%7C%20document.documentElement.scrollLeft;%5Cn%20%20%20%20%20%20const%20scrollTop%20=%20window.pageYOffset%20%7C%7C%20document.documentElement.scrollTop;%5Cn%5Cn%20%20%20%20%20%20return%20%7B%5Cn%20%20%20%20%20%20%20%20x:%20rect.left%20+%20scrollLeft,%20//%20-%20textArea.scrollLeft,%5Cn%20%20%20%20%20%20%20%20y:%20rect.top%20+%20scrollTop,%20//%20-%20textArea.scrollTop,%5Cn%20%20%20%20%20%20%7D;%5Cn%20%20%20%20%7D%5Cn%5Cn%20%20%7D%5Cn%5Cn%20%20if(typeof%20continueMessageBtn%20===%20%5C%22undefined%5C%22)%20%7B%20//%20%3C--%20just%20so,%20while%20generator%20is%20being%20edited,%20multiple%20buttons%20aren't%20created%5Cn%20%20%20%20let%20tmp%20=%20document.createElement(%5C%22div%5C%22);%5Cn%20%20%20%20tmp.innerHTML%20=%20%60%3Cbutton%20id=%5C%22continueMessageBtn%5C%22%20style=%5C%22position:absolute;%20cursor:pointer;%20font-size:65%25;%20display:none;%5C%22%3E%E2%96%B6%EF%B8%8F%3C/button%3E%60;%5Cn%20%20%20%20let%20btn%20=%20tmp.firstElementChild;%5Cn%20%20%20%20btn.onmousedown%20=%20function()%20%7B%5Cn%20%20%20%20%20%20handleSendButtonClick(%7Bmode:'continue'%7D);%5Cn%20%20%20%20%7D;%5Cn%20%20%20%20document.body.append(btn);%20//%20must%20be%20in%20the%20body,%20so%20it's%20position%20is%20relative%20to%20the%20body,%20and%20not%20e.g.%20the%20chatLogs%20container%20element%5Cn%20%20%7D%5Cn%20%20let%20chatLogsLineHeightPixels%20=%20getLineHeightInPixels(chatLogsEl);%5Cn%20%20chatLogsEl.addEventListener('keydown',%20function(e)%20%7B%5Cn%20%20%20%20continueMessageBtn.style.display%20=%20'none';%5Cn%20%20%7D);%5Cn%20%20trackCaretPosition(chatLogsEl,%20pos%20=%3E%20%7B%5Cn%20%20%20%20if(!pos)%20%7B%20//%20since%20we%20passed%20onlyComputePositionWhenAtEndOfText:true,%20we%20get%20updates%20when%20cursor%20moves,%20but%20only%20get%20position%20if%20at%20end%20of%20text%20(for%20performance%20reasons)%5Cn%20%20%20%20%20%20continueMessageBtn.style.display%20=%20'none';%5Cn%20%20%20%20%20%20return;%5Cn%20%20%20%20%7D%5Cn%20%20%20%20//%20console.log(pos.x,%20pos.y);%5Cn%20%20%20%20let%20thereIsOnlyWhiteSpaceAfterCaret%20=%20/%5E%5C%5Cs*$/.test(chatLogsEl.value.slice(chatLogsEl.selectionStart));%5Cn%20%20%20%20if(document.activeElement%20===%20chatLogsEl%20&&%20thereIsOnlyWhiteSpaceAfterCaret%20&&%20pageXYIsInsideElement(pos.x,%20pos.y,%20chatLogsEl))%20%7B%5Cn%20%20%20%20%20%20continueMessageBtn.style.display%20=%20'block';%5Cn%20%20%20%20%20%20let%20buttonHeight%20=%20continueMessageBtn.offsetHeight;%5Cn%20%20%20%20%20%20continueMessageBtn.style.left%20=%20%60$%7Bpos.x%20+%2010%7Dpx%60;%5Cn%20%20%20%20%20%20continueMessageBtn.style.top%20=%20%60$%7Bpos.y%20-%200.5*(buttonHeight-chatLogsLineHeightPixels)%7Dpx%60;%5Cn%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20continueMessageBtn.style.display%20=%20'none';%5Cn%20%20%20%20%7D%5Cn%20%20%7D,%20%7BonlyComputePositionWhenAtEndOfText:true%7D);%5Cn%20%20chatLogsEl.addEventListener('blur',%20()%20=%3E%20%7B%5Cn%20%20%20%20continueMessageBtn.style.display%20=%20'none';%5Cn%20%20%7D);%5Cn%20%20document.addEventListener('click',%20(event)%20=%3E%20%7B%5Cn%20%20%20%20if(event.target%20!==%20chatLogsEl)%20%7B%5Cn%20%20%20%20%20%20continueMessageBtn.style.display%20=%20'none';%20//%20not%20sure%20why%20this%20is%20required%20in%20Chrome%20Android%20(blur%20event%20handler%20should%20be%20enough)%5Cn%20%20%20%20%7D%5Cn%20%20%7D);%5Cn%5Cn%20%20function%20getLineHeightInPixels(element)%20%7B%5Cn%20%20%20%20const%20style%20=%20window.getComputedStyle(element);%5Cn%20%20%20%20let%20lineHeight%20=%20style.lineHeight;%5Cn%20%20%20%20if(lineHeight%20===%20'normal')%20%7B%20//%20Normal%20line%20heights%20are%20usually%201.2%20times%20the%20font%20size%5Cn%20%20%20%20%20%20const%20fontSize%20=%20parseFloat(style.fontSize);%5Cn%20%20%20%20%20%20lineHeight%20=%20fontSize%20*%201.2;%5Cn%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20lineHeight%20=%20parseFloat(lineHeight);%5Cn%20%20%20%20%7D%5Cn%20%20%20%20return%20lineHeight;%5Cn%20%20%7D%5Cn%20%20function%20pageXYIsInsideElement(x,%20y,%20element)%20%7B%5Cn%20%20%20%20const%20%7B%20left,%20top,%20right,%20bottom%20%7D%20=%20element.getBoundingClientRect();%5Cn%20%20%20%20return%20x%20%3E=%20left%20+%20window.pageXOffset%20&&%20x%20%3C=%20right%20+%20window.pageXOffset%20&&%20y%20%3E=%20top%20+%20window.pageYOffset%20&&%20y%20%3C=%20bottom%20+%20window.pageYOffset;%5Cn%20%20%7D%5Cn%3C/script%3E%5Cn%5Cn%3Cscript%3E%5Cn%20%20(async%20function()%20%7B%5Cn%20%20%20%20let%20hash%20=%20window.location.hash.slice(1);%5Cn%20%20%20%20if(hash%20&&%20hash.startsWith(%5C%22data=%5C%22))%20%7B%5Cn%20%20%20%20%20%20let%20result%20=%20await%20loadDataFromUrlHash();%5Cn%20%20%20%20%20%20if(!result.success)%20%7B%5Cn%20%20%20%20%20%20%20%20loadChatDataFromLocalStorage();%20%20%20%20%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20loadChatDataFromLocalStorage();%20%20%20%20%5Cn%20%20%20%20%7D%5Cn%20%20%5Cn%20%20%20%20updateDeleteButtonVisibility();%5Cn%20%20%20%20updateCharacterNameViews();%5Cn%20%20%20%20sendAsCharacterCtn.style.display%20=%20inputEl.value.trim()%20?%20'flex'%20:%20'none';%5Cn%20%20%20%20update();%5Cn%20%20%20%20updateVisibilityOfReplyButtonsAndSelectors();%5Cn%5Cn%20%20%20%20chatLogsEl.scrollTop%20=%20999999999;%20//%20scroll%20to%20the%20bottom%20of%20the%20chat%20logs%5Cn%20%20%20%20setTimeout(()%20=%3E%20%7B%20chatLogsEl.scrollTop%20=%20999999999;%20%7D,%203000);%20//%20%3C--%20because%20ad%20load%20on%20mobile%20causes%20screen%20height%20to%20change%20which%20causes%20text%20area%20height%20to%20change.%20not%20full-proof,%20but%20it'll%20do%20for%20now%5Cn%20%20%7D)();%5Cn%3C/script%3E%5Cn%5Cn%3Cscript%3E%5Cn%20%20try%20%7B%5Cn%20%20%20%20let%20isSafari%20=%20navigator.vendor%20&&%20navigator.vendor.indexOf('Apple')%20%3E%20-1%20&&%20navigator.userAgent%20&&%20navigator.userAgent.indexOf('CriOS')%20==%20-1%20&&%20navigator.userAgent.indexOf('FxiOS')%20==%20-1;%5Cn%20%20%20%20let%20isTouchScreen%20=%20window.matchMedia(%5C%22(pointer:%20coarse)%5C%22).matches;%5Cn%20%20%20%20if(isSafari%20&&%20window.innerWidth%20%3C%20800%20&&%20isTouchScreen)%20%7B%5Cn%20%20%20%20%20%20let%20viewportMetaEl%20=%20document.querySelector(%5C%22%5Bname=viewport%5D%5C%22);%5Cn%20%20%20%20%20%20if(!viewportMetaEl.getAttribute(%5C%22content%5C%22).includes(%5C%22maximum-scale%5C%22))%20%7B%5Cn%20%20%20%20%20%20%20%20viewportMetaEl.setAttribute(%5C%22content%5C%22,%20viewportMetaEl.getAttribute(%5C%22content%5C%22)%20+%20%5C%22,%20maximum-scale=1%5C%22);%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20console.log(%5C%22Safari%20iOS%20detected.%20Added%20maximum-scale%20attribute%20to%20prevent%20zooming:%5C%22,%20viewportMetaEl.getAttribute(%5C%22content%5C%22));%5Cn%20%20%20%20%7D%5Cn%20%20%7D%20catch(e)%20%7B%5Cn%20%20%20%20console.error(e);%5Cn%20%20%7D%5Cn%3C/script%3E%5Cn%5Cn%3Cp%20id=%5C%22askForRatingsNoticeEl%5C%22%20style=%5C%22display:none;%20font-size:80%25;%20max-width:600px;%20margin:1rem%20auto;%20text-align:justify;%5C%22%3EIf%20an%20AI%20response%20%3Cb%3Emakes%20you%20happy%20%F0%9F%91%8D%3C/b%3E%20or%20%3Cb%3Emakes%20you%20bored%20or%20makes%20mistakes%20%F0%9F%91%8E%3C/b%3E,%20please%20rate%20it!%20Each%20vote%20helps%20to%20improve%20the%20AI.%20There's%20no%20need%20to%20vote%20on%20%5C%22average%5C%22%20responses.%3C/p%3E%5Cn%3Cp%20style=%5C%22font-size:80%25;%20max-width:600px;%20margin:1rem%20auto;%20text-align:justify;%5C%22%3EThis%20page%20uses%20your%20browser's%20'localStorage'%20to%20%3Cb%3Eremember%20your%20messages/descriptions/etc.%3C/b%3E%20even%20after%20you%20refresh%20to%20page.%20To%20remove%20the%20data,%20use%20the%20delete%20buttons,%20or%20just%20manually%20select%20the%20text%20in%20the%20text%20boxes%20and%20delete%20it.%3C/p%3E%5Cn%3Chr%3E%20%5Cn%3Cp%3EHave%20questions%20about%20this%20demo,%20or%20the%20%3Ca%20href=%5C%22/ai-text-plugin%5C%22%20target=%5C%22_blank%5C%22%3EAI%20Text%20Plugin%3C/a%3E?%20Ask%20them%20in%20the%20comments:%3C/p%3E%5Cn%5Cn%3Cdiv%20id=%5C%22commentsCtn%5C%22%3E%3C/div%3E%5Cn%3Cp%20style=%5C%22font-size:80%25;%20max-width:700px;%20width:95%25;%20margin:0%20auto;%20text-align:justify;%5C%22%3E%3Cb%20style=%5C%22color:red;%5C%22%3ENote%3C/b%3E:%20I've%20decided%20to%20hide%20the%20comments%20by%20default%20for%20now%20because%20I%20noticed%20that%20there%20were%20some%20trolls%20and%20I%20don't%20have%20time%20to%20moderate%20right%20now.%20I'll%20try%20to%20sweep%20through%20and%20permaban%20spammers/trolls/bullies/racists/homophobes/etc.%20as%20often%20as%20possible,%20but%20in%20the%20meantime%20I%20suggest%20that%20you%20%3Cb%3Eimmediately%20block%20trolls,%20bullies,%20and%20shady%20people.%20Do%20not%20talk%20to%20them.%3C/b%3E%20Please%20encourage%20other%20chat%20participants%20to%20block%20them%20instead%20of%20engaging%20with%20them.%3C/p%3E%5Cn%3Cp%20style=%5C%22font-size:80%25;%20max-width:700px;%20width:95%25;%20margin:0.5rem%20auto;%20text-align:justify;%5C%22%3E%3Cb%3ENote:%3C/b%3E%20If%20you%20are%20reporting%20a%20bug/issue%20in%20the%20comments,%20please%20give%20as%20much%20detail%20as%20you%20can.%20For%20example,%20if%20it's%20not%20working,%20then%20was%20it%20working%20originally?%20If%20it%20never%20worked,%20what%20browser%20are%20you%20using?%20And%20on%20what%20operating%20system?%20E.g.%20%5C%22Chrome%20on%20Windows%2010%5C%22%20or%20%5C%22Chrome%20on%20Chromebook%5C%22.%20If%20it%20was%20originally%20working,%20but%20then%20stopped%20working%20suddenly,%20then%20try%20deleting%20some%20messages%20to%20see%20if%20it%20has%20something%20to%20do%20with%20the%20length%20of%20the%20chat.%20Also%20try%20refreshing%20the%20page,%20and%20let%20me%20know%20if%20that%20didn't%20help.%20Is%20the%20%5C%22Loading...%5C%22%20thing%20in%20the%20top-right%20corner%20of%20the%20page?%20The%20more%20details%20you%20add,%20the%20quicker%20I%20can%20fix%20it%20:)%20Thank%20you%20to%20the%20pioneers%20who%20are%20testing%20this!%20There'll%20likely%20be%20a%20few%20annoying%20issues%20while%20this%20plugin%20is%20new.%3C/p%3E%5Cn%3Cbr%3E%5Cn%5Cn%3C!--%20COMMENTS%20STUFF%20--%3E%5Cn%3Cscript%3E%5Cn%20%20function%20createCommentsSectionHtml()%20%7B%5Cn%20%20%20%20let%20startVisible%20=%20false;%5Cn%20%20%20%20if(window.commentsEl%20&&%20window.commentsEl.style.display%20!==%20'none')%20startVisible%20=%20true;%5Cn%20%20%20%20commentsCtn.innerHTML%20=%20%5C%22%5C%22;%20//%20must%20delete%20existing%20comments%20section%20first%20because%20comments%20plugin%20has%20code%20which%20cause%20it%20to%20not%20output%20any%20HTML%20if%20that%20comments%20section%20already%20exists%20on%20the%20page%5Cn%20%20%20%20let%20commentsPluginHtml%20=%20root.commentsPlugin(%7BbannedUsers:root.commentsBannedUsers,%20width:%5C%22min(750px,%20100%25)%5C%22,%20height:%5C%22min(70vh,%20600px)%5C%22,%20forceColorScheme:localStorage.forceColorScheme%20%7C%7C%20null%7D);%5Cn%20%20%20%20commentsCtn.innerHTML%20=%20%60%5Cn%20%20%20%20%20%20%3Cp%3E%3Cbutton%20onclick=%5C%22if(commentsEl.style.display%20==%20'none')%20%7B%20commentsEl.style.display='';%20this.textContent='hide%20comments';%20%7D%20else%20%7B%20commentsEl.style.display='none';%20this.textContent='%F0%9F%92%AC%20show%20comments';%20%7D%5C%22%3E$%7BstartVisible%20?%20%5C%22hide%20comments%5C%22%20:%20%5C%22%F0%9F%92%AC%20show%20comments%5C%22%7D%3C/button%3E%3C/p%3E%5Cn%20%20%20%20%20%20%3Cp%20id=%5C%22commentsEl%5C%22%20style=%5C%22$%7BstartVisible%20?%20%5C%22%5C%22%20:%20%5C%22display:none;%5C%22%7D%5C%22%3E%5Cn%20%20%20%20%20%20%20%20$%7BcommentsPluginHtml%7D%5Cn%20%20%20%20%20%20%3C/p%3E%5Cn%20%20%20%20%60;%5Cn%20%20%7D%5Cn%20%20createCommentsSectionHtml();%5Cn%3C/script%3E%5Cn%5Cn%3C!--%20DARK%20MODE%20STUFF%20--%3E%5Cn%3Cdiv%20style=%5C%22position:fixed;%20bottom:0.5rem;%20left:0.5rem;%20z-index:10;%5C%22%3E%5Cn%20%20%3Cbutton%20id=%5C%22darkModeBtn%5C%22%20style=%5C%22cursor:pointer;%5C%22%20onclick=%5C%22window.toggleManualDarkMode();%20createCommentsSectionHtml();%5C%22%3E%F0%9F%8C%83%3C/button%3E%5Cn%20%20%3Cdiv%20style=%5C%22display:inline-block;%5C%22%3E%5BfullscreenButton(%5C%22%E2%87%B1%5C%22,%20%5C%22%E2%87%B2%5C%22)%5D%3C/div%3E%5Cn%3C/div%3E%5Cn%3Cscript%3E%5Cn%20%20function%20toggleManualDarkMode()%20%7B%5Cn%20%20%20%20let%20newColorScheme%20=%20(getCurrentColorScheme()%20===%20%5C%22dark%5C%22%20?%20%5C%22light%5C%22%20:%20%5C%22dark%5C%22);%5Cn%20%20%20%20localStorage.forceColorScheme%20=%20newColorScheme;%5Cn%20%20%20%20setColorScheme(newColorScheme);%5Cn%20%20%20%20//%20if%20chosen%20mode%20matches%20current%20OS%20default,%20we%20remove%20manual%20%5C%22forced%5C%22%20mode:%5Cn%20%20%20%20let%20systemColorScheme%20=%20window.matchMedia%20&&%20window.matchMedia('(prefers-color-scheme:%20dark)').matches%20?%20%5C%22dark%5C%22%20:%20%5C%22light%5C%22;%5Cn%20%20%20%20if(systemColorScheme%20===%20newColorScheme)%20%7B%5Cn%20%20%20%20%20%20localStorage.removeItem(%5C%22forceColorScheme%5C%22);%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%20%20function%20getCurrentColorScheme()%20%7B%5Cn%20%20%20%20if(localStorage.forceColorScheme%20!==%20undefined)%20%7B%5Cn%20%20%20%20%20%20return%20localStorage.forceColorScheme;%5Cn%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20return%20window.matchMedia%20&&%20window.matchMedia('(prefers-color-scheme:%20dark)').matches%20?%20%5C%22dark%5C%22%20:%20%5C%22light%5C%22;%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%20%20function%20setColorScheme(scheme)%20%7B%5Cn%20%20%20%20if(scheme%20!==%20%5C%22dark%5C%22%20&&%20scheme%20!==%20%5C%22light%5C%22)%20throw%20new%20Error(%5C%22scheme%20should%20be%20'light'%20or%20'dark'%5C%22);%5Cn%20%20%20%20document.querySelector(%5C%22#darkModeBtn%5C%22).textContent%20=%20(scheme%20===%20%5C%22dark%5C%22%20?%20%5C%22%F0%9F%8C%84%5C%22%20:%20%5C%22%F0%9F%8C%83%5C%22);%5Cn%20%20%20%20if(scheme%20===%20%5C%22dark%5C%22)%20%7B%5Cn%20%20%20%20%20%20document.documentElement.style.colorScheme%20=%20%5C%22dark%5C%22;%5Cn%20%20%20%20%20%20document.body.style.color%20=%20%5C%22#d8d4cf%5C%22;%5Cn%20%20%20%20%20%20document.body.style.backgroundColor%20=%20%5C%22#131516%5C%22;%5Cn%20%20%20%20%20%20document.documentElement.style.setProperty('--box-color',%20'#2a2a2a');%5Cn%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20document.documentElement.style.colorScheme%20=%20%5C%22light%5C%22;%5Cn%20%20%20%20%20%20document.body.style.color%20=%20%5C%22black%5C%22;%5Cn%20%20%20%20%20%20document.body.style.backgroundColor%20=%20%5C%22white%5C%22;%5Cn%20%20%20%20%20%20document.documentElement.style.setProperty('--box-color',%20'#ebebeb');%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%20%20//%20during%20page%20load,%20set%20the%20chosen%20mode%20based%20on%20localStorage%20value%20if%20it%20exists:%5Cn%20%20if(localStorage.forceColorScheme%20!==%20undefined)%20%7B%5Cn%20%20%20%20setColorScheme(localStorage.forceColorScheme);%5Cn%20%20%7D%20else%20%7B%5Cn%20%20%20%20//%20user%20has%20not%20manually%20overwritten,%20so%20we%20use%20OS%20default:%5Cn%20%20%20%20let%20systemIsInDarkMode%20=%20!!(window.matchMedia%20&&%20window.matchMedia('(prefers-color-scheme:%20dark)').matches);%5Cn%20%20%20%20setColorScheme(systemIsInDarkMode%20?%20%5C%22dark%5C%22%20:%20%5C%22light%5C%22);%5Cn%20%20%7D%5Cn%3C/script%3E%5Cn%20%5Cn%3C!--%20FEEDBACK%20STUFF%20--%3E%5Cn%3Cdiv%20style=%5C%22position:fixed;%20bottom:0.5rem;%20right:0.5rem;%20text-align:right;%20z-index:100;%5C%22%3E%5Cn%20%20%3Cdiv%20id=%5C%22feedbackCommentsCtn%5C%22%3E%3C/div%3E%5Cn%20%20%3Cbutton%20id=%5C%22feedbackBtn893745ykfuhd%5C%22%20onclick=%5C%22if(feedbackCommentsCtn.innerHTML.length%20===%200)%20%7B%20feedbackCommentsCtn.innerHTML=generateFeedbackCommentsHtml();%20this.innerHTML='%E2%9C%96%20close';%20%7D%20else%20%7B%20%20feedbackCommentsCtn.innerHTML='';%20%20this.innerHTML='%F0%9F%97%A8%EF%B8%8F%20feedback';%20%7D%5C%22%3E%F0%9F%97%A8%EF%B8%8F%20feedback%3C/button%3E%5Cn%3C/div%3E%5Cn%3Cscript%3E%5Cn%20%20function%20generateFeedbackCommentsHtml()%20%7B%5Cn%20%20%20%20let%20options%20=%20%7Bchannel:%5C%22feedback%5C%22,%20hideComments:location.hash.includes(%5C%22#showfeedback%5C%22)%20%7C%7C%20localStorage.showFeedback%20?%20false%20:%20true,%20height:location.hash.includes(%5C%22#showfeedback%5C%22)%20%7C%7C%20localStorage.showFeedback%20?%20500%20:%20120,%20commentPlaceholderText:%20%5C%22Share%20some%20feedback.%20Do%20not%20share%20personal%20info,%20feedback%20data%20is%20public.%5C%22,%20submitButtonText:%20%5C%22submit%20feedback%5C%22%7D;%5Cn%20%20%20%20if(localStorage.forceColorScheme)%20options.forceColorScheme%20=%20localStorage.forceColorScheme;%5Cn%20%20%20%20return%20root.commentsPlugin(options);%5Cn%20%20%7D%5Cn%3C/script%3E%5Cn%5Cn%3Cstyle%3E%5Cn%20%20button:disabled%20%7B%5Cn%20%20%20%20filter:%20grayscale(1)%20!important;%20/*%20since%20firefox%20doesn't%20seem%20to%20change%20emoji%20colors%20to%20indicate%20disabledness%20-%20only%20affects%20text%20*/%5Cn%20%20%7D%5Cn%3C/style%3E%5Cn%5Cn%22,%22imports%22:%5B%22ai-text-plugin%22,%22comments-plugin%22,%22fullscreen-button-plugin%22,%22upload-plugin%22%5D,%22canLink%22:true,%22isPrivate%22:true%7D</script>
        <script id="imported-generators" type="notjs">%5B%7B%22modelText%22:%22$output(inputData)%20=%3E%5Cn%20%20//%20console.log(%5C%22inputData:%5C%22,%20inputData);%5Cn%20%20if(!inputData)%20return%20%5C%22(Error:%20No%20input%20data%20given%20to%20the%20ai%20text%20plugin.)%5C%22;%5Cn%20%20if(inputData.instructions)%20return%20%5C%22(Error:%20Looks%20like%20you%20wrote%20'instructions%20=%20...'%20instead%20of%20'instruction%20=%20...'%20in%20your%20ai-text-plugin%20prompt%20data?)%5C%22;%5Cn%20%20%5Cn%20%20//%20REMEMBER:%20if%20you%20add%20more%20inputs,%20you%20need%20to%20also%20update%20%60window.__continueAiTextResponseClickHandler%60%5Cn%20%20let%20hideStartWith%20=%20inputData.hideStartWith;%20//%20get%20the%20'concrete'%20value%20in%20case%20it%20was%20dynamic%20like%20%60hideStartWith%20=%20%5B%20...%20%5D%60%20-%20this%20is%20important%20because%20the%20condition%20in%20the%20square%20brackets%20could%20change%20later%5Cn%20%20%5Cn%20%20let%20instruction%20=%20inputData.instruction;%5Cn%20%20if(typeof%20instruction%20===%20%5C%22function%5C%22)%20%7B%5Cn%20%20%20%20instruction%20=%20instruction(%7B%7D);%20//%20this%20is%20useful%20as%20a%20way%20to%20give%20a%20string%20that%20should%20not%20be%20evaluated%20-%20since%20e.g.%20instruction%20=%20%5BtextareaEl.value%5D%20will%20actually%20evaluate%20the%20text%20when%20we%20call%20inputData.instruction%5Cn%20%20%20%20if(typeof%20instruction%20!==%20%5C%22string%5C%22)%20instruction%20=%20instruction.toString();%5Cn%20%20%7D%20else%20if(instruction)%20%7B%5Cn%20%20%20%20if(typeof%20instruction%20!==%20%5C%22string%5C%22)%20%7B%5Cn%20%20%20%20%20%20instruction%20=%20instruction.evaluateItem;%5Cn%20%20%20%20%7D%5Cn%20%20%20%20instruction%20=%20instruction.toString();%5Cn%20%20%7D%20else%20%7B%5Cn%20%20%20%20instruction%20=%20%5C%22Write%20something.%5C%22;%20//%20default%20instruction%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20let%20startWith%20=%20inputData.startWith;%5Cn%20%20if(typeof%20startWith%20===%20%5C%22function%5C%22)%20%7B%5Cn%20%20%20%20startWith%20=%20startWith(%7B%7D);%20//%20this%20is%20useful%20as%20a%20way%20to%20give%20a%20string%20that%20should%20not%20be%20evaluated%20-%20since%20e.g.%20startWith%20=%20%5BtextareaEl.value%5D%20will%20actually%20evaluate%20the%20text%20when%20we%20call%20inputData.startWith%5Cn%20%20%20%20if(typeof%20startWith%20!==%20%5C%22string%5C%22)%20startWith%20=%20startWith.toString();%5Cn%20%20%7D%20else%20if(startWith)%20%7B%5Cn%20%20%20%20if(typeof%20startWith%20!==%20%5C%22string%5C%22)%20%7B%5Cn%20%20%20%20%20%20startWith%20=%20startWith.evaluateItem;%5Cn%20%20%20%20%7D%5Cn%20%20%20%20startWith%20=%20startWith.toString();%5Cn%20%20%20%20//%20We%20trim%20whitespace%20off%20the%20end%20due%20to%20the%20classic%20tokenizer%20problem%20(most%20word%20tokens%20start%20with%20a%20space%20as%20of%202023%20tokenizers).%5Cn%20%20%20%20//%20This%20of%20course%20does%20mean%20that%20you%20can't%20%5C%22force%5C%22%20the%20model%20to%20start%20with%20a%20space%20after%20a%20word,%20but%20it's%20worth%20that%20trade-off%20until%20we%20get%20models%20with%20better%20tokenizers.%5Cn%20%20%20%20startWith%20=%20startWith.replace(/%20+$/g,%20%5C%22%5C%22);%20//%20CAUTION:%20Don't%20trim%20newlines%20-%20only%20spaces.%20Because%20e.g.%20the%20story%20writer%20demo%20relies%20on%20being%20able%20to%20start%20with%202%20new%20lines%20before%20the%20paragraph%20that%20the%20AI%20is%20about%20to%20generate,%20since%20if%20the%20AI%20generates%20them,%20it'll%20trigger%20the%20stop%20sequence%20before%20it%20even%20gets%20to%20start%20writing%20the%20new%20paragraph%5Cn%20%20%7D%20else%20%7B%5Cn%20%20%20%20startWith%20=%20%5C%22%5C%22;%5Cn%20%20%7D%5Cn%5Cn%20%20let%20stopSequences%20=%20inputData.stopSequences;%5Cn%20%20if(typeof%20stopSequences%20===%20%5C%22function%5C%22)%20%7B%5Cn%20%20%20%20stopSequences%20=%20stopSequences(%7B%7D);%5Cn%20%20%7D%20else%20if(stopSequences)%20%7B%5Cn%20%20%20%20if(!Array.isArray(stopSequences))%20%7B%5Cn%20%20%20%20%20%20stopSequences%20=%20stopSequences.selectAll.map(n%20=%3E%20n.evaluateItem);%5Cn%20%20%20%20%7D%5Cn%20%20%7D%20else%20%7B%5Cn%20%20%20%20stopSequences%20=%20%5B%5D;%5Cn%20%20%7D%20%20%5Cn%20%20%5Cn%20%20//%20REMEMBER:%20if%20you%20add%20more%20inputs,%20you%20need%20to%20also%20update%20%60window.__continueAiTextResponseClickHandler%60%5Cn%20%20%5Cn%20%20let%20concreteInputs%20=%20%7BstartWith,%20instruction,%20stopSequences%7D;%20%20//%20%3C--%20CAUTION:%20the%20startWith%20property%20of%20this%20is%20changed%20after%20generation%20for%20the%20%60editAiTextResponseClickHandler%60%20feature%20-%20ctrl+f%20for%20%60concreteInputs.startWith%20=%60.%20Use%20%60originalConcreteInputs%60%20for%20original%20inputs.%5Cn%20%20const%20originalConcreteInputs%20=%20Object.freeze(JSON.parse(JSON.stringify(concreteInputs)));%5Cn%20%20let%20syncOutputObj;%5Cn%5Cn%20%20let%20placeholderEl;%5Cn%20%20let%20placeholderElDidInitiallyExist%20=%20false;%20//%20this%20is%20for%20keepalive%20stuff%20-%20so%20we%20can%20cancel%20a%20queued%20up%20generation%20if%20the%20placeholder%20is%20removed%5Cn%20%20let%20userStoppedGeneration%20=%20false;%5Cn%20%20%5Cn%20%20let%20textStreamController;%5Cn%20%20const%20textStream%20=%20new%20ReadableStream(%7B%5Cn%20%20%20%20start(c)%20%7B%5Cn%20%20%20%20%20%20textStreamController%20=%20c;%5Cn%20%20%20%20%7D%5Cn%20%20%7D);%5Cn%5Cn%20%20const%20serverOrigin%20=%20%5C%22https://text-generation.perchance.org%5C%22;%5Cn%20%20%5Cn%20%20const%20animatedLoadingSvg%20=%20%60%3Csvg%20style=%5C%22height:1rem;%20width:2rem;%20overflow:hidden;%20border-radius:3px;%20vertical-align:top;%20position:relative;%20top:0.07rem;%20margin-left:0.125rem;%5C%22%20height=%5C%221rem%5C%22%20width=%5C%222rem%5C%22%20class=%5C%22ai-text-plugin-loader%5C%22%3E%20%3Ccircle%20class=%5C%22ai-text-plugin-dot%5C%22%20cx=%5C%220.5rem%5C%22%20cy=%5C%220.5rem%5C%22%20r=%5C%223%5C%22%20style=%5C%22fill:grey;%5C%22%3E%3C/circle%3E%20%3Ccircle%20class=%5C%22ai-text-plugin-dot%5C%22%20cx=%5C%221rem%5C%22%20cy=%5C%220.5rem%5C%22%20r=%5C%223%5C%22%20style=%5C%22fill:grey;%5C%22%3E%3C/circle%3E%20%3Ccircle%20class=%5C%22ai-text-plugin-dot%5C%22%20cx=%5C%221.5rem%5C%22%20cy=%5C%220.5rem%5C%22%20r=%5C%223%5C%22%20style=%5C%22fill:grey;%5C%22%3E%3C/circle%3E%20%3C/svg%3E%60;%5Cn%20%20%5Cn%20%20let%20generatedText%20=%20%5C%22%5C%22;%5Cn%20%20let%20finishedGenerating%20=%20false;%5Cn%20%20let%20finishedGeneratingSuccessfully%20=%20false;%5Cn%20%20let%20thereWasAnErrorDuringGeneration%20=%20false;%5Cn%20%20%5Cn%20%20let%20onFinishPromiseResolver;%5Cn%20%20let%20onFinishPromiseRejecter;%5Cn%20%20let%20onFinishPromise%20=%20new%20Promise((resolve,%20reject)%20=%3E%20%7B%5Cn%20%20%20%20onFinishPromiseResolver%20=%20resolve;%5Cn%20%20%20%20onFinishPromiseRejecter%20=%20reject;%5Cn%20%20%7D);%5Cn%20%20%5Cn%20%20let%20iframe;%20%20%5Cn%20%20if(!window.__alreadyAddedAiTextPluginStuff8492739)%20%7B%5Cn%20%20%20%20iframe%20=%20document.createElement(%5C%22iframe%5C%22);%20%5Cn%20%20%20%20iframe.src%20=%20%60$%7BserverOrigin%7D/embed%60;%5Cn%20%20%20%20iframe.style.cssText%20=%20%5C%22position:fixed;%20top:0.5rem;%20right:0.5rem;%20height:3rem;%20width:11rem;%20background:#333;%20border:none;%20border-radius:3px;%20box-shadow:0px%202px%204px%200px%20#00000066;%20z-index:10000%5C%22;%5Cn%20%20%20%20iframe.id%20=%20%5C%22aiTextPluginEmbedIframe%5C%22;%5Cn%20%20%20%20%5Cn%20%20%20%20setTimeout(()%20=%3E%20%7B%5Cn%20%20%20%20%20%20if(!window.__aiTextIframeEmbedIsReady)%20%7B%5Cn%20%20%20%20%20%20%20%20iframe.src%20=%20%60$%7BserverOrigin%7D/embed?__cacheBust=$%7BMath.random()%7D%60;%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D,%2015*1000);%5Cn%20%20%20%20%5Cn%20%20%20%20const%20style%20=%20document.createElement(%5C%22style%5C%22);%5Cn%20%20%20%20style.textContent%20=%20%60%5Cn%20%20%20%20%20%20@keyframes%20ai-text-plugin-blink%20%7B%2050%25%20%7B%20fill:%20transparent%20%7D%7D%20.ai-text-plugin-dot%20%7B%20animation:%201s%20ai-text-plugin-blink%20infinite;%20fill:%20grey;%20%7D%20.ai-text-plugin-dot:nth-child(2)%20%7B%20animation-delay:%20250ms%20%7D%20.ai-text-plugin-dot:nth-child(3)%20%7B%20animation-delay:%20500ms%20%7D%20.ai-text-plugin-loader%20%7B%20background-color:%20#f1f1f1;%20color:%20grey;%20%7D%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20.ai-text-response-end-buttons-ctn:before%20%7B%5Cn%20%20%20%20%20%20%20%20content:%20%5C%22+%5C%22;%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20.ai-text-response-end-buttons-ctn%20%7B%5Cn%20%20%20%20%20%20%20%20position:relative;%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20.ai-text-response-buttons-wrapper%20%7B%5Cn%20%20%20%20%20%20%20%20display:none;%5Cn%20%20%20%20%20%20%20%20position:absolute;%5Cn%20%20%20%20%20%20%20%20width:%20max-content;%5Cn%20%20%20%20%20%20%20%20bottom:%200;%5Cn%20%20%20%20%20%20%20%20min-height:%202.5rem;%5Cn%20%20%20%20%20%20%20%20pointer-events:none;%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20@media%20screen%20and%20(max-width:%20600px)%20%7B%5Cn%20%20%20%20%20%20%20%20.ai-text-response-buttons-wrapper%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20min-height:%203.5rem;%20/*%20buttons%20should%20be%20further%20apart%20on%20mobile%20-%20else%20'hover'%20click%20triggers%20the%20buttons%20themselves%20*/%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20.ai-text-response-end-buttons-ctn:hover%20.ai-text-response-buttons-wrapper%20%7B%5Cn%20%20%20%20%20%20%20%20display:flex;%5Cn%20%20%20%20%20%20%20%20pointer-events:auto;%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%60;%5Cn%20%20%20%20document.head.appendChild(style);%5Cn%20%20%20%20%5Cn%20%20%20%20window.addEventListener('message',%20(event)%20=%3E%20%7B%5Cn%20%20%20%20%20%20if(event.source%20!==%20iframe.contentWindow)%20return;%5Cn%20%20%20%20%20%20if(event.origin%20!==%20serverOrigin)%20return;%5Cn%5Cn%20%20%20%20%20%20if(event.data.type%20===%20%5C%22embedIsReady%5C%22)%20%7B%20%20%20%5Cn%20%20%20%20%20%20%20%20window.__aiTextIframeEmbedIsReady%20=%20true;%5Cn%20%20%20%20%20%20%20%20//%20console.log(%5C%22got%20embedIsReady,%20sent%20verifyUser%5C%22);%5Cn%20%20%20%20%20%20%20%20iframe.contentWindow.postMessage(%7Btype:%5C%22verifyUser%5C%22%7D,%20serverOrigin);%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20if(event.data.type%20===%20%5C%22verified%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20iframe.style.display%20=%20%5C%22none%5C%22;%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20if(event.data.type%20===%20%5C%22verifying%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20iframe.style.display%20=%20%5C%22%5C%22;%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D);%5Cn%20%20%20%20document.body.appendChild(iframe);%5Cn%20%20%20%20%5Cn%20%20%20%20window.__alreadyAddedAiTextPluginStuff8492739%20=%20true;%5Cn%20%20%7D%20else%20%7B%5Cn%20%20%20%20iframe%20=%20document.querySelector(%5C%22#aiTextPluginEmbedIframe%5C%22);%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20let%20completionId%20=%20%5C%22aiTextCompletion%5C%22+Math.random().toString().replace(%5C%22.%5C%22,%20%5C%22%5C%22);%5Cn%20%20let%20lastGeneratedChunkRecievedTime%20=%20null;%5Cn%5Cn%20%20async%20function%20streamTextFromIframe(chunkCallback)%20%7B%20%5Cn%20%20%20%20let%20postData%20=%20%7B%7D;%5Cn%20%20%20%20postData.instruction%20=%20concreteInputs.instruction%20%7C%7C%20%5C%22%5C%22;%5Cn%20%20%20%20postData.startWith%20=%20concreteInputs.startWith%20%7C%7C%20%5C%22%5C%22;%5Cn%20%20%20%20postData.stopSequences%20=%20concreteInputs.stopSequences%20%7C%7C%20%5B%5D;%5Cn%20%20%20%20postData.generatorName%20=%20window.generatorName;%5Cn%20%20%20%20%5Cn%20%20%20%20let%20url%20=%20%60$%7BserverOrigin%7D/api/generate%60;%5Cn%20%20%20%20let%20haveRecievedFirstTextChunk%20=%20false;%5Cn%20%20%20%20let%20haveRecievedLastTextChunk%20=%20false;%5Cn%20%20%20%20function%20messageHandler(event)%20%7B%5Cn%20%20%20%20%20%20if(event.data.requestId%20!==%20completionId)%20return;%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20//%20console.log(%5C%22streamTextFromIframe%20messageHandler:%5C%22,%20event.data);%5Cn%20%20%20%20%20%20if(event.data.type%20===%20%5C%22streamData%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20lastGeneratedChunkRecievedTime%20=%20Date.now();%5Cn%20%20%20%20%20%20%20%20let%20text%20=%20event.data.value.text;%5Cn%20%20%20%20%20%20%20%20let%20data%20=%20%7Btext%7D;%5Cn%20%20%20%20%20%20%20%20if(event.data.value.stopReason)%20data.stopReason%20=%20event.data.value.stopReason;%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20//%20console.log(%5C%22event.data.value:%5C%22,%20event.data.value);%5Cn%20%20%20%20%20%20%20%20if(!haveRecievedFirstTextChunk)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20data.isFirstChunk%20=%20true;%5Cn%20%20%20%20%20%20%20%20%20%20haveRecievedFirstTextChunk%20=%20true;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20if(haveRecievedLastTextChunk)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20console.error(%5C%22haveRecievedLastTextChunk%20but%20about%20to%20send%20another%20chunk???%20maybe%20recieving%20streamEnd%20before%20it's%20actually%20finished??%5C%22);%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20if(event.data.value.final)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20data.isLastChunk%20=%20true;%20//%20remember,%20a%20chunk%20can%20be%20both%20the%20first%20*and*%20last%20chunk%5Cn%20%20%20%20%20%20%20%20%20%20haveRecievedLastTextChunk%20=%20true;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20chunkCallback(data);%5Cn%20%20%20%20%20%20%7D%20else%20if%20(event.data.type%20===%20%5C%22streamEnd%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20//%20console.log(%60ai-text-plugin%20recieved%20'streamEnd'%20for%20$%7BcompletionId%7D%60);%5Cn%20%20%20%20%20%20%20%20window.removeEventListener(%5C%22message%5C%22,%20messageHandler);%5Cn%20%20%20%20%20%20%20%20if(!haveRecievedLastTextChunk)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20//%20this%20can%20happen%20if%20stream%20is%20aborted%20for%20whatever%20reason,%20so%20we%20send%20a%20last%20%5C%22dummy%5C%22%20chunk%5Cn%20%20%20%20%20%20%20%20%20%20chunkCallback(%7Btext:%5C%22%5C%22,%20stopReason:%5C%22user%5C%22,%20isLastChunk:true,%20isFirstChunk:!haveRecievedFirstTextChunk%7D);%5Cn%20%20%20%20%20%20%20%20%20%20haveRecievedLastTextChunk%20=%20true;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%20else%20if%20(event.data.type%20===%20%5C%22streamError%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20if(userStoppedGeneration%20&&%20event.data.status%20===%20%5C%22stale%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20//%20this%20is%20not%20actually%20an%20error,%20but%20iframe%20embed%20can't%20know%20that,%20so%20it%20sends%20us%20this,%20which%20we%20just%20ignore.%5Cn%20%20%20%20%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20if(!finishedGenerating)%20%7B%20//%20%3C--%20just%20to%20guard%20against%20weird%20timing%20stuff%5Cn%20%20%20%20%20%20%20%20%20%20%20%20thereWasAnErrorDuringGeneration%20=%20true;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20chunkCallback(%7Btext:%5C%22%5C%22,%20error:true,%20isLastChunk:!haveRecievedLastTextChunk,%20isFirstChunk:!haveRecievedFirstTextChunk%7D);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20let%20div%20=%20document.createElement(%5C%22div%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20div.innerHTML%20=%20%60%3Cdiv%20style=%5C%22z-index:1000;%20position:%20fixed;%20bottom:%201rem;%20width:%20100%25;%20pointer-events:none;%5C%22%3E%3Cspan%20style=%5C%22%20padding:%200.5rem;%20background:%20#ac2c2c;%20border-radius:%203px;%20color:%20white;%20pointer-events:auto;%5C%22%3Eerror:%20$%7Bevent.data.status.replaceAll(%5C%22_%5C%22,%20%5C%22%20%5C%22)%7D%3C/span%3E%3C/div%3E%60;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20div%20=%20div.firstElementChild;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20document.body.appendChild(div);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20setTimeout(()%20=%3E%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20div.remove();%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D,%201000*5);%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20window.removeEventListener(%5C%22message%5C%22,%20messageHandler);%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D%5Cn%20%20%20%20%5Cn%20%20%20%20window.addEventListener(%5C%22message%5C%22,%20messageHandler);%5Cn%20%20%20%20%5Cn%20%20%20%20while(!window.__aiTextIframeEmbedIsReady)%20%7B%5Cn%20%20%20%20%20%20await%20new%20Promise(r%20=%3E%20setTimeout(r,%20100));%5Cn%20%20%20%20%7D%5Cn%20%20%20%20if(inputData._debug)%20postData._debug%20=%20JSON.parse(JSON.stringify(inputData._debug));%5Cn%20%20%20%20iframe.contentWindow.postMessage(%7B%20type:%20%5C%22startStream%5C%22,%20url,%20postData,%20requestId:completionId,%20perchanceGeneratorOrigin:window.location.origin%20%7D,%20serverOrigin);%5Cn%20%20%20%20//%20console.log(%5C%22sent%20startStream%20request%20to%20iframe%5C%22);%5Cn%20%20%7D%5Cn%5Cn%20%20async%20function%20editAiTextResponseClickHandler(el)%20%7B%20%20%20%20%5Cn%20%20%20%20let%20saveButton%20=%20document.createElement(%5C%22button%5C%22);%5Cn%20%20%20%20saveButton.style.cssText%20=%20%5C%22position:fixed;%20z-index:501;%5C%22;%5Cn%20%20%20%20saveButton.textContent%20=%20%5C%22%F0%9F%92%BE%5C%22;%5Cn%20%20%20%20document.body.append(saveButton);%5Cn%5Cn%20%20%20%20let%20textarea%20=%20document.createElement(%5C%22textarea%5C%22);%5Cn%20%20%20%20textarea.style.cssText%20=%20%5C%22z-index:500;%20display:block;%20position:fixed;%20min-height:2rem;%20min-width:10rem;%5C%22;%5Cn%20%20%20%20textarea.value%20=%20concreteInputs.startWith;%5Cn%20%20%20%20document.body.append(textarea);%5Cn%20%20%20%20let%20updateCoverPosition%20=%20()%20=%3E%20%7B%5Cn%20%20%20%20%20%20let%20rect%20=%20el.getBoundingClientRect();%5Cn%20%20%20%20%20%20textarea.style.left%20=%20%60$%7Brect.left%7Dpx%60;%5Cn%20%20%20%20%20%20textarea.style.top%20=%20%60$%7Brect.top%7Dpx%60;%5Cn%20%20%20%20%20%20textarea.style.width%20=%20%60$%7Brect.width%7Dpx%60;%5Cn%20%20%20%20%20%20textarea.style.height%20=%20%60$%7Brect.height+10%7Dpx%60;%5Cn%5Cn%20%20%20%20%20%20let%20textareaRect%20=%20textarea.getBoundingClientRect();%20//%20Use%20coverElement's%20dimensions%5Cn%20%20%20%20%20%20saveButton.style.left%20=%20%60$%7BtextareaRect.right-saveButton.offsetWidth%7Dpx%60;%5Cn%20%20%20%20%20%20saveButton.style.top%20=%20%60$%7BtextareaRect.bottom%7Dpx%60;%5Cn%20%20%20%20%7D;%5Cn%20%20%20%20updateCoverPosition();%5Cn%20%20%20%20window.addEventListener('scroll',%20updateCoverPosition);%5Cn%20%20%20%20window.addEventListener('resize',%20updateCoverPosition);%5Cn%20%20%20%20%5Cn%20%20%20%20const%20observer%20=%20new%20MutationObserver((mutationsList)%20=%3E%20%7B%5Cn%20%20%20%20%20%20for(let%20mutation%20of%20mutationsList)%20%7B%5Cn%20%20%20%20%20%20%20%20for(let%20node%20of%20mutation.removedNodes)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20if(node.contains(el))%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20textarea.remove();%5Cn%20%20%20%20%20%20%20%20%20%20%20%20saveButton.remove();%5Cn%20%20%20%20%20%20%20%20%20%20%20%20window.removeEventListener('scroll',%20updateCoverPosition);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20window.removeEventListener('resize',%20updateCoverPosition);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20observer.disconnect();%5Cn%20%20%20%20%20%20%20%20%20%20%20%20return;%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D);%5Cn%20%20%20%20observer.observe(document.body,%20%7B%20childList:%20true,%20subtree:%20true%20%7D);%5Cn%5Cn%20%20%20%20await%20new%20Promise(r%20=%3E%20saveButton.onclick=r);%20%5Cn%5Cn%20%20%20%20let%20endButtonsCtn%20=%20document.querySelector(%5C%22.ai-text-response-end-buttons-ctn%5C%22);%5Cn%20%20%20%20endButtonsCtn.remove();%5Cn%5Cn%20%20%20%20concreteInputs.startWith%20=%20textarea.value;%5Cn%20%20%20%20%5Cn%20%20%20%20//%20el.innerHTML%20=%20textarea.value;%5Cn%20%20%20%20//%20el.appendChild(endButtonsCtn);%5Cn%20%20%20%20renderResponseTextIntoContainer(textarea.value,%20%7BaddEndButtons:true,%20isFinalRender:true%7D);%5Cn%5Cn%20%20%20%20window.removeEventListener('scroll',%20updateCoverPosition);%5Cn%20%20%20%20window.removeEventListener('resize',%20updateCoverPosition);%5Cn%20%20%20%20textarea.remove();%5Cn%20%20%20%20saveButton.remove();%5Cn%20%20%7D;%5Cn%20%20%5Cn%20%20async%20function%20continueAiTextResponseClickHandler(el)%20%7B%20%20%20%20%5Cn%20%20%20%20let%20instruction%20=%20concreteInputs.instruction;%5Cn%20%20%20%20let%20startWith%20=%20concreteInputs.startWith;%5Cn%20%20%20%20let%20stopSequences%20=%20concreteInputs.stopSequences;%5Cn%20%20%20%20%5Cn%20%20%20%20responseEndButtonsCtn.remove();%5Cn%20%20%20%20let%20obj%20=%20$output(%7Binstruction,%20startWith,%20stopSequences,%20style:inputData.style,%20outputTo:el,%20render:inputData.render,%20onFinish:inputData.onFinish,%20onChunk:inputData.onChunk%7D);%5Cn%20%20%20%20el.innerHTML%20+=%20obj.loadingIndicatorHtml;%5Cn%20%20%7D;%5Cn%20%20%5Cn%20%20let%20responseEndButtonsCtn;%5Cn%20%20%7B%5Cn%20%20%20%20let%20buttonGap%20=%20%5C%220.25rem%5C%22;%5Cn%20%20%20%20if(window.innerWidth%20%3C%20600)%20buttonGap%20=%20%5C%221.5rem%5C%22;%5Cn%20%20%20%20%5Cn%20%20%20%20let%20responseEndButtonsHtml%20=%20%60%3Cspan%20class=%5C%22ai-text-response-end-buttons-ctn%5C%22%20style=%5C%22display:%20inline-flex;background:%20#f1f1f1;color:%20grey;height:%201rem;width:%201rem;border-radius:%203px;vertical-align:%20top;position:%20relative;top:%200.07rem;margin-left:%200.125rem;align-items:%20center;justify-content:%20center;cursor:%20pointer;%20font-size:80%25%5C%22%3E%5Cn%20%20%20%20%20%20%3Cdiv%20class=%5C%22ai-text-response-buttons-wrapper%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Cbutton%20class=%5C%22ai-text-continue-button%5C%22%20style=%5C%22height:min-content;%5C%22%3E%E2%96%B6%EF%B8%8F%3C/button%3E%5Cn%20%20%20%20%20%20%20%20%3Cbutton%20class=%5C%22ai-text-edit-button%5C%22%20style=%5C%22height:min-content;%20margin-left:$%7BbuttonGap%7D%5C%22%3E%E2%9C%8F%EF%B8%8F%3C/button%3E%5Cn%20%20%20%20%20%20%3C/div%3E%5Cn%20%20%20%20%3C/span%3E%60;%5Cn%20%20%20%20responseEndButtonsCtn%20=%20document.createElement(%5C%22div%5C%22);%5Cn%20%20%20%20responseEndButtonsCtn.innerHTML%20=%20responseEndButtonsHtml;%5Cn%20%20%20%20responseEndButtonsCtn%20=%20responseEndButtonsCtn.firstElementChild;%5Cn%20%20%20%20if(inputData.endButtons?.evaluateItem%20===%20%5C%22none%5C%22)%20%7B%5Cn%20%20%20%20%20%20responseEndButtonsCtn.style.display%20=%20%5C%22none%5C%22;%5Cn%20%20%20%20%7D%5Cn%20%20%20%20responseEndButtonsCtn.querySelector(%5C%22.ai-text-continue-button%5C%22).onclick%20=%20function()%20%7B%5Cn%20%20%20%20%20%20//%20console.log(%5C%22wrapper%20display:%5C%22,%20this.closest('.ai-text-response-buttons-wrapper').style.display);%5Cn%20%20%20%20%20%20continueAiTextResponseClickHandler(this.closest('.ai-text-response-ctn'));%5Cn%20%20%20%20%7D;%5Cn%20%20%20%20responseEndButtonsCtn.querySelector(%5C%22.ai-text-edit-button%5C%22).onclick%20=%20function()%20%7B%5Cn%20%20%20%20%20%20//%20console.log(%5C%22wrapper%20display:%5C%22,%20this.closest('.ai-text-response-buttons-wrapper').style.display);%5Cn%20%20%20%20%20%20editAiTextResponseClickHandler(this.closest('.ai-text-response-ctn'));%5Cn%20%20%20%20%7D;%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20function%20escapeRegExp(text)%20%7B%5Cn%20%20%20%20return%20text.replace(/%5B-%5B%5C%5C%5D%7B%7D()*+?.,%5C%5C%5C%5C%5E$%7C#%5C%5Cs%5D/g,%20'%5C%5C%5C%5C$&');%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20let%20startWithRegex;%5Cn%20%20%5Cn%20%20function%20renderResponseTextIntoContainer(response,%20opts=%7B%7D)%20%7B%5Cn%20%20%20%20if(!inputData.outputTo%20&&%20!placeholderEl)%20return;%20//%20%3C--%20indicates%20that%20they're%20doing%20things%20manually%20with%20e.g.%20onFinishPromise/onChunk/etc.%5Cn%20%20%20%20%5Cn%20%20%20%20if(hideStartWith)%20%7B%20//%20note%20that%20%60hideStartWith%60%20is%20purely%20'visual'%20-%20it's%20just%20a%20handy%20helper%20for%20a%20common%20case%20(that%20could%20otherwise%20be%20solved%20with%20%60render%60)%5Cn%20%20%20%20%20%20if(!startWithRegex)%20startWithRegex%20=%20new%20RegExp(%5C%22%5E%5C%22+escapeRegExp(concreteInputs.startWith));%5Cn%20%20%20%20%20%20response%20=%20response.replace(startWithRegex,%20%5C%22%5C%22);%5Cn%20%20%20%20%7D%5Cn%20%20%20%20if(inputData.render)%20%7B%5Cn%20%20%20%20%20%20response%20=%20inputData.render(%7Btext:response,%20isPartial:!opts.isFinalRender%7D);%5Cn%20%20%20%20%7D%5Cn%20%20%20%20if(inputData.outputTo)%20%7B%5Cn%20%20%20%20%20%20if(typeof%20inputData.outputTo.value%20==%20%5C%22string%5C%22)%20%7B%20//%20textarea,%20input,%20or%20user's%20custom%20object%20with%20string%20%60.value%60%20property%5Cn%20%20%20%20%20%20%20%20inputData.outputTo.value%20=%20inputData.render%20?%20inputData.render(%7Btext:response,%20isPartial:!opts.isFinalRender%7D)%20:%20response;%5Cn%20%20%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20%20%20inputData.outputTo.innerHTML%20=%20response;%5Cn%20%20%20%20%20%20%20%20if(opts.addEndButtons)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20responseEndButtonsCtn.title%20=%20%60Inputs%20that%20were%20used:%5C%5Cn%5C%5Cninstruction=$%7BconcreteInputs.instruction%7D%5C%5Cn%5C%5CnstartWith=$%7BconcreteInputs.startWith%7D%60;%5Cn%20%20%20%20%20%20%20%20%20%20inputData.outputTo.append(responseEndButtonsCtn);%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20if(typeof%20placeholderEl.value%20==%20%5C%22string%5C%22)%20%7B%20//%20textarea,%20input,%20or%20user's%20custom%20object%20with%20string%20%60.value%60%20property%5Cn%20%20%20%20%20%20%20%20placeholderEl.value%20=%20response;%5Cn%20%20%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20%20%20placeholderEl.innerHTML%20=%20response;%5Cn%20%20%20%20%20%20%20%20if(opts.addEndButtons)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20responseEndButtonsCtn.title%20=%20%60Inputs%20that%20were%20used:%5C%5Cn%5C%5Cninstruction=$%7BconcreteInputs.instruction%7D%5C%5Cn%5C%5CnstartWith=$%7BconcreteInputs.startWith%7D%60;%5Cn%20%20%20%20%20%20%20%20%20%20placeholderEl.append(responseEndButtonsCtn);%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20async%20function%20startStreamingResponse()%20%7B%5Cn%20%20%20%20try%20%7B%5Cn%20%20%20%20%20%20let%20chunks%20=%20%5B%5D;%5Cn%20%20%20%20%20%20let%20generatedChunks%20=%20%5B%5D;%20//%20difference%20from%20%60chunks%60%20is%20that%20this%20doesn't%20include%20the%20user-specified%20%60startWith%60%20text%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20(async%20function()%20%7B%5Cn%20%20%20%20%20%20%20%20await%20new%20Promise(r%20=%3E%20setTimeout(r,%20500));%5Cn%20%20%20%20%20%20%20%20while(true)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20if(userStoppedGeneration)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20console.log(%5C%22stopping%20keepalives%20due%20to%20%60userStoppedGeneration%60%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20break;%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20if(finishedGenerating)%20%7B%20console.log(%5C%22stopping%20keepalives%20due%20to%20%60finishedGenerating%60%5C%22);%20break;%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20if(placeholderElDidInitiallyExist%20&&%20!document.querySelector(%60#$%7BcompletionId%7D%60))%20%7B%20console.log(%5C%22stopping%20keepalives%20due%20to%20%60placeholderEl%60%5C%22);%20break;%20%7D%20//%20placeholderEl%20no%20longer%20exists%20in%20the%20DOM,%20so%20user%20probably%20clicked%20'randomize'%20or%20whatever%20while%20previous%20one%20was%20still%20loading,%20hence%20we%20abort%20previous%20one%20by%20stopping%20the%20keepalives,%20which%20drops%20it%20from%20the%20queue%5Cn%20%20%20%20%20%20%20%20%20%20if(inputData.outputTo%20&&%20(!document.body.contains(inputData.outputTo)%20%7C%7C%20inputData.outputTo.dataset.aiTextCompletionId%20!==%20completionId))%20%20%7B%20console.log(%5C%22stopping%20keepalives%20due%20to%20%60outputTo%60%5C%22);%20break;%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20//%20if(lastGeneratedChunkRecievedTime%20!==%20null%20&&%20Date.now()-lastGeneratedChunkRecievedTime%20%3E%201000*20)%20%20%7B%20console.log(%5C%22stopping%20keepalives%20due%20to%20generation%20having%20started%20but%20no%20new%20chunks%20recieved%20in%2020%20seconds%5C%22);%20break;%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20%20%20iframe.contentWindow.postMessage(%7B%20type:%20%5C%22streamKeepAlive%5C%22,%20requestId:completionId%20%7D,%20serverOrigin);%5Cn%20%20%20%20%20%20%20%20%20%20console.log(%5C%22streamKeepAlive%20sent%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20await%20new%20Promise(r%20=%3E%20setTimeout(r,%20500));%5Cn%20%20%20%20%20%20%20%20%20%20//%20if(window.devTest98375290385)%20await%20new%20Promise(r%20=%3E%20setTimeout(r,%2010000000000));%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20stop();%20//%20need%20to%20call%20stop()%20here%20(and%20not%20just%20wait%20for%20it%20to%20be%20called%20in%20streamTextFromIframe)%20because%20otherwise%20it%20only%20gets%20called%20if%20streamTextFromIframe%20gets%20called%20again,%20which%20it%20*might%20not*%5Cn%20%20%20%20%20%20%7D)();%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20function%20stop()%20%7B%5Cn%20%20%20%20%20%20%20%20if(finishedGenerating)%20return;%5Cn%20%20%20%20%20%20%20%20finishedGenerating%20=%20true;%5Cn%5Cn%20%20%20%20%20%20%20%20let%20finishData%20=%20%7Btext:chunks.join(%5C%22%5C%22),%20generatedText:generatedChunks.join(%5C%22%5C%22),%20stopReason:%5C%22user%5C%22%7D;%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20if(inputData.onFinish)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20try%20%7B%20inputData.onFinish(finishData);%20%7D%20catch(e)%20%7B%20console.error(%5C%22error%20in%20onFinish:%5C%22,%20e);%20%7D%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20textStreamController.close();%5Cn%20%20%20%20%20%20%20%20onFinishPromiseResolver(finishData);%5Cn%20%20%20%20%20%20%20%20generatedText%20=%20generatedChunks.join(%5C%22%5C%22);%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20streamTextFromIframe(function(data)%20%7B%5Cn%20%20%20%20%20%20%20%20if(userStoppedGeneration)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20if(!finishedGenerating)%20stop();%5Cn%20%20%20%20%20%20%20%20%20%20return;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20if(placeholderElDidInitiallyExist%20&&%20!document.querySelector(%60#$%7BcompletionId%7D%60))%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20if(!finishedGenerating)%20stop();%5Cn%20%20%20%20%20%20%20%20%20%20return;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20if(inputData.outputTo%20&&%20(!document.body.contains(inputData.outputTo)%20%7C%7C%20inputData.outputTo.dataset.aiTextCompletionId%20!==%20completionId))%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20if(!finishedGenerating)%20stop();%5Cn%20%20%20%20%20%20%20%20%20%20return;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20if(finishedGenerating)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20thereWasAnErrorDuringGeneration%20=%20true;%5Cn%20%20%20%20%20%20%20%20%20%20console.error(%5C%22We%20received%20a%20chunk%20of%20text%20even%20though%20we've%20already%20finishedGenerating?%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20return;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20//%20add%20the%20startWith%20chunk%20before%20the%20first%20'real'%20chunk:%5Cn%20%20%20%20%20%20%20%20if(data.isFirstChunk%20&&%20concreteInputs.startWith)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20chunks.push(concreteInputs.startWith);%5Cn%20%20%20%20%20%20%20%20%20%20textStreamController.enqueue(concreteInputs.startWith);%5Cn%20%20%20%20%20%20%20%20%20%20if(inputData.onChunk)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20inputData.onChunk(%7BfullTextSoFar:chunks.join(%5C%22%5C%22),%20textChunk:concreteInputs.startWith,%20isFromStartWith:true%7D);%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20if(data.error)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20let%20allChunksJoined%20=%20chunks.join(%5C%22%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20thereWasAnErrorDuringGeneration%20=%20true;%5Cn%20%20%20%20%20%20%20%20%20%20finishedGenerating%20=%20true;%5Cn%20%20%20%20%20%20%20%20%20%20concreteInputs.startWith%20=%20allChunksJoined;%5Cn%20%20%20%20%20%20%20%20%20%20renderResponseTextIntoContainer(allChunksJoined,%20%7BaddEndButtons:true,%20isFinalRender:true%7D);%5Cn%20%20%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20%20%20let%20finishData%20=%20%7Btext:allChunksJoined,%20generatedText:generatedChunks.join(%5C%22%5C%22),%20stopReason:%5C%22error%5C%22%7D;%5Cn%20%20%20%20%20%20%20%20%20%20if(inputData.onFinish)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20inputData.onFinish(finishData);%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20textStreamController.close();%5Cn%20%20%20%20%20%20%20%20%20%20onFinishPromiseResolver(finishData);%5Cn%20%20%20%20%20%20%20%20%20%20generatedText%20=%20generatedChunks.join(%5C%22%5C%22);%5Cn%20%20%20%20%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20generationLastKnownToBeWorkingAt%20=%20Date.now();%5Cn%20%20%20%20%20%20%20%20%20%20if(data.isFirstChunk)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20if(placeholderEl)%20placeholderEl.innerHTML%20=%20%5C%22%5C%22;%20//%20clear%20the%20svg%20'loading'%20dots%5Cn%20%20%20%20%20%20%20%20%20%20%20%20if(inputData.beforeFirstChunk)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20inputData.beforeFirstChunk(%7B%7D);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20%20%20generatedChunks.push(data.text);%5Cn%20%20%20%20%20%20%20%20%20%20chunks.push(data.text);%5Cn%20%20%20%20%20%20%20%20%20%20textStreamController.enqueue(data.text);%5Cn%20%20%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20%20%20if(inputData.onChunk)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20inputData.onChunk(%7BfullTextSoFar:chunks.join(%5C%22%5C%22),%20textChunk:data.text%7D);%20//%20%60data.text%60%20is%20the%20full%20text%20so%20far%20(like%20in%20onFinish,%20render,%20etc.),%20and%20%60data.chunk%60%20is%20the%20most%20recent%20chunk%20(the%20one%20that%20triggered%20this%20call%20to%20onChunk)%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20%20%20renderResponseTextIntoContainer(chunks.join(%5C%22%5C%22),%20%7BaddEndButtons:!!data.isLastChunk,%20isFinalRender:!!data.isLastChunk%7D);%5Cn%20%20%20%20%20%20%20%20%20%20if(data.isLastChunk)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20console.log(%5C%22FINISHED%20STREAMING.%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20finishedGenerating%20=%20true;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20finishedGeneratingSuccessfully%20=%20true;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20concreteInputs.startWith%20=%20chunks.join(%5C%22%5C%22);%20//%20update%20the%20startWith%20for%20'continue'%20and%20'edit'%20button%20use%5Cn%20%20%20%20%20%20%20%20%20%20%20%20let%20finishData%20=%20%7Btext:chunks.join(%5C%22%5C%22),%20generatedText:generatedChunks.join(%5C%22%5C%22),%20stopReason:data.stopReason%7D;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20if(inputData.onFinish)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20inputData.onFinish(finishData);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20textStreamController.close();%5Cn%20%20%20%20%20%20%20%20%20%20%20%20onFinishPromiseResolver(finishData);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20generatedText%20=%20generatedChunks.join(%5C%22%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D);%20%20%20%20%5Cn%5Cn%20%20%20%20%7D%20catch(e)%20%7B%5Cn%20%20%20%20%20%20thereWasAnErrorDuringGeneration%20=%20true;%5Cn%20%20%20%20%20%20finishedGenerating%20=%20true;%5Cn%20%20%20%20%20%20onFinishPromiseRejecter();%5Cn%20%20%20%20%20%20console.error(e);%5Cn%20%20%20%20%20%20await%20new%20Promise(r%20=%3E%20setTimeout(r,%201000));%5Cn%20%20%20%20%20%20iframe.contentWindow.postMessage(%7Btype:%5C%22verifyUser%5C%22%7D,%20serverOrigin);%20//%20probably%20not%20necessary,%20but%20just%20in%20case%20(it'll%20only%20re-verify%20if%20it's%20actually%20needed%20anyway)%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20function%20onVisible(element,%20callback)%20%7B%5Cn%20%20%20%20new%20IntersectionObserver((entries,%20observer)%20=%3E%20%7B%5Cn%20%20%20%20%20%20entries.forEach(entry%20=%3E%20%7B%5Cn%20%20%20%20%20%20%20%20if(entry.intersectionRatio%20%3E%200)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20callback(element);%5Cn%20%20%20%20%20%20%20%20%20%20observer.disconnect();%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D);%5Cn%20%20%20%20%7D).observe(element);%5Cn%20%20%20%20if(!callback)%20return%20new%20Promise(r%20=%3E%20callback=r);%5Cn%20%20%7D%5Cn%20%20%20%20%5Cn%20%20setTimeout(async%20()%20=%3E%20%7B%5Cn%20%20%20%20//%20give%20placeholderEl%20a%20chance%20to%20be%20put%20into%20the%20DOM%5Cn%20%20%20%20placeholderEl%20=%20document.querySelector(%60#$%7BcompletionId%7D%60);%20//%20this%20will%20be%20null%20if%20they're%20using%20outputTo%20or%20are%20just%20doing%20things%20fully%20manually%20onFinishPromise/onChunk/etc.%5Cn%20%20%20%20if(placeholderEl)%20placeholderElDidInitiallyExist%20=%20true;%5Cn%20%20%20%20//%20wait%20for%20placeholderEl%20to%20become%20visible:%5Cn%20%20%20%20if(placeholderElDidInitiallyExist%20&&%20!inputData.outputTo)%20%7B%5Cn%20%20%20%20%20%20await%20onVisible(placeholderEl);%5Cn%20%20%20%20%7D%5Cn%20%20%20%20%5Cn%20%20%20%20if(inputData.onStart)%20%7B%5Cn%20%20%20%20%20%20inputData.onStart(syncOutputObj);%5Cn%20%20%20%20%7D%5Cn%20%20%20%20startStreamingResponse();%20%5Cn%20%20%7D,%20100);%5Cn%20%20%5Cn%20%20let%20beforeLoaderHtml%20=%20%5C%22%5C%22;%5Cn%20%20if(!inputData.outputTo%20&&%20!hideStartWith)%20%7B%5Cn%20%20%20%20beforeLoaderHtml%20=%20inputData.render%20?%20inputData.render(%7Btext:concreteInputs.startWith,%20isPartial:true%7D)%20:%20concreteInputs.startWith;%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20if(inputData.outputTo)%20%7B%5Cn%20%20%20%20inputData.outputTo.dataset.aiTextCompletionId%20=%20completionId;%20//%20this%20is%20used%20for%20keepalive%20stuff%20-%20if%20a%20queued%20request%20is%20going%20to%20output%20to%20an%20outputTo%20element,%20but%20that%20element%20no%20longer%20has%20the%20correct%20%60dataset.aiTextCompletionId%60%20then%20we%20drop%20it%20from%20the%20queue%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20syncOutputObj%20=%20%7B%5Cn%20%20%20%20inputs:%20originalConcreteInputs,%5Cn%20%20%20%20textStream,%5Cn%20%20%20%20onFinishPromise,%5Cn%20%20%20%20stop:%20()%20=%3E%20%7B%20//%20note:%20this%20can't%20actually%20stop%20a%20request%20if%20it%20has%20already%20started,%20since%20the%20server%20doesn't%20currently%20support%20that%20-%20it%20just%20drops%20the%20request%20from%20the%20queue%20if%20it%20is%20still%20waiting.%5Cn%20%20%20%20%20%20userStoppedGeneration%20=%20true;%5Cn%20%20%20%20%7D,%5Cn%20%20%20%20id:%20completionId,%5Cn%20%20%20%20loadingIndicatorHtml:%20animatedLoadingSvg,%20//%20%3C--%20just%20a%20littler%20helper%20for%20people%20who%20are%20e.g.%20using%20onFinishPromise/onChunk/etc.%20but%20want%20to%20add%20a%20loading%20indicator%20to%20the%20page%20manually%5Cn%20%20%20%20toString:%20function()%20%7B%20//%20this%20object%20stringifies%20into%20the%20default%20placeholder%20element%5Cn%20%20%20%20%20%20return%20%60%3Cspan%20class=%5C%22ai-text-response-ctn%5C%22%20id=%5C%22$%7BcompletionId%7D%5C%22%20style=%5C%22white-space:pre-wrap;%20$%7BinputData.style%20?%20inputData.style%20:%20%5C%22%5C%22%7D%5C%22%3E$%7BbeforeLoaderHtml%7D$%7BanimatedLoadingSvg%7D%3C/span%3E%60;%5Cn%20%20%20%20%7D,%5Cn%20%20%20%20submitUserRating:%20async%20(%7Bscore,%20reason%7D)%20=%3E%20%7B%5Cn%20%20%20%20%20%20if(!finishedGenerating%20%7C%7C%20thereWasAnErrorDuringGeneration)%20%7B%5Cn%20%20%20%20%20%20%20%20console.error(thereWasAnErrorDuringGeneration%20?%20%5C%22cannot%20rate%20because%20there%20was%20an%20error%20during%20generation%5C%22%20:%20%5C%22cannot%20rate%20because%20it%20hasn't%20finished%20generating%20yet%5C%22);%5Cn%20%20%20%20%20%20%20%20return;%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20if(isNaN(Number(score))%20%7C%7C%20Number(score)%20%3E%201%20%7C%7C%20Number(score)%20%3C%200)%20return%20alert(%60User%20rating%20should%20be%20a%20value%20between%200%20(bad)%20and%201%20(good).%20Like%200.4%20or%200.8,%20for%20example.%60);%5Cn%20%20%20%20%20%20score%20=%20Number(score);%5Cn%20%20%20%20%20%20if(!reason)%20reason%20=%20%5C%22%5C%22;%5Cn%20%20%20%20%20%20iframe.contentWindow.postMessage(%7B%20type:%20%5C%22rateGeneratedText%5C%22,%20instruction,%20startWith,%20generatedText,%20generatorName:window.generatorName,%20score,%20reason%20%7D,%20serverOrigin);%5Cn%20%20%20%20%7D,%5Cn%20%20%7D;%5Cn%20%20return%20syncOutputObj;%5Cn%20%20%5Cn%5Cn%5Cn%5Cn%5Cn%5Cn%5Cn%5Cn%5Cn%5Cn%5Cn%5Cn%5Cn%5Cn%5Cn%5Cn%5Cn%5Cncharacter%5Cn%20%20%7Bmech%7Cdemon%7Ccyberpunk%7D%20%7Bwarrior%7Cminion%7Csamurai%7D%5Cn%5Cnplace%5Cn%20%20a%20retropunk%20distopia%5Cn%20%20a%20small%20village%5Cn%20%20a%20mountainous%20region%5Cn%20%20an%20underwater%20cavern%5Cn%20%20a%20=%2010%5Cn%5Cnseason%5Cn%20%20winter%5Cn%20%20summer%5Cn%20%20%5CnpoemPrompt%5Cn%20%20instruction%20=%20Write%20a%204%20line%20poem%20about%20a%20%5Bcharacter%5D%20in%20%5Bplace%5D%20during%20%5Bseason%5D.%5Cn%5Cn%5Cn%5Cn%22,%22imports%22:%5B%5D,%22name%22:%22ai-text-plugin%22%7D,%7B%22modelText%22:%22$output(opts)%20=%3E%5Cn%20%20if(!opts)%20opts%20=%20%7B%7D;%5Cn%20%20if(!opts.width)%20opts.width%20=%20%5C%22300px%5C%22;%5Cn%20%20if(!opts.height)%20opts.height%20=%20%5C%22250px%5C%22;%20%5Cn%20%20if(typeof%20opts.width%20===%20%5C%22number%5C%22)%20opts.width%20+=%20%5C%22px%5C%22;%20%20%20%20%5Cn%20%20if(typeof%20opts.height%20===%20%5C%22number%5C%22)%20opts.height%20+=%20%5C%22px%5C%22;%5Cn%20%20let%20containerStyle%20=%20opts.containerStyle%20%7C%7C%20opts.style%20%7C%7C%20%60width:$%7Bopts.width%7D;%20height:$%7Bopts.height%7D;%60;%5Cn%20%20%5Cn%20%20let%20queryParams%20=%20%7B%7D;%5Cn%20%20if(opts.adminPasswordHash)%20queryParams.adminPasswordHash%20=%20opts.adminPasswordHash.evaluateItem;%5Cn%20%20%5Cn%20%20let%20urlHashData%20=%20%7B%7D;%5Cn%20%20if(opts.adminPasswordHash)%20urlHashData.adminPasswordHash%20=%20opts.adminPasswordHash;%5Cn%20%20if(opts.bannedWords)%20%7B%5Cn%20%20%20%20if(typeof%20opts.bannedWords%20===%20%5C%22string%5C%22)%20%7B%5Cn%20%20%20%20%20%20urlHashData.bannedWords%20=%20opts.bannedWords.trim().split(%5C%22,%5C%22).map(w%20=%3E%20w.trim()).filter(w%20=%3E%20w);%5Cn%20%20%20%20%7D%20else%20if(!opts.bannedWords.getLength%20&&%20opts.getPropertyNames%20&&%20opts.getPropertyNames.includes(%5C%22bannedWords%5C%22))%20%7B%5Cn%20%20%20%20%20%20urlHashData.bannedWords%20=%20opts.bannedWords.getRawListText.split(%5C%22=%5C%22).slice(1).join(%5C%22=%5C%22).trim().split(%5C%22,%5C%22).map(w%20=%3E%20w.trim()).filter(w%20=%3E%20w);%5Cn%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20urlHashData.bannedWords%20=%20opts.bannedWords.selectAll.map(item%20=%3E%20item.getRawListText.replace(%5C%22/%5C%5C%5C%5C%5E%5C%22,%20%5C%22/%5E%5C%22));%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%20%20if(opts.commentPlaceholderText)%20urlHashData.commentPlaceholderText%20=%20opts.commentPlaceholderText.evaluateItem;%5Cn%20%20if(opts.submitButtonText)%20urlHashData.submitButtonText%20=%20opts.submitButtonText.evaluateItem;%5Cn%20%20if(opts.hideComments)%20urlHashData.hideComments%20=%20opts.hideComments;%5Cn%20%20if(opts.hideDates)%20urlHashData.hideDates%20=%20opts.hideDates;%5Cn%20%20if(opts.hideCommentsBeforeDate)%20urlHashData.hideCommentsBeforeDate%20=%20opts.hideCommentsBeforeDate;%5Cn%20%20%5Cn%20%20if(opts.submitButtonStyle)%20urlHashData.submitButtonStyle%20=%20opts.submitButtonStyle.evaluateItem;%5Cn%20%20if(opts.settingsButtonStyle)%20urlHashData.settingsButtonStyle%20=%20opts.settingsButtonStyle.evaluateItem;%5Cn%20%20if(opts.fullscreenButtonStyle)%20urlHashData.fullscreenButtonStyle%20=%20opts.fullscreenButtonStyle.evaluateItem;%5Cn%20%20if(opts.messageBubbleStyle)%20urlHashData.messageBubbleStyle%20=%20opts.messageBubbleStyle.evaluateItem;%5Cn%20%20if(opts.messageFeedStyle)%20urlHashData.messageFeedStyle%20=%20opts.messageFeedStyle.evaluateItem;%5Cn%20%20if(opts.inputAreaStyle)%20urlHashData.inputAreaStyle%20=%20opts.inputAreaStyle.evaluateItem;%5Cn%20%20if(opts.loadFonts)%20urlHashData.loadFonts%20=%20opts.loadFonts.evaluateItem;%5Cn%20%20if(opts.forceColorScheme)%20urlHashData.forceColorScheme%20=%20opts.forceColorScheme.evaluateItem;%5Cn%20%20if(opts.channelLabel)%20urlHashData.channelLabel%20=%20opts.channelLabel.evaluateItem;%5Cn%20%20%5Cn%20%20%5Cn%20%20if(opts.adminFlair)%20urlHashData.adminFlair%20=%20opts.adminFlair.evaluateItem;%5Cn%20%20if(opts.deleteButtonIcon)%20urlHashData.deleteButtonIcon%20=%20opts.deleteButtonIcon.evaluateItem;%5Cn%20%20if(opts.bannedUsers)%20urlHashData.bannedUsers%20=%20opts.bannedUsers.joinItems(%5C%22,%5C%22);%5Cn%20%20if(opts.slashCommands)%20urlHashData.slashCommands%20=%20encodeURIComponent(JSON.stringify(opts.slashCommands));%5Cn%20%20urlHashData.channel%20=%20opts.channel%20?%20opts.channel.evaluateItem%20:%20%5C%22%5C%22;%5Cn%20%20%5Cn%20%20if(!window.___commentsPluginSlashCommandsByChannel12321)%20window.___commentsPluginSlashCommandsByChannel12321%20=%20%7B%7D;%5Cn%20%20window.___commentsPluginSlashCommandsByChannel12321%5BurlHashData.channel%5D%20=%20opts.slashCommands;%20%20%20%20%5Cn%20%20%5Cn%20%20let%20folderName%20=%20window.generatorName;%20%5Cn%20%20if(opts.channel)%20%7B%5Cn%20%20%20%20let%20channel%20=%20opts.channel.evaluateItem;%5Cn%20%20%20%20if(!/%5E%5Ba-z0-9%5C%5C-%5D+$/.test(channel))%20return%20%60(ERROR:%20You%20gave%20a%20channel%20name%20of%20'$%7Bchannel%7D'%20to%20the%20comments%20plugin,%20but%20channel%20names%20can%20only%20contain%20lower-case%20letters,%20numbers,%20and%20hyphens,%20like%20'my-cool-channel-33'.)%60;%5Cn%20%20%20%20folderName%20+=%20%60+$%7Bchannel%7D%60;%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20//%20I've%20deprecated%20%60reverseCommentOrder%60,%20but%20it%20won't%20hurt%20existing%20implementations%20because%20the%20%5C%22reversed%5C%22%20order%20(new%20comments%20at%20bottom)%20is%20now%20default.%5Cn%20%20//%20if(opts.reverseCommentOrder)%20urlHashData.reverseCommentOrder%20=%20opts.reverseCommentOrder;%5Cn%20%20urlHashData.reverseCommentOrder%20=%20true;%5Cn%20%20if(opts.newestCommentsAtTop)%20urlHashData.reverseCommentOrder%20=%20false;%20%5Cn%20%20%5Cn%20%20let%20queryString%20=%20new%20URLSearchParams(queryParams).toString();%5Cn%20%20%5Cn%20%20if(!window.___alreadyAddedCommentsPluginStuff43211234)%20%7B%5Cn%20%20%20%20%5Cn%20%20%20%20//%20the%20iframe%20send%20us%20a%20message%20when%20it%20is%20finished%20loading%20(this%20is%20to%20get%20around%20Glitch's%20uncustomizable%20loading%20screens)%5Cn%20%20%20%20window.addEventListener(%5C%22message%5C%22,%20async%20function(e)%20%7B%5Cn%20%20%20%20%20%20if(e.origin%20!==%20%5C%22https://comments-plugin.perchance.org%5C%22)%20return;%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20if(e.data.type%20===%20%5C%22perchance_comments_finished_loading%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20//%20hide%20the%20loader%20of%20the%20iframe%20of%20this%20message:%5Cn%20%20%20%20%20%20%20%20for(let%20el%20of%20%5B...document.querySelectorAll(%5C%22.___perchance-comments-plugin-iframe-12345%5C%22)%5D)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20if(e.source%20===%20el.contentWindow)%20el.parentNode.querySelector(%5C%22.__perchance-comments-loading-facade-12345%5C%22).style.display%20=%20%5C%22none%5C%22;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%20else%20if(e.data.type%20===%20%5C%22evaluateText%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20let%20result%20=%20e.data.text.evaluateItem;%5Cn%20%20%20%20%20%20%20%20e.source.postMessage(%7BrequestId:e.data.requestId,%20result%7D,%20e.origin);%5Cn%20%20%20%20%20%20%7D%20else%20if(e.data.type%20===%20%5C%22slash_command%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20let%20commandName%20=%20e.data.commandName;%5Cn%20%20%20%20%20%20%20%20let%20argText%20=%20e.data.argText;%5Cn%20%20%20%20%20%20%20%20let%20slashCommands%20=%20window.___commentsPluginSlashCommandsByChannel12321%5Be.data.channel%5D;%5Cn%20%20%20%20%20%20%20%20if(slashCommands%5BcommandName%5D%20===%20undefined)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20alert(%5C%22Please%20refresh%20the%20page%20before%20testing%20newly-added%20commands.%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20return%20%5C%22%5C%22;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20slashCommands%5BcommandName%5D.input%20=%20argText;%5Cn%20%20%20%20%20%20%20%20let%20resultText%20=%20slashCommands%5BcommandName%5D.output.evaluateItem;%5Cn%20%20%20%20%20%20%20%20e.source.postMessage(%7BrequestId:e.data.requestId,%20resultText%7D,%20e.origin);%5Cn%20%20%20%20%20%20%7D%20else%20if(e.data.type%20===%20%5C%22toggle_fullscreen%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20let%20iframe%20=%20%5B...document.querySelectorAll(%5C%22.___perchance-comments-plugin-iframe-12345%5C%22)%5D.filter(el%20=%3E%20e.source%20===%20el.contentWindow)%5B0%5D;%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20//%20If%20iframe%20is%20currently%20fullscreen,%20then%20it's%20not%20in%20a%20%60ctn%60,%20so%20we%20use%20the%20pre-assigned%20data-comments-ctn-id%20to%20find%20the%20iframe's%20ctn%20so%20we%20can%20put%20it%20back%20in:%5Cn%20%20%20%20%20%20%20%20let%20ctn%20=%20iframe.closest(%5C%22.comments-plugin-ctn%5C%22)%20%7C%7C%20document.querySelector(%60%5Bdata-comments-ctn-id=%5C%22$%7Biframe.dataset.commentsCtnId%7D%5C%22%5D%60);%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20if(ctn.dataset.isFullscreen%20===%20%5C%22no%5C%22)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20document.body.appendChild(iframe);%5Cn%20%20%20%20%20%20%20%20%20%20iframe.style.position%20=%20%5C%22fixed%5C%22;%5Cn%20%20%20%20%20%20%20%20%20%20iframe.style.zIndex%20=%20%5C%229999999%5C%22;%5Cn%20%20%20%20%20%20%20%20%20%20iframe.style.top%20=%20%5C%220%5C%22;%20iframe.style.left%20=%20%5C%220%5C%22;%5Cn%20%20%20%20%20%20%20%20%20%20document.scrollingElement.style.overflow%20=%20%5C%22hidden%5C%22;%5Cn%20%20%20%20%20%20%20%20%20%20ctn.dataset.isFullscreen%20=%20%5C%22yes%5C%22;%5Cn%20%20%20%20%20%20%20%20%20%20//%20link%20the%20iframe%20and%20ctn%20with%20an%20id%20so%20we%20can%20get%20the%20ctn,%20given%20the%20id%20from%20the%20iframe%20that%20sent%20the%20%5C%22toggle_fullscreen%5C%22%20message:%5Cn%20%20%20%20%20%20%20%20%20%20let%20commentsCtnId%20=%20Math.random();%5Cn%20%20%20%20%20%20%20%20%20%20ctn.dataset.commentsCtnId%20=%20commentsCtnId;%5Cn%20%20%20%20%20%20%20%20%20%20iframe.dataset.commentsCtnId%20=%20commentsCtnId;%5Cn%20%20%20%20%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20ctn.appendChild(iframe);%5Cn%20%20%20%20%20%20%20%20%20%20iframe.style.position%20=%20%5C%22%5C%22;%5Cn%20%20%20%20%20%20%20%20%20%20iframe.style.zIndex%20=%20%5C%22%5C%22;%5Cn%20%20%20%20%20%20%20%20%20%20iframe.style.top%20=%20%5C%22%5C%22;%20iframe.style.left%20=%20%5C%22%5C%22;%20%5Cn%20%20%20%20%20%20%20%20%20%20document.scrollingElement.style.overflow%20=%20%5C%22%5C%22;%5Cn%20%20%20%20%20%20%20%20%20%20ctn.dataset.isFullscreen%20=%20%5C%22no%5C%22;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn//%20%20%20%20%20%20%20%20%20if(ctn.dataset.isFullscreen%20===%20%5C%22no%5C%22)%20%7B%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.dataset.originalCssHeight%20=%20ctn.style.height;%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.dataset.originalCssWidth%20=%20ctn.style.width;%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.dataset.originalCssPosition%20=%20ctn.style.position;%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.dataset.originalCssZIndex%20=%20ctn.style.zIndex;%5Cn%20%20%20%20%20%20%20%20%20%20%5Cn//%20%20%20%20%20%20%20%20%20%20%20//%20we%20need%20to%20change%20the%20ancestor%20z%20indices%20too:%5Cn//%20%20%20%20%20%20%20%20%20%20%20let%20ancestorEls%20=%20%5B%5D;%5Cn//%20%20%20%20%20%20%20%20%20%20%20let%20aEl%20=%20ctn.parentElement;%5Cn//%20%20%20%20%20%20%20%20%20%20%20while(aEl%20!==%20document.body)%20%7B%5Cn//%20%20%20%20%20%20%20%20%20%20%20%20%20ancestorEls.push(aEl);%5Cn//%20%20%20%20%20%20%20%20%20%20%20%20%20aEl%20=%20aEl.parentElement;%5Cn//%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn//%20%20%20%20%20%20%20%20%20%20%20let%20ancestorZIndices%20=%20ancestorEls.map(el%20=%3E%20el.style.zIndex);%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.dataset.originalAncestorZIndices%20=%20JSON.stringify(ancestorZIndices);%5Cn//%20%20%20%20%20%20%20%20%20%20%20ancestorEls.forEach(el%20=%3E%20el.style.zIndex=%5C%2263829472%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.style.height%20=%20%5C%22%5C%22;%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.style.width%20=%20%5C%22%5C%22;%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.style.position%20=%20%5C%22fixed%5C%22;%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.style.zIndex%20=%20%5C%2263829472%5C%22;%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.style.top%20=%20%5C%220%5C%22;%20ctn.style.left%20=%20%5C%220%5C%22;%20ctn.style.right%20=%20%5C%220%5C%22;%20ctn.style.bottom%20=%20%5C%220%5C%22;%5Cn//%20%20%20%20%20%20%20%20%20%20%20document.scrollingElement.style.overflow%20=%20%5C%22hidden%5C%22;%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.dataset.isFullscreen%20=%20%5C%22yes%5C%22;%5Cn//%20%20%20%20%20%20%20%20%20%7D%20else%20if(ctn.dataset.isFullscreen%20===%20%5C%22yes%5C%22)%20%7B%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.style.height%20=%20ctn.dataset.originalCssHeight;%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.style.width%20=%20ctn.dataset.originalCssWidth;%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.style.position%20=%20ctn.dataset.originalCssPosition;%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.style.zIndex%20=%20ctn.dataset.originalCssZIndex;%5Cn%20%20%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20%20%20%5Cn//%20%20%20%20%20%20%20%20%20%20%20let%20ancestorEls%20=%20%5B%5D;%5Cn//%20%20%20%20%20%20%20%20%20%20%20let%20aEl%20=%20ctn.parentElement;%5Cn//%20%20%20%20%20%20%20%20%20%20%20while(aEl%20!==%20document.body)%20%7B%5Cn//%20%20%20%20%20%20%20%20%20%20%20%20%20ancestorEls.push(aEl);%5Cn//%20%20%20%20%20%20%20%20%20%20%20%20%20aEl%20=%20aEl.parentElement;%5Cn//%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn//%20%20%20%20%20%20%20%20%20%20%20let%20originalAncestorZIndices%20=%20JSON.parse(ctn.dataset.originalAncestorZIndices);%5Cn//%20%20%20%20%20%20%20%20%20%20%20ancestorEls.forEach((el,%20i)%20=%3E%20el.style.zIndex=originalAncestorZIndices%5Bi%5D);%5Cn%20%20%20%20%20%20%20%20%20%20%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.style.top%20=%20%5C%22%5C%22;%20ctn.style.left%20=%20%5C%22%5C%22;%20ctn.style.right%20=%20%5C%22%5C%22;%20ctn.style.bottom%20=%20%5C%22%5C%22;%5Cn//%20%20%20%20%20%20%20%20%20%20%20document.scrollingElement.style.overflow%20=%20%5C%22%5C%22;%5Cn//%20%20%20%20%20%20%20%20%20%20%20ctn.dataset.isFullscreen%20=%20%5C%22no%5C%22;%5Cn//%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D,%20false);%5Cn%20%20%5Cn%20%20%20%20let%20cssText%20=%20%60%5Cn%20%20%20%20.comments-plugin-ctn%20%7B%5Cn%20%20%20%20%20%20position:relative;%5Cn%20%20%20%20%20%20display:inline-block;%5Cn%20%20%20%20%7D%5Cn%20%20%20%20.loading-spinner-434142%20%7B%20%5Cn%20%20%20%20%20%20border:%204px%20solid%20#f3f3f3;%5Cn%20%20%20%20%20%20border-top:%204px%20solid%20#5d5d5d;%5Cn%20%20%20%20%20%20border-radius:%2050%25;%5Cn%20%20%20%20%20%20width:%2030px;%5Cn%20%20%20%20%20%20height:%2030px;%5Cn%20%20%20%20%20%20animation:%20spin%200.9s%20linear%20infinite;%5Cn%20%20%20%20%7D%5Cn%20%20%20%20@keyframes%20spin%20%7B%5Cn%20%20%20%20%20%200%25%20%7B%20transform:%20rotate(0deg);%20%7D%5Cn%20%20%20%20%20%20100%25%20%7B%20transform:%20rotate(360deg);%20%7D%5Cn%20%20%20%20%7D%60;%5Cn%20%20%20%20let%20styleEl%20=%20document.createElement('style');%5Cn%20%20%20%20styleEl.appendChild(document.createTextNode(cssText));%5Cn%20%20%20%20document.head.appendChild(styleEl);%5Cn%20%20%20%20%5Cn%20%20%20%20//%20let%20addCommentsPluginInterval%20=%20setInterval(()%20=%3E%20%7B%5Cn%20%20%20%20//%20%20%20document.querySelectorAll(%5C%22.___perchance-comments-plugin-marker%5C%22).forEach(markerEl%20=%3E%20%7B%5Cn%20%20%20%20//%20%20%20%20%20//%20detect%20if%20a%20comments%20section%20has%20been%20injected%20after%20it%20yet%20(edit:%20for%20some%20reason%20it's%20injected%20before%20it?):%5Cn%20%20%20%20//%20%20%20%20%20if((!markerEl.nextElementSibling%20%7C%7C%20markerEl.nextElementSibling.dataset.isCommentsSection%20!==%20%5C%22true%5C%22)%20&&%20(!markerEl.previousElementSibling%20%7C%7C%20markerEl.previousElementSibling.dataset.isCommentsSection%20!==%20%5C%22true%5C%22))%20%7B%5Cn%20%20%20%20//%20%20%20%20%20%20%20let%20div%20=%20document.createElement(%5C%22div%5C%22);%5Cn%20%20%20%20//%20%20%20%20%20%20%20let%20containerStyle%20=%20markerEl.dataset.containerStyle;%5Cn%20%20%20%20//%20%20%20%20%20%20%20let%20queryString%20=%20markerEl.dataset.queryString;%5Cn%20%20%20%20//%20%20%20%20%20%20%20let%20folderName%20=%20markerEl.dataset.folderName;%5Cn%20%20%20%20//%20%20%20%20%20%20%20div.innerHTML%20=%20%60%3Cdiv%20class=%5C%22comments-plugin-ctn%5C%22%20data-is-comments-section=%5C%22true%5C%22%20style=%5C%22position:relative;%20display:inline-block;%20$%7BcontainerStyle%7D%5C%22%3E%5Cn%20%20%20%20//%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%5C%22__perchance-comments-loading-facade-12345%5C%22%20style=%5C%22position:absolute;%20top:0;%20left:0;%20right:0;%20bottom:0;%20display:flex;%20align-items:center;%20justify-content:center;%20background:white;%20border:1px%20solid%20rgba(0,0,0,0.25);%20border-radius:2px;%5C%22%3E%3Cdiv%20class=%5C%22loading-spinner-434142%5C%22%3E%3C/div%3E%3C/div%3E%5Cn%20%20%20%20//%20%20%20%20%20%20%20%20%20%3Ciframe%20class=%5C%22___perchance-comments-plugin-iframe-12345%5C%22%20src=%5C%22https://comments-plugin.perchance.org/embed/$%7BfolderName%7D?$%7BqueryString%7D%5C%22%20style=%5C%22border:0;%20width:100%25;%20height:100%25;%5C%22%3E%3C/iframe%3E%5Cn%20%20%20%20//%20%20%20%20%20%20%20%3C/div%3E%60;%5Cn%20%20%20%20//%20%20%20%20%20%20%20let%20iframeContainer%20=%20div.firstElementChild;%5Cn%20%20%20%20//%20%20%20%20%20%20%20//debugger;%5Cn%20%20%20%20//%20%20%20%20%20%20%20markerEl.after(iframeContainer);%5Cn%20%20%20%20//%20%20%20%20%20%20%20clearInterval(addCommentsPluginInterval);%5Cn%20%20%20%20//%20%20%20%20%20%7D%5Cn%20%20%20%20//%20%20%20%7D);%5Cn%20%20%20%20//%20%7D,%20200);%5Cn%20%20%20%20%5Cn%20%20%20%20window.___alreadyAddedCommentsPluginStuff43211234%20=%20true;%5Cn%20%20%7D%5Cn%5Cn%20%20let%20colorScheme%20=%20window.matchMedia%20&&%20window.matchMedia('(prefers-color-scheme:%20dark)').matches%20?%20%5C%22dark%5C%22%20:%20%5C%22light%5C%22;%5Cn%20%20if(opts.forceColorScheme)%20colorScheme%20=%20opts.forceColorScheme.evaluateItem;%5Cn%20%20%5Cn%20%20%5Cn%20%20if(opts.replacedDuringUpdate)%20%7B%5Cn%20%20%20%20return%20%60%3Cdiv%20data-is-fullscreen=%5C%22no%5C%22%20data-comments-section-folder-name=%5C%22$%7BfolderName%7D%5C%22%20class=%5C%22comments-plugin-ctn%5C%22%20data-is-comments-section=%5C%22true%5C%22%20style=%5C%22$%7BcontainerStyle%7D%5C%22%3E%5Cn%20%20%20%20%20%20%3Cdiv%20class=%5C%22__perchance-comments-loading-facade-12345%5C%22%20style=%5C%22position:absolute;%20top:0;%20left:0;%20right:0;%20bottom:0;%20display:flex;%20align-items:center;%20justify-content:center;%20background:$%7BcolorScheme%20===%20%5C%22light%5C%22%20?%20%5C%22white%5C%22%20:%20%5C%22#131516%5C%22%7D;%20border:1px%20solid%20rgba(0,0,0,0.25);%20border-radius:2px;%5C%22%3E%3Cdiv%20class=%5C%22loading-spinner-434142%5C%22%3E%3C/div%3E%3C/div%3E%5Cn%20%20%20%20%20%20%3Ciframe%20loading=%5C%22lazy%5C%22%20class=%5C%22___perchance-comments-plugin-iframe-12345%5C%22%20src=%5C%22https://comments-plugin.perchance.org/embed/$%7BfolderName%7D?$%7BqueryString%7D#$%7BencodeURIComponent(JSON.stringify(urlHashData))%7D%5C%22%20style=%5C%22border:0;%20width:100%25;%20height:100%25;%5C%22%3E%3C/iframe%3E%5Cn%20%20%20%20%3C/div%3E%60;%5Cn%20%20%7D%5Cn%20%20%20%20%5Cn%20%20if(!document.querySelector(%60%5Bdata-comments-section-folder-name=%5C%22$%7BfolderName%7D%5C%22%5D%60))%20%7B%5Cn%5Cn%20%20%20%20function%20swapMarkerElForRealEl()%20%7B%5Cn%20%20%20%20%20%20let%20markerEl%20=%20document.querySelector(%60%5Bdata-marker-tag=%5C%22temporaryMarkerElForCommentsPlugin84738932-folderName-$%7BfolderName%7D%5C%22%5D%60);%5Cn%20%20%20%20%20%20if(!markerEl)%20return;%5Cn%20%20%20%20%20%20let%20containerStyle%20=%20markerEl.dataset.containerStyle;%5Cn%20%20%20%20%20%20let%20queryString%20=%20markerEl.dataset.queryString;%5Cn%20%20%20%20%20%20let%20urlHashDataEncoded%20=%20markerEl.dataset.urlHashDataEncoded;%5Cn%20%20%20%20%20%20//%20let%20folderName%20=%20markerEl.dataset.folderName;%5Cn%5Cn%20%20%20%20%20%20//%20NOTE:%20we%20don't%20use%20replaceWith%20here%20because%20that%20approach%20would%20mean%20that%20this%20would%20get%20updated%20during%20update()%20calls%5Cn%20%20%20%20%20%20markerEl.outerHTML%20=%20%60%3Cdiv%20data-is-fullscreen=%5C%22no%5C%22%20data-comments-section-folder-name=%5C%22$%7BfolderName%7D%5C%22%20class=%5C%22comments-plugin-ctn%5C%22%20data-is-comments-section=%5C%22true%5C%22%20style=%5C%22$%7BcontainerStyle%7D%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Cdiv%20class=%5C%22__perchance-comments-loading-facade-12345%5C%22%20style=%5C%22position:absolute;%20top:0;%20left:0;%20right:0;%20bottom:0;%20display:flex;%20align-items:center;%20justify-content:center;%20background:$%7BcolorScheme%20===%20%5C%22light%5C%22%20?%20%5C%22white%5C%22%20:%20%5C%22#131516%5C%22%7D;%20border:1px%20solid%20rgba(0,0,0,0.25);%20border-radius:2px;%5C%22%3E%3Cdiv%20class=%5C%22loading-spinner-434142%5C%22%3E%3C/div%3E%3C/div%3E%5Cn%20%20%20%20%20%20%20%20%3Cspan%20class=%5C%22__perchance-comments-iframe-placeholder-el-12345%5C%22%3E%3C/span%3E%5Cn%20%20%20%20%20%20%3C/div%3E%60;%5Cn%5Cn%20%20%20%20%20%20let%20commentsCtn%20=%20document.querySelector(%60%5Bdata-comments-section-folder-name=%5C%22$%7BfolderName%7D%5C%22%5D:not(.already-added-intersection-observer-to-this-comments-plugin-ctn)%60);%20//%20get%20the%20first%20one%20that%20we%20haven't%20added%20an%20intersection%20observer%20for%20yet%20-%20this%20is%20needed%20because%20they%20could%20have%20multiple%20instances%20of%20the%20same%20channel%20on%20the%20page,%20and%20we%20don't%20want%20to%20add%20all%20the%20intersection%20observers%20to%20the%20first%20one%5Cn%20%20%20%20%20%20commentsCtn.classList.add(%5C%22already-added-intersection-observer-to-this-comments-plugin-ctn%5C%22);%5Cn%5Cn%20%20%20%20%20%20//%20lazyload%20the%20iframe,%20because%20some%20generator%20pages%20have%20literally%20dozens%20of%20different%20channels:%5Cn%20%20%20%20%20%20const%20observer%20=%20new%20IntersectionObserver(entries%20=%3E%20%7B%5Cn%20%20%20%20%20%20%20%20if(entries%5B0%5D.isIntersecting)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20observer.disconnect();%5Cn%20%20%20%20%20%20%20%20%20%20console.log(%5C%22comments%20ctn:%20Visible%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20let%20placeholder%20=%20commentsCtn.querySelector(%5C%22.__perchance-comments-iframe-placeholder-el-12345%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20if(placeholder)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20let%20iframeHtml%20=%20%60%3Ciframe%20class=%5C%22___perchance-comments-plugin-iframe-12345%5C%22%20src=%5C%22https://comments-plugin.perchance.org/embed/$%7BfolderName%7D?$%7BqueryString%7D#$%7BurlHashDataEncoded%7D%5C%22%20style=%5C%22border:0;%20width:100%25;%20height:100%25;%5C%22%3E%3C/iframe%3E%60;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20//%20EDIT:%20this%20doesn't%20seem%20to%20be%20working%20properly,%20so%20I've%20decided%20to%20just%20handle%20the%20replacedDuringUpdate%20stuff%20with%20loading=%5C%22lazy%5C%22%20-%20see%20above.%5Cn%20%20%20%20%20%20%20%20%20%20%20%20//%20if(opts.replacedDuringUpdate)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20//%20%20%20let%20tmp%20=%20document.createElement(%5C%22div%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20//%20%20%20tmp.innerHTML%20=%20iframeHtml;%20//%20note:%20iframe%20doesn't%20actually%20load%20until%20we%20add%20it%20to%20the%20DOM,%20which%20is%20what%20we%20want,%20else%20we'd%20wastefully%20load%20it,%20and%20then%20reload%20it%20when%20we%20call%20replaceWith%20due%20to%20how%20reparenting%20affects%20iframes%5Cn%20%20%20%20%20%20%20%20%20%20%20%20//%20%20%20let%20iframe%20=%20tmp.firstElementChild;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20//%20%20%20placeholder.replaceWith(iframe);%20//%20replaceWith%20'respects'%20perchance's%20template%20node%20tracking,%20so%20it's%20actually%20swapped%20into%20the%20place%20of%20the%20placeholder%20node%20(which%20is%20tracked)%20so%20it%20is%20now%20tracked%20instead,%20which%20means%20it'll%20get%20replaced%20during%20the%20update,%20just%20as%20the%20placeholder%20element%20would%20have%5Cn%20%20%20%20%20%20%20%20%20%20%20%20//%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20placeholder.outerHTML%20=%20iframeHtml;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20//%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D);%5Cn%20%20%20%20%20%20observer.observe(commentsCtn);%5Cn%20%20%20%20%7D%5Cn%5Cn%20%20%20%20//%20setTimeout(swapMarkerElForRealEl,%2050);%5Cn%5Cn%20%20%20%20//%20the%20above%20commented-out%20setTimeout%20one-liner%20was%20the%20previous%20approach.%20the%20below%20MutationObserver-based%20monstrosity%20is%20a%20bit%20better%20because%20it%20ensures%20the%20swap%20happens%20*the%20moment*%20that%20the%20marker%20is%20added%20to%20the%20page,%20and%20we%20can%20wait%20a%20long%20time%20without%20the%20need%20for%20polling%5Cn%20%20%20%20let%20markerEl%20=%20document.querySelector(%60%5Bdata-marker-tag=%5C%22temporaryMarkerElForCommentsPlugin84738932-folderName-$%7BfolderName%7D%5C%22%5D%60);%5Cn%20%20%20%20if(markerEl)%20%7B%5Cn%20%20%20%20%20%20swapMarkerElForRealEl();%5Cn%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20let%20foundElement%20=%20false;%5Cn%20%20%20%20%20%20let%20markerTagValue%20=%20%60temporaryMarkerElForCommentsPlugin84738932-folderName-$%7BfolderName%7D%60;%5Cn%20%20%20%20%20%20let%20observer%20=%20new%20MutationObserver((mutations)%20=%3E%20%7B%5Cn%20%20%20%20%20%20%20%20for(let%20mutation%20of%20mutations)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20for(let%20node%20of%20mutation.addedNodes)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20if(node.dataset%20&&%20node.dataset.markerTag%20===%20markerTagValue)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20foundElement%20=%20true;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20if(node.querySelector)%20%7B%20//%20skip%20#text,%20#comment,%20etc.%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20since%20mutation%20observers%20don't%20trigger%20for%20all%20subnodes%20-%20only%20the%20highest-level%20nodes%20in%20a%20mutation%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20markerEl%20=%20node.querySelector(%60%5Bdata-marker-tag=%5C%22temporaryMarkerElForCommentsPlugin84738932-folderName-$%7BfolderName%7D%5C%22%5D%60);%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(markerEl)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20foundElement%20=%20true;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20if(foundElement)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20observer.disconnect();%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20swapMarkerElForRealEl();%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20return;%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D);%5Cn%20%20%20%20%20%20observer.observe(document.body,%20%7B%20childList:%20true,%20subtree:%20true%20%7D);%5Cn%20%20%20%20%20%20setTimeout(()%20=%3E%20%7B%5Cn%20%20%20%20%20%20%20%20if(!foundElement)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20console.error(%5C%22Couldn't%20find%20marker%20element%20for%20comments%20plugin?%5C%22);%5Cn%20%20%20%20%20%20%20%20%20%20observer.disconnect();%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D,%2010000);%5Cn%20%20%20%20%7D%5Cn%5Cn%20%20%20%20return%20%60%3Cspan%20data-marker-tag=%5C%22temporaryMarkerElForCommentsPlugin84738932-folderName-$%7BfolderName%7D%5C%22%20data-folder-name=%5C%22$%7BfolderName%7D%5C%22%20data-container-style=%5C%22$%7BcontainerStyle%7D%5C%22%20data-query-string=%5C%22$%7BqueryString%7D%5C%22%20data-url-hash-data-encoded=%5C%22$%7BencodeURIComponent(JSON.stringify(urlHashData))%7D%5C%22%3E%3C/span%3E%60;%5Cn%20%20%7D%20else%20%7B%5Cn%20%20%20%20return%20%5C%22%5C%22;%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20%5Cn%5Cn%5Cn//%20%20%20//%20This%20is%20a%20temporary%20fix%20because%20editing%20the%20text%20next%20to%20where%20the%20plugin%20is%20placed%20(within%20the%20same%20HTML%20%5C%22node%5C%22?)%20will%20cause%20the%5Cn//%20%20%20//%20comments%20section%20to%20disappear%20which%20causes%20users%20to%20think%20that%20they%20can't%20edit%20the%20positioning%20of%20the%20comments.%20So%20we%20tell%20them%20to%5Cn//%20%20%20//%20refresh%20the%20page.%20Ideally%20I'd%20fix%20this%20like%20I%20did%20with%20the%20text-to-image-plugin%20gallery%20-%20I%20just%20return/create%20a%20%5C%22fresh%5C%22%20one%20whenever%5Cn//%20%20%20//%20the%20old%20one%20isn't%20detected%20with%20querySelector.%5Cn//%20%20%20setTimeout(()%20=%3E%20%7B%5Cn//%20%20%20%20%20if(document.querySelectorAll(%5C%22.___perchance-comments-plugin-marker%5C%22).length%20!==%20document.querySelectorAll(%5C%22.comments-plugin-ctn%5C%22).length)%20%7B%5Cn//%20%20%20%20%20%20%20document.querySelectorAll(%5C%22.___perchance-comments-plugin-marker%5C%22).forEach(markerEl%20=%3E%20%7B%5Cn//%20%20%20%20%20%20%20%20%20markerEl.style.cssText%20=%20%60display:inline-block;%20border:1px%20solid%20grey;%20$%7BmarkerEl.dataset.containerStyle%7D%60;%5Cn//%20%20%20%20%20%20%20%20%20markerEl.innerHTML%20=%20%60%3Cdiv%20style=%5C%22height:100%25;%20display:flex;%20align-items:center;%20justify-content:center;%5C%22%3E%3Cspan%20style=%5C%22opacity:0.6;%20padding:1rem;%5C%22%3EPlease%20save%20your%20generator%20and%20refresh%20the%20page%20to%20reload%20the%20comments%20plugin.%3C/span%3E%3C/div%3E%60;%5Cn//%20%20%20%20%20%20%20%7D);%5Cn//%20%20%20%20%20%7D%5Cn//%20%20%20%7D,%20600);%5Cn%5Ct%5Cn//%20%5Ct//%20can't%20just%20inject%20the%20iframe%20directly%20otherwise%20it%20gets%20reloaded%20every%20time%20update()%20is%20called.%20So%20we%20need%20the%20setInterval%20monstrosity%20above.%5Cn//%20%5Ctreturn%20%60%3Cspan%20class=%5C%22___perchance-comments-plugin-marker%5C%22%20data-folder-name=%5C%22$%7BfolderName%7D%5C%22%20data-container-style=%5C%22$%7BcontainerStyle%7D%5C%22%20data-query-string=%5C%22$%7BqueryString%7D%5C%22%3E%3C/span%3E%60;%5Cn%20%20%5Cn%20%20%5Cn%20%20%5Cn%20%20%5Cn%20%20%5Cn%20%20%5Cn%20%20%5Cn%20%20%22,%22imports%22:%5B%5D,%22name%22:%22comments-plugin%22%7D,%7B%22modelText%22:%22$output(text,%20exitText,%20style)%20=%3E%20%5Cn%20%20if(!window.addedFullscreenEventListenerForPlugin39492749374)%20%7B%5Cn%20%20%20%20window.addEventListener(%5C%22fullscreenchange%5C%22,%20function(event)%20%7B%5Cn%20%20%20%20%20%20if(document.fullscreenElement)%20%7B%5Cn%20%20%20%20%20%20%20%20for(let%20btn%20of%20%5B...document.querySelectorAll(%5C%22.fullscreenButtonPluginButton938479832938%5C%22)%5D)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20btn.innerHTML%20=%20btn.dataset.exitText;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20%20%20for(let%20btn%20of%20%5B...document.querySelectorAll(%5C%22.fullscreenButtonPluginButton938479832938%5C%22)%5D)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20btn.innerHTML%20=%20btn.dataset.text;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D);%5Cn%20%20%20%20window.addedFullscreenEventListenerForPlugin39492749374%20=%20true;%5Cn%20%20%7D%5Cn%20%20if(!document.documentElement.requestFullscreen)%20document.documentElement.requestFullscreen%20=%20document.documentElement.webkitRequestFullscreen%20%7C%7C%20document.documentElement.mozRequestFullScreen%20%7C%7C%20document.documentElement.msRequestFullscreen;%5Cn%20%20if(!document.exitFullscreen)%20document.exitFullscreen%20=%20document.webkitExitFullscreen%20%7C%7C%20document.mozCancelFullScreen%20%7C%7C%20document.msExitFullscreen;%5Cn%20%20if(!document.documentElement.requestFullscreen)%20%7B%5Cn%20%20%20%20document.documentElement.requestFullscreen%20=%20function()%20%7B%5Cn%20%20%20%20%20%20alert(%5C%22The%20browser/device%20you're%20using%20doesn't%20support%20fullscreen%20mode.%5C%22);%5Cn%20%20%20%20%7D;%5Cn%20%20%7D%5Cn%20%20if(!document.exitFullscreen)%20%7B%5Cn%20%20%20%20document.exitFullscreen%20=%20function()%20%7B%5Cn%20%20%20%20%20%20alert(%5C%22The%20browser/device%20you're%20using%20doesn't%20support%20fullscreen%20mode.%5C%22);%5Cn%20%20%20%20%7D;%5Cn%20%20%7D%5Cn%20%20return%20%60%3Cbutton%20class=%5C%22fullscreenButtonPluginButton938479832938%5C%22%20data-text=%5C%22$%7Btext%20%7C%7C%20%5C%22Fullscreen%5C%22%7D%5C%22%20data-exit-text=%5C%22$%7BexitText%20%7C%7C%20%5C%22Exit%20Fullscreen%5C%22%7D%5C%22%20onclick=%5C%22(!document.fullscreenElement%20&&%20!document.webkitFullscreenElement%20&&%20!document.mozFullScreenElement%20&&%20!document.msFullscreenElement)%20?%20(document.documentElement.requestFullscreen(),%20this.innerHTML=this.dataset.exitText)%20:%20(document.exitFullscreen(),%20this.innerHTML=this.dataset.text)%5C%22%20style=%5C%22line-height:1.2rem;%20$%7Bstyle%20%7C%7C%20%5C%22%5C%22%7D%5C%22%3E$%7Btext%20%7C%7C%20%5C%22Fullscreen%5C%22%7D%3C/button%3E%60;%5Cn%5Ct%22,%22imports%22:%5B%5D,%22name%22:%22fullscreen-button-plugin%22%7D,%7B%22modelText%22:%22$output(data)%20=%3E%5Cn%20%20//%20if(typeof%20data%20!==%20%5C%22string%5C%22)%20return%20alert(%5C%22error:%20only%20text/strings%20are%20supported%20by%20the%20upload%20plugin%20for%20now.%20please%20request%20other%20types%20on%20the%20forum.%5C%22);%5Cn%20%20%5Cn%20%20if(!window.__alreadyLoadedUploadPluginStuff0435342908)%20%7B%5Cn%20%20%20%20window.__alreadyLoadedUploadPluginStuff0435342908%20=%20true;%5Cn%20%20%20%20%5Cn%20%20%20%20let%20iframe%20=%20document.createElement('iframe');%5Cn%20%20%20%20window.__uploadPluginIframe0435342908%20=%20iframe;%20%5Cn%20%20%20%20%5Cn%20%20%20%20window.addEventListener('message',%20(event)%20=%3E%20%7B%5Cn%20%20%20%20%20%20if(event.source%20!==%20iframe.contentWindow)%20return;%5Cn%20%20%20%20%20%20if(event.origin%20!==%20%5C%22https://upload.perchance.org%5C%22)%20return;%5Cn%20%20%20%20%20%20console.log(%5C%22upload%20plugin%20got%20message:%5C%22,%20event);%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20if(event.data.type%20===%20%5C%22uploadEmbedIsReady%5C%22)%20%7B%20%20%20%5Cn%20%20%20%20%20%20%20%20window.__uploadPluginEmbedIsReady%20=%20true;%5Cn%20%20%20%20%20%20%20%20console.log(%5C%22upload%20plugin%20embedIsReady%5C%22);%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D);%5Cn%20%20%20%20%5Cn%20%20%20%20//%20email==false%20implies%20anon%20upload%5Cn%20%20%20%20iframe.src%20=%20%60https://upload.perchance.org/embed#$%7BJSON.stringify(%7Bemail:false,%20sessionToken:false%7D)%7D%60;%5Cn%20%20%20%20iframe.style.cssText%20=%20'width:1px;%20height:1px;%20border:none;%20top:-100px;%20left:-100px;%20position:fixed;';%5Cn%20%20%20%20document.body.appendChild(iframe);%5Cn%20%20%20%20%5Cn%20%20%20%20//%20ping%20embed%20until%20it%20is%20ready%20(hacky%20way%20to%20wait%20for%20it%20to%20load)%5Cn%20%20%20%20(async%20function()%20%7B%5Cn%20%20%20%20%20%20await%20new%20Promise(r%20=%3E%20setTimeout(r,%20500));%5Cn%20%20%20%20%20%20while(!window.__uploadPluginEmbedIsReady)%20%7B%5Cn%20%20%20%20%20%20%20%20await%20new%20Promise(r%20=%3E%20setTimeout(r,%20200));%5Cn%20%20%20%20%20%20%20%20iframe.contentWindow.postMessage(%7Btype:%5C%22init%5C%22%7D,%20'https://upload.perchance.org');%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D)();%5Cn%20%20%7D%5Cn%20%20%5Cn%20%20let%20iframe%20=%20window.__uploadPluginIframe0435342908;%5Cn%20%20%5Cn%20%20let%20requestId%20=%20%5C%22id%5C%22+(Math.random().toString()+Math.random().toString()).replaceAll(%5C%22.%5C%22,%20%5C%22%5C%22);%5Cn%20%20%5Cn%20%20let%20promiseResolver,%20promiseRejecter;%5Cn%20%20let%20promise%20=%20new%20Promise((resolve,%20reject)%20=%3E%20%7B%5Cn%20%20%20%20promiseResolver%20=%20resolve;%5Cn%20%20%20%20promiseRejecter%20=%20reject;%20//%20unused.%5Cn%20%20%7D);%5Cn%20%20%5Cn%20%20function%20messageHandler(event)%20%7B%5Cn%20%20%20%20if(event.source%20!==%20iframe.contentWindow)%20return;%5Cn%20%20%20%20if(event.origin%20!==%20%5C%22https://upload.perchance.org%5C%22)%20return;%5Cn%5Cn%20%20%20%20if(event.data.type%20===%20%5C%22anonUploadResponse%5C%22%20&&%20event.data.requestId%20===%20requestId)%20%7B%5Cn%20%20%20%20%20%20let%20url%20=%20event.data.result.url;%5Cn%20%20%20%20%20%20let%20error%20=%20event.data.result.error;%5Cn%20%20%20%20%20%20let%20size%20=%20event.data.result.size;%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20if(!error)%20error%20=%20null;%20//%20just%20make%20sure%20it's%20null%20rather%20than%20'undefined',%20since%20that's%20part%20of%20the%20specified%20behavior%5Cn%20%20%20%20%20%20promiseResolver(%7Burl,%20error,%20size%7D);%20//%20always%20'resolve'%20(i.e.%20we%20don't%20%60reject%60%20on%20error).%20easier%20for%20people%20to%20handle%20errors%20without%20knowing%20about%20try/catch%20stuff%20-%20they%20just%20check%20if%20%60error%60%20is%20null%5Cn%20%20%20%20%20%20window.removeEventListener('message',%20messageHandler);%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20let%20el%20=%20document.querySelector(%60#$%7BrequestId%7D%60);%5Cn%20%20%20%20%20%20if(el)%20%7B%5Cn%20%20%20%20%20%20%20%20if(error)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20el.innerHTML%20=%20error;%5Cn%20%20%20%20%20%20%20%20%7D%20else%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20el.innerHTML%20=%20%60%3Ca%20href=%5C%22$%7Burl%7D%5C%22%20target=%5C%22_blank%5C%22%3E$%7Burl%7D%3C/a%3E%60;%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20if(error)%20%7B%5Cn%20%20%20%20%20%20%20%20let%20div%20=%20document.createElement(%5C%22div%5C%22);%5Cn%20%20%20%20%20%20%20%20div.innerHTML%20=%20%60%3Cdiv%20style=%5C%22z-index:1000;%20position:%20fixed;%20bottom:%201rem;%20width:%20100%25;%20pointer-events:none;%5C%22%3E%3Cspan%20style=%5C%22%20padding:%200.5rem;%20background:%20#ac2c2c;%20border-radius:%203px;%20color:%20white;%20pointer-events:auto;%5C%22%3Eupload%20error:%20$%7Berror.replaceAll(%5C%22_%5C%22,%20%5C%22%20%5C%22)%7D%3C/span%3E%3C/div%3E%60;%5Cn%20%20%20%20%20%20%20%20div%20=%20div.firstElementChild;%5Cn%20%20%20%20%20%20%20%20document.body.appendChild(div);%5Cn%20%20%20%20%20%20%20%20setTimeout(()%20=%3E%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20div.remove();%5Cn%20%20%20%20%20%20%20%20%7D,%201000*5);%5Cn%20%20%20%20%20%20%7D%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%20%20window.addEventListener('message',%20messageHandler);%5Cn%20%20%5Cn%20%20(async%20function()%20%7B%5Cn%20%20%20%20while(!window.__uploadPluginEmbedIsReady)%20%7B%5Cn%20%20%20%20%20%20console.log(%5C%22waiting%20for%20upload%20iframe%20embed%20to%20be%20ready%5C%22);%5Cn%20%20%20%20%20%20await%20new%20Promise(r%20=%3E%20setTimeout(r,%20100));%5Cn%20%20%20%20%7D%5Cn%20%20%20%20%5Cn%20%20%20%20function%20blobToDataUrl(blob)%20%7B%5Cn%20%20%20%20%20%20return%20new%20Promise((resolve,%20_)%20=%3E%20%7B%5Cn%20%20%20%20%20%20%20%20const%20reader%20=%20new%20FileReader();%5Cn%20%20%20%20%20%20%20%20reader.onloadend%20=%20()%20=%3E%20resolve(reader.result);%5Cn%20%20%20%20%20%20%20%20reader.readAsDataURL(blob);%5Cn%20%20%20%20%20%20%7D);%5Cn%20%20%20%20%7D%5Cn%20%20%20%20%5Cn%20%20%20%20let%20dataUrl;%5Cn%20%20%20%20if(typeof%20data%20===%20%5C%22string%5C%22)%20dataUrl%20=%20%60data:text/plain;charset=utf-8,$%7BencodeURIComponent(data)%7D%60;%5Cn%20%20%20%20if(data%20instanceof%20Blob)%20dataUrl%20=%20await%20blobToDataUrl(data);%5Cn%20%20%20%20%5Cn%20%20%20%20iframe.contentWindow.postMessage(%7Btype:%5C%22anonUploadRequest%5C%22,%20requestId,%20dataUrl,%20generatorName:window.generatorName%7D,%20'https://upload.perchance.org');%5Cn%20%20%7D)();%5Cn%20%20%5Cn%20%20promise.toString%20=%20function()%20%7B%5Cn%20%20%20%20return%20%60%3Cspan%20id=%5C%22$%7BrequestId%7D%5C%22%3Euploading...%3C/span%3E%60;%5Cn%20%20%7D;%5Cn%20%20return%20promise;%5Cn%5Cn%5Cn%5Cn%22,%22imports%22:%5B%5D,%22name%22:%22upload-plugin%22%7D%5D</script>
        <script id="imported-generator-names" type="notjs">%5B%22ai-text-plugin%22,%22comments-plugin%22,%22fullscreen-button-plugin%22,%22upload-plugin%22%5D</script>
        <script id="this-html-server-render-time" type="notjs">1711279638237</script>
        
        
        <script>window.generatorPublicId = "3ed577a8ef2db1575c94395be05e8192";</script>


        <script>
          window.generatorData = window.js0nparse( decodeURI( document.querySelector("#preloaded-generator-data").innerText ) );
          window.generatorCanLinkWithRelFollow = generatorData.canLink; // make it global so the iframe-based description update has access to it.

          // For crawlers that don't have es6 support and thus can't execute the iframe:
          if(!window.canExecuteModernJavascript) {
            window.addEventListener("DOMContentLoaded", function() {
              var data = window.generatorData;

              window.document.querySelector("#generator-description").innerHTML = DOMPurify.sanitize(data.outputTemplate, {ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'p', 'div', 'pre', 'button', 'i', 'b', 'a', 'ul', 'li', 'br', 'ol', 'hr', 'span'], ALLOWED_ATTR: ['href']});
              var pre = document.createElement('pre');
              pre.innerText = data.modelText.slice(0, 10000);
              window.document.querySelector("#generator-description").appendChild(pre);
              
              window.document.querySelector("#generator-description").style.cssText = "";

              var h1 = window.document.querySelector("#generator-description h1");
              if(!h1) h1 = window.document.querySelector("#generator-description h2");
              if(h1) {
                var h1Text = h1.textContent;
                if(h1Text !== "Your Generator's Title" && h1Text !== "Minimal Example" && h1Text.indexOf("[") === -1 && h1Text.indexOf("]") === -1) {
                  document.title = h1Text+" ‚Äï Perchance" + (h1Text.toLowerCase().includes("gener") ? "" : " Generator");
                }
              } else {
                let title = window.location.pathname.slice(1).split("-").filter(function(a){return a;}).map(function(word){return word[0].toUpperCase()+word.slice(1); }).join(" ");
                document.title = title+" ‚Äï Perchance" + (title.toLowerCase().includes("gener") ? "" : " Generator");
              }

              if(!window.generatorCanLinkWithRelFollow) {
                var links = window.document.querySelectorAll("#generator-description a");
                for(var i = 0; i < links.length; i++) {
                  links[i].rel = "nofollow";
                }
              }
            });
          }
        </script>

        <script data-src="/tags/all-tags-compiled-BUNDLE.js?v=s2jdfh9438hf" type="riot/tag"></script>

        <!-- CODEMIRROR (stylesheets MUST come before javascript init) -->
        <!-- <link rel="stylesheet" href="/lib/codemirror/codemirror.css?v=3452338345">
        <link rel="stylesheet" href="/lib/codemirror/foldgutter.css?v=3453423554">
        <script src="/lib/codemirror/js/codemirror-5.51.0-BUNDLE.js?v=44s8534s53d4936"></script> -->

        <link rel="stylesheet" href="/lib/codemirror/5.65.15/css/codemirror-with-addons-bundle.css?v=2d">
        <script src="/lib/codemirror/5.65.15/js/codemirror-with-addons-bundle.min.js?v=2dd"></script>

        <script src="/lib/perchance/codeMirrorHighlighter.js?v=d24dddsdss7d49"></script>

        <!-- LIBS -->
        <script src="/lib/splitjs/split.min.js"></script>
        <script src="/lib/axios-0.15.3.min.js"></script>
        <script src="/lib/Store.js"></script>
        <script src="/lib/purify.min.js"></script>
        <script async src="/lib/diff_match_patch.js"></script>
        <!-- <script src="lib/diff.min.js"></script> -->


        <!-- CSS LOADING SPINNER -->
        <style>
          .ldspmzjfhueifssge-ring {
            display: inline-block;
            position: relative;
            width: 64px;
            height: 64px;
          }
          .ldspmzjfhueifssge-ring div {
            box-sizing: border-box;
            display: block;
            position: absolute;
            width: 51px;
            height: 51px;
            margin: 6px;
            border: 6px solid #444;
            border-radius: 50%;
            animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            border-color: #444 transparent transparent transparent;
          }
          .ldspmzjfhueifssge-ring div:nth-child(1) {
            animation-delay: -0.45s;
          }
          .ldspmzjfhueifssge-ring div:nth-child(2) {
            animation-delay: -0.3s;
          }
          .ldspmzjfhueifssge-ring div:nth-child(3) {
            animation-delay: -0.15s;
          }
          @keyframes lds-ring {
            0% {
              transform: rotate(0deg);
            }
            100% {
              transform: rotate(360deg);
            }
          }
          @media (prefers-color-scheme: dark) {
            #initialPageLoadSpinner {
              filter: invert(1);
            }
          }
        </style>
        <div id="initialPageLoadSpinner" style="z-index:2000; position: absolute; top: 40px; bottom: 0; left: 0; right: 0; display: flex; align-items: center; justify-content: center;"><div class="ldspmzjfhueifssge-ring"><div></div><div></div><div></div><div></div></div></div>
        <script>if(window.location.hash === "#edit" || window.location.hash === "#debugFreeze") initialPageLoadSpinner.style.display = "none";</script>

        <script>
          let thisIsNotAnOldCachedPageResolver;
          window.thisIsNotAnOldCachedPagePromise = new Promise(r => thisIsNotAnOldCachedPageResolver=r);
          // CloudFlare sometimes has cache purging delays, and these can really mess things up (e.g. make it look like you've lost hours of work).
          // We check the `age` header of this document, and if it's older than the last save time of this generator, then we load a cache-busted URL
          // and then remove the added cacheBust string with history.replaceState
          (async function() {
            if(navigator.webdriver) return; // just in case this is what's confusing the Google crawler - RE the title bug
            if(window.location.href.includes("__cacheBust")) {
              thisIsNotAnOldCachedPageResolver(true);
              return; // no need to run this check if cache is already busted
            }

            let imports = window.js0nparse(decodeURI(document.querySelector("#imported-generator-names").textContent));
            let clientHtmlServerRenderTime = Number(document.querySelector("#this-html-server-render-time").textContent);

            let weHaveAnOldVersionOfThisGen = await fetch(`https://perchance.org/api/clearCacheIfGeneratorOrImportsHaveBeenUpdated?generatorName=${window.location.pathname.slice(1)}&importedGeneratorNames=${imports.join(",")}&clientHtmlServerRenderTime=${clientHtmlServerRenderTime}&__cacheBust=${Math.random()}`).then(r => r.json()).catch(e => { console.error(e); return true; });
            if(weHaveAnOldVersionOfThisGen) {
              console.log("This is an old version of this generator. Doing cache bust reload now...");
              let url = new URL(window.location.href);
              url.searchParams.set("__cacheBust", Math.random());
              window.location.href = url.href;
            } else {
              thisIsNotAnOldCachedPageResolver(true);
            }
          })();
          if(location.href.includes("__cacheBust")) {
            window.needToBustCacheOfIframeOnInitialLoad = true;
            let url = new URL(window.location.href);
            url.searchParams.delete("__cacheBust");
            let newPath = url.href.replace(/^https:\/\/perchance\.org/, "");
            history.replaceState({}, "", newPath);
          }
        </script>

        <app></app>

        <!-- <script src="/lib/riotjs/riot-3.0.5.min.js"></script> -->
        <script src="/lib/riotjs/riot+compiler-3.0.5.min.js"></script>
        <script></script>
        <!--<script src="lib/riotjs/riot+compiler-3.13.2.min.js"></script>-->
        <script>window.remoteResourcesLoaded = true;</script>
        <script>
          window.empty883974329 = "";
          window.modalFn1Name = "alert";
          window.rlFn1Name = `relo${window.empty883974329}ad`;
          window.ftcFn1Name = "fetch";
          window.ap1pend1ChildFn2Name = "appendChild";
          window.doc34828272947 = "document";

          try { // adding try/catch here in case of future instances of this: https://lemmy.world/post/4913660
            window.generatorDependenciesData = window.js0nparse( decodeURI( document.querySelector("#imported-generators").innerText ) );
          } catch(e) {
            if(!location.href.includes("__generatorDependenciesCacheBust")) { // try a cache bust if we haven't already.
              let url = new URL(window.location.href);
              url.searchParams.set("__generatorDependenciesCacheBust", Math.random());
              window.location.href = url.href; 
              throw new Error("exiting script tag for dependency cache bust"); // since we can't `return` at top level
            } else { // if we've already tried bust, don't do it again, else it'll be a refresh loop
              window.generatorDependenciesData = [];
              let errorCode = 1;
              if(document.querySelector("#imported-generators").innerText === "") {
                errorCode = 2;
              } else {
                errorCode = 3;
                try {
                  decodeURI(document.querySelector("#imported-generators").innerText);
                } catch(e) {
                  errorCode = 4;
                }
              }
              alert(`There was some sort of bug parsing the imports of this generator. Buggy ad blockers can sometimes cause this. Please report this at https://lemmy.world/c/perchance and mention this error code: ${errorCode}`);
            }
          }

          if(location.href.includes("__generatorDependenciesCacheBust")) {
            let url = new URL(window.location.href);
            url.searchParams.delete("__generatorDependenciesCacheBust");
            let newPath = url.href.replace(/^https:\/\/perchance\.org/, "");
            history.replaceState({}, "", newPath);
          }

          window.iudu843975 = "bbb";
          if(iudu843975.includes("a")) {
            uruf8ufd.jfurwe8j;
          }
          if(iudu843975.includes("a")) {
            uruf8ufd.jfurwe8j;
          }
          if
          (`bbb`.includes("a")) {
            throw new Error("sus");
            uruf8ufd.jfurwe8j;
          }

          if(String.prototype.includes.toString().indexOf("return true") !== -1) {
            uruf8ufd.jfurwe8j;
          }
          
          if(window.generatorDependenciesData.filter(d => d.name === "ai-text-to-image-plugin" || d.name === "ai-text-plugin").length > 0 && !(window[`local${window.empty883974329}Storage`]["app-storage"] || "").includes("sessionToken")) {
            setTimeout(() => {
              `script> (function() { window.ad1sAreShowing = async () => let adEl window[window.doc34828272947].querySelector(".ad-providers-ctn-el"); if(adEl && adEl.innerHTML.length > 5 adEl.offsetParent !== null adEl.offsetHeight 20) return true; // 20 adEl.querySelector("iframe")) false; }; already1AddedAd3vertIfNeeded window.addEventListener("message", function(e) origin e.origin || e.originalEvent.origin; For Chrome, the property is in event.originalEvent object. if(origin "https://null.perchance.org" https://{window.generatorPublicId}.perchance.org) return; } if(e.data.type === (usingAdPowered+Plugin) window.location.pathname '/text-to-image-plugin' '/ai-text-plugin') ad2dAdvert(); }); setTimeout(() if(window.generatorData.imports.includes("ai-text-to-image-plugin") window.generatorData.imports.includes("ai-text-plugin")) }, 10); function ad2dAdvert() if(already1AddedAd3vertIfNeeded) if(window.location.hash "#edit") window[window.ftcFn1Name]("/api/count?key=uaine"); if((window[local+Storage]["app-storage"] window[local+Storage]["app-storage"].includes("sessionToken")) navigator.webdriver) not for logged-in users and screenshot bot window[window.ftcFn1Name]("/api/count?key=uaineala"); adCtn createAdCtn(); while(!window[window.doc34828272947].querySelector("#main")) await new Promise(r setTimeout(r, 200)); ResizeObserver(function() window[window.doc34828272947].querySelector("#main").style.bottom (adCtn.offsetHeight + 8*2)+"px"; }).observe(adCtn); ad1Provider6Name "freestar"; if(window.location.hash.startsWith("#ad1Provider6Name=")) window.location.hash.slice("#ad1Provider6Name=".length); if(ad1Provider6Name sni{("")+("") (window._a3d8 ? "d*li-_?s" : "")}gel "freestar" "sovrn") console.log("ad:", ad1Provider6Name); "")}gel; if(window.location.pathname "/fqruxwnngk") try to avoid multiple CMP popups, we choose one ad provider remember it: validad1Provider6Names ["freestar", "")}gel]; ad1Provider6NameSetTime window[local+Storage].ad1Provider6NameSetTime !isNaN(Number(window[local+Storage].ad1Provider6NameSetTime))? Number(window[local+Storage].ad1Provider6NameSetTime) daysBetweenRandomize 60; if(!window[local+Storage].ad1Provider6Name !validad1Provider6Names.includes(window[local+Storage].ad1Provider6Name) (ad1Provider6NameSetTime Date.now()-ad1Provider6NameSetTime 1000*60*60*24*daysBetweenRandomize)) window[local+Storage].ad1Provider6Name Math.random()  0.5 Date.now(); window[local+Storage].ad1Provider6Name; catch(e) console.error(e); "freestar") checkConsent() __tcfapi("getTCData", 2, (tcData, success) if(success) a tcData.purpose.consents[1]; b tcData.purpose.consents[10]; c tcData.purpose.legitimateInterests[10]; d tcData.eventStatus if((!a !b !c) & "cmpuishown") window.__tcfapi("displayConsentUi", {}); else window.userGaveAdConsent (async che1ckTCF() 100)); if(window.__tcfapi == undefined) setTimeout(che1ckTCF, 1000); checkConsent(); })(); adCtn.innerHTML div class="ad-providers-ctn-el" align="center" data-freestar-ad="__320x100 __970x90" id="perchanceorg_footer">/div>; window.freestar {}; window.freestar.queue []; window.freestar.config window.freestar.config.enabled_slots window.freestar.initCallback (window.freestar.config.enabled_slots.length 0) window.freestar.initCallbackCalled false window.freestar[newAd{ ""}Slots](window.freestar.config.enabled_slots) if(window.location.hash.includes("testCMP")) (inmobi choice): script window[window.doc34828272947].createElement("script"); script.src https://user-upload{ ""}s.perchance.org/file/63c85ff7ce3ecc0323e0bbd555078fad.js; window[window.doc34828272947].head[window.ap1pend1ChildFn2Name](script); while(!window.cmpScriptHasExecuted) 50)); script.dataset.cfasync "false"; script.async "https://a.pub.network/perchance-org/pubfig.min.js"; if(window.location.hash.includes("testAntiAdBlock")) anti -adblock: ""}s.perchance.org/file/01cea1291c0dbb7b775dc89a385d1d4a.js; window.freestar.config.enabled_slots.push({ placementName: "perchanceorg_footer", slotId: "perchanceorg_footer" "")}gel) this code needed ensure that load immediately after accepting cmp 'reconsider' window.addEventListener('adnginLoaderReady', function() __tcfapi('addEventListener', function(tcData, if(success (tcData.eventStatus 'tcloaded' 'useractioncomplete')) if(tcData.gdprApplies) __tcfapi('getVendorList', function(gvl, 'useractioncomplete') adngin.queue.push(function() adngin.cmd.startAuction(["responsive_banner"]); 'tcloaded') if(Object.keys(tcData.vendor.consents).length Object.keys(gvl.vendors).length Object.keys(tcData.purpose.consents).length Object.keys(gvl.purposes).length) id="adngin-responsive_banner-0">/div>; https://cdn.sni{("")+("") "")}gelweb.com/adengine/perchance.org/loader.js; setTimeout(async if(await window.ad1sAreShowing()) script.nonce "SEahoBjLmnC565bNlPFeWA"; "https://fundingchoicesmessages.google.com/i/pub-9885689965057708?ers=1"; {function signalGooglefcPresent() {if (!window.frames['googlefcPresent']) (window[window.doc34828272947].body) {const iframe window[window.doc34828272947].createElement('iframe'); iframe.style 'width: 0; height: border: none; z-index: -1000; left: -1000px; top: -1000px;'; iframe.style.display 'none'; iframe.name 'googlefcPresent'; window[window.doc34828272947].body [window.ap1pend1ChildFn2Name](iframe);} {setTimeout(signalGooglefcPresent, 0);}}}signalGooglefcPresent();})(); 30000); window.b8473892 if(window[local+Storage]["app-storage"] (already done above - just defend against future edit mistakes) window[window.ftcFn1Name]("/api/count?key=abt"); if(!(await window.ad1sAreShowing())) window[window.ftcFn1Name]("/api/count?key=abpr" ); if(window[local+Storage].abpr "1") window[window.ftcFn1Name]("/api/count?key=abpr2"); window[local+Storage].abpr "1"; scri12pts ifra2mes coo1kies clasi window[window.ftcFn1Name](https://cdn.sni{("")+("") "")}gelweb.com/adengine/perchance.org/loader.js).then(r r.text()).then(t t.includes(dou{ ""}bleclick) t.includes("adengine") t.includes("adconsent") t.includes("GDPR")).catch(e false)) window[window.ftcFn1Name]("/api/count?key=abprbclas"); if([...window[window.doc34828272947].querySelectorAll("iframe")].filter(el el.src).map(el URL(el.src).hostname).find(n n[ends{ ""}With](dou{ ""}bleclick.net) ""}With]("onetag-sys.com") ""}With]("openx.net") ""}With](".google.com") ""}With](amazon-ad{''}system.com) ""}With]("rubiconproject.com") ""}With]("criteo.com") ""}With]("3lift.com") ""}With]("googlesyndication.com") ""}With]("connectad.io"))) window[window.ftcFn1Name]("/api/count?key=abprbclasi"); if(window.userGaveAdConsent window.gdprDoesNotApply) if(window.js0nparse(window[local+Storage].id5id_privacy "{}").id5_consent true) if(clasi coo1kies) window[window.ftcFn1Name]("/api/count?key=abprbclasiadgc"); if(scri12pts maybe auction failed or whatever !coo1kies) window[window.modalFn1Name](Your browser seems be blocking cookies, which preventing ad{ "s"} from being shown. You may need add an exception 'perchance.org' your cookie blocker 'incognito browsing' feature. Sometimes VPN antivirus software has as bonus feature.\n\nWhy are necessary? Well, Perchance free doesn't have by default, but creator of generator imported ad-powered plugin (e.g. text-to-image plugin). Plugins use expensive server resources can only exist thanks "s"}. This page will auto-refresh 60 seconds (apologies).); generally "s"}, "s"}.\n\nPlease help keep it turning off blocker. (apologies).\n\n(NOTE: If still aren't loading you even blocker, then also turn 'cookie' perchance.org on built-in cookie-blocking antivirus/incognito/VPN/etc if feature).); start1WarnProcess(); window[window.ftcFn1Name]("/api/count?key=utoab"); 60000); 50); img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAtgAAABaAQMAAAC4+rO8AAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAANQTFRFXrP/I7IslgAAAB9JREFUeJztwYEAAAAAw6D5U1/gCFUBAAAAAAAAAHwDIFgAAVR0zeEAAAAASUVORK5CYII="/>; if(window.innerWidth 1400) div window[window.doc34828272947].createElement("div"); div.style.cssText position: absolute; right: font-family: sans-serif; background: #dedede; padding: 0.2rem 0.25rem; border-radius: 3px; cursor: pointer; color: #676767;; div.onclick window[window.modalFn1Name]('The funded via advertisements.'); div.id whyAd{ "s"}Button1El; div.innerHTML why "s"}?; adCtn[window.ap1pend1ChildFn2Name](div); 2000); window[window.doc34828272947].body [window.ap1pend1ChildFn2Name](adCtn); window.adCtn adCtn; abp|cookie|browser|async|ads|alert|ad{ ""}s; window.e7827462 100); /script> createAdCtn() maxHeight window.innerWidth 600 50 90; maxHeight; minHeight; 700) desktop minHeight mobile 100; 50; adCtn.style.cssText position:var(--does-not1-exist-98437593, fixed); bottom:8px; right:8px; left:8px; min-height:{minHeight}px; height:{maxHeight}px; overflow:hidden; text-align:center; display:flex; align-items:center; justify-content:center;; start1WarnProcess() warnEl helperNotice ""; 800) div>a href="https://user-upload{ "s"}.perchance.org/file/06b63cbc807acaf79bc25f114bb0dda1.webp" target="_blank">click here/a> it's working don't understand/div>; warnEl.innerHTML += style="max-width:700px; margin:0 auto;">span style="font-weight:bold; color:#f60000;">the author plugin. pls ad/cookie free. üò≥/span> {helperNotice "try Chrome Firefox working."}/div>; if(!window.adCtn) window[window.doc34828272947].body [window.ap1pend1ChildFn2Name](window.adCtn); window.adCtn[window.ap1pend1ChildFn2Name](warnEl); if(window[window.doc34828272947].querySelector(#whyAd{ ""}sButton1El)) window[window.doc34828272947].querySelector(#whyAd{ ""}sButton1El).style.display "none"; warnEl.remove(); window.ad1sAreShowing() !window.e7827462 !window.b8473892)) window.onbeforeunload undefined; window.location[rlFn1Name](); handler() if(!window.e7827462 !window.b8473892) deps window.generatorDependenciesData.map(d d.name); if(!deps.includes("ai-text-to-image-plugin") !deps.includes("ai-text-plugin")) setTimeout(handler, 10001);`;
              document.elementFromPoint;
              document.body.innerHTML;
              window[window.doc34828272947];
              window.alert;
              window.document;
              window.location;
              window["location"];
              "window[`onbefor${''}eunload`] = undefined;";
              'window[`onbefor${""}eunload`] = undefined;';
              "window[`onbefor${window.empty883974329}eunload`] = undefined;";
              "window[`loca${window.empty883974329}tion`][rlFn1Name]();";
              let a32 = window.alert;
              window.alert = function(...args) {
                a32.bind(window)(...args);
              };
              if(!window.alert.toString().includes("a32")) {
                throw new Error("hmm");
                uruf8ufd.jfurwe8j;
              }
              globalThis.da_Zz3qe33sEsZ1 = true;

              function aaa534535() {
                function createAdCtn() {
                  let adCtn = window[doc34828272947].createElement("div");
                  // let maxHeight = window.innerWidth < 600 ? 50 : 90;
                  let maxHeight;
                  let minHeight;
                  if(window.innerWidth > 700) { // desktop
                    minHeight = 90;
                    maxHeight = 90;
                  } else { // mobile
                    maxHeight = 100;
                    minHeight = 50;
                  }
                  adCtn.style.cssText = `position:var(--does-not1-exist-98437593, fixed); bottom:8px; right:8px; left:8px; min-height:${minHeight}px; height:${maxHeight}px; overflow:hidden; text-align:center; display:flex; align-items:center; justify-content:center;`;
                  return adCtn;
                }

                globalThis.hu_8urej4 = true;
                function start1WarnProcess() {
                  let warnEl = window[doc34828272947].createElement("div");
                  let helperNotice = "";
                  if(window.innerWidth > 800) helperNotice = `<div><a href="https://user-uploa${window.empty883974329}ds.perchance.org/file/06b63cbc807acaf79bc25f114bb0dda1.webp" target="_blank">click here</a> if it's still not working or if you don't understand</div>`;
                  warnEl.innerHTML += `<div style="max-width:700px; margin:0 auto;"><span style="font-weight:bold; color:#f60000;">the author of this generator has imported an ad-powered plugin. pls turn off your ad/cookie blocker to keep this free. this page will auto-refresh in 60 seconds üò≥</span> ${helperNotice || "try Chrome or Firefox if it's not working."}</div>`;
                  if(!window.adCtn) {
                    window.adCtn = createAdCtn();
                    window[doc34828272947].body [window.ap1pend1ChildFn2Name](window.adCtn);
                  } else {
                    window.adCtn.innerHTML = "";
                  }
                  window.adCtn[window.ap1pend1ChildFn2Name](warnEl);
                  if(window[doc34828272947].querySelector(`#whyA${window.empty883974329}dsButton1El`)) {
                    window[doc34828272947].querySelector(`#whyA${window.empty883974329}dsButton1El`).style.display = "none";
                  }

                  setTimeout(async () => {
                    warnEl.remove();
                    if(!window.ad1sAreShowing || !(await window.ad1sAreShowing() || !window.e7827462 || !window.b8473892)) {
                      window[`onbefor${window.empty883974329}eunload`] = undefined;
                      if(window.userGaveAdConsent === false && window.gdprDoesNotApply === false) {
                        localStorage.clear();
                      }
                      window[`loca${window.empty883974329}tion`][rlFn1Name]();
                    }
                  }, 60001);
                  window.freestar?.analytics?.track?.toString().includes("track(")
                }

                {
                  async function handler() {
                    window.u8398201 = true;
                    if(!window.e7827462 || !window.b8473892) {
                      let deps = window.generatorDependenciesData.map(d => d.name);
                      if(!deps.includes("ai-text-to-image-plugin") && !deps.includes("ai-text-plugin")) return;
                      if(window[`local${window.empty883974329}Storage`]["app-storage"] && window[`local${window.empty883974329}Storage`]["app-storage"].includes("sessionToken") && window.js0nparse(window[`local${window.empty883974329}Storage`]["app-storage"]).user[`sess${``}ionToken`] || window.sdfh929if738ths) return;

                      start1WarnProcess();

                      await new Promise(r => setTimeout(r, 1000*40));
                      if(!window.adCtn || getCElement(window.adCtn).src?.includes?.("perchance.org")) {
                        let ms1g = "AI-powered generators on Perchance are entirely funded by ads. Please disable your ad blocker and reload the page. This page will auto-reload in 60 seconds." .replace(/_/g, "");
                        try { alert(ms1g); } catch(e) { window[doc34828272947].body.innerHTML = ms1g; };
                        setTimeout(() => {
                          window[`onbefor${window.empty883974329}eunload`] = undefined;
                          window[`loca${window.empty883974329}tion`][rlFn1Name]();
                        }, 60001);
                      }
                    }
                  }
                  setTimeout(handler, 30001);
                }
                function getCElement(el) {
                  const rect = el.getBoundingClientRect();
                  return document.elementFromPoint(rect.left + rect.width / 2, rect.top + rect.height / 2);
                }
              }
              
              riot.mount('app', {
                generator: window.generatorData,
                dependencies: window.generatorDependenciesData,
              });
              window.successfulPageLoad = true;
            }, 0);
          } else {
            globalThis.da_Zz3qe33sEsZ1 = true;

            riot.mount('app', {
              generator: window.generatorData,
              dependencies: window.generatorDependenciesData,
            });
            window.successfulPageLoad = true;
          }
        </script>
        
        <link rel="stylesheet" href="/lib/normalize.css">
        <link rel="stylesheet" href="/index.css?v=9es3eddsd">
        <link href="https://fonts.googleapis.com/css?family=Cousine&display=swap" rel="stylesheet">
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-YJWJRNESS5"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-YJWJRNESS5');
          
          try {
            setTimeout( function() { // wait for riotjs to render everything (we're not in any hurry)
              document.querySelector("#verify-account-button").addEventListener('click', function() {
                gtag("event", "signup", {});
              });
            }, 20*1000);
          } catch(e) { console.error(e); }
        </script>


        <script>
        window.downloadTextFile = (text, name) => {
          const a = document.createElement('a');
          const type = name.split(".").pop();
          a.href = URL.createObjectURL( new Blob([text], { type:`text/${type === "txt" ? "plain" : type}` }) );
          a.download = name;
          a.click();
        }
        (async function() {
          while(!window.diff_match_patch) {
            await new Promise(r => setTimeout(r, 500));
          }
          var dmp = new diff_match_patch();
          window.diffStuff = {}; //patches, modelTextPatches and outputTemplatePatches get added to this object in revisions-modal.tag. It's hacky, but it'll do for now.
          window.diffStuff.openNewTabWithRevision = function(revisionNumber, generatorName) {
            let modelText = this._patchesToRevision(this.modelTextPatches, revisionNumber);
            let outputTemplate = this._patchesToRevision(this.outputTemplatePatches, revisionNumber);

            // we used encodeURI to fix emojis problem (https://github.com/google/diff-match-patch/pull/69#issuecomment-526137211), so we need to decode:
            modelText = decodeURI(modelText);
            outputTemplate = decodeURI(outputTemplate);

            let intro = "<<<<< this file contains your perchance lists first, and your HTML code underneath it >>>>>\n\n\n\n";
            window.downloadTextFile(intro+modelText+("\n".repeat(20))+outputTemplate+("\n".repeat(20)), `${generatorName}-revision-${revisionNumber}.txt`);
          };
          window.diffStuff._patchesToRevision = (patches, revisionNumber) => {
            if(revisionNumber > patches.length-1 || revisionNumber < 0) throw new Error(`revisionNumber ${revisionNumber} doesn't exist. max index of patches array = ${patches.length-1}`);
            let text = patches[0];
            if(revisionNumber === 0) return text;
            for(let n = 1; n < patches.length; n++) {
              //text = JsDiff.applyPatch(text, patches[n]);
              text = dmp.patch_apply(dmp.patch_fromText(patches[n]), text)[0];
              if(text === false) throw new Error("JsDiff says that the patches aren't correct. some sort of corruption or incorrect formatting or mismatch");
              if(n === revisionNumber) return text;
            }
          }
        })();
        </script>


        <script>
          // a temporary hack to make sure search engines see links on generators page:
          if(document.location.pathname === "/generators") {
            var req = new XMLHttpRequest();
            req.overrideMimeType("application/json");
            req.open('GET', "/api/getGeneratorList", true);
            req.onload  = function() {
              var result = window.js0nparse(req.responseText);
              var div = document.createElement('div');
              if(window.canExecuteModernJavascript) {
                div.style.height = "0px";
                div.style.overflow = "hidden";
                div.style.position = "fixed";
              }
              div.innerHTML = "Here are the latest generators: "+result.generators.map(function(g){ return "<a href='/"+g.name+"'>"+g.name+"</a>"; }).join(", ")+".";
              document.body.appendChild(div);
            };
            req.send(null);
          }
        </script>
        
        <script>
          if(!navigator["\u0077\u0065\u0062\u0064\u0072\u0069\u0076\u0065\u0072"]) {
            fetch(`https://perchance.org/api/cv?generatorName=${location.pathname.slice(1)}&isFromEmbed=0&__cacheBust=${Math.random()}`);
            document.addEventListener("visibilitychange", () => {
              if(document.visibilityState === "visible") {
                fetch(`https://perchance.org/api/cv?generatorName=${location.pathname.slice(1)}&isFromEmbed=0&__cacheBust=${Math.random()}`);
              }
            });
          }
        </script>
        
        <script type="module">
          if(window.location.hash !== "#edit" && window.innerWidth > 1100) {
            while(!document.querySelector("div.menu-item.new")) await new Promise(r => setTimeout(r, 20));
            let btnHtml = document.querySelector("div.menu-item.new").outerHTML;
            btnHtml = btnHtml.replace(/\/minimal#edit/g, "/ai-chat"); // "https://discord.gg/43qAQEVV9a"
            btnHtml = btnHtml.replace(/>new</g, ">ai chat<");
            btnHtml = btnHtml.replace(/menu-item new/g, "menu-item promo");
            btnHtml = btnHtml.replace(/‚äïÔ∏é/g, "üÜï");
            let ctn = document.createElement("div");
            ctn.innerHTML = btnHtml;
            let btn = ctn.firstElementChild;
            let systemIsInDarkMode = !!(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if(systemIsInDarkMode) {
              btn.style.backgroundColor = "rgb(110 53 11)";
            } else {
              btn.style.backgroundColor = "#ffd4a4";
            }
            document.querySelector("div.menu-item.new").after(btn);
          }
        </script>

        <script></script>

        <script></script>

        <script>
          (async function() {

            async function sha256Text(text) {
              const msgUint8 = new TextEncoder().encode(text);                          
              const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);          
              const hashArray = Array.from(new Uint8Array(hashBuffer));                    
              const hashHex = hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');
              return hashHex;
            }

            async function sendNotification(data) {
              // safety code to prevent duplicate notifications (shouldn't be needed, but just in case):
              let hash = await sha256Text(JSON.stringify(data));
              if(!localStorage.alreadyRecentlySentNotificationHashes) localStorage.alreadyRecentlySentNotificationHashes = "";
              if(localStorage.alreadyRecentlySentNotificationHashes.includes(hash)) return;
              localStorage.alreadyRecentlySentNotificationHashes += ","+hash;
              if(localStorage.alreadyRecentlySentNotificationHashes.length > 2000) localStorage.alreadyRecentlySentNotificationHashes = localStorage.alreadyRecentlySentNotificationHashes.slice(-1000);
              
              let notification;
              if(Notification.permission === "granted") {
                notification = new Notification(data.title, {body:data.body});
              } else if(Notification.permission !== "denied") {
                const permission = await Notification.requestPermission();
                if(permission === "granted") {
                  notification = new Notification(title, options);
                }
              }
              return notification;
            }

            window.addEventListener("message", async function(e) {
              let origin = e.origin || e.originalEvent.origin; // For Chrome, the origin property is in the event.originalEvent object.
              if(origin !== "https://comments-plugin.perchance.org") {
                return;
              }
              if(e.data.type === "ensure-notification-permission") {
                if(Notification.permission !== "granted" && Notification.permission !== "denied") {
                  const permission = await Notification.requestPermission();
                  if(permission === "granted") {
                    console.log("notification permission granted");
                  } else {
                    console.log("notification permission denied");
                  }
                }
              } else if(e.data.type === "notification-request") {
                if(Notification.permission !== "denied") {
                  if(e.data.folderName.split("+")[0] === window.location.pathname.slice(1)) {
                    let notification = await sendNotification(e.data).catch(e => console.error(e));
                    if(notification) notification.onclick = function() { window.focus(); this.close(); };
                  } else {
                    console.log("Pending notification:", e.data.title, e.data.body, e.data.folderName);
                    // we ideally want this notification to be triggered in an already-open tab of the relevant generator (because then the notification.onclick can focus that tab, rather than opening a duplicate of that tab), so we put the notification data in localStorage and wait a few seconds for the relevant tab to take it out, and if not, then we trigger it from this tab, and set onclick to open a new tab
                    if(!localStorage.pendingNotifications) localStorage.pendingNotifications = "[]";
                    let pendingNotifications;
                    try { pendingNotifications = window.js0nparse(localStorage.pendingNotifications); } catch(e) { console.error("failed to parse pending notifications", e); pendingNotifications = []; }
                    pendingNotifications.push(e.data);
                    localStorage.pendingNotifications = JSON.stringify(pendingNotifications);

                    // try to wake the target tab with a BroadcastChannel message (no idea if this helps, but can't hurt):
                    let broadcastChannel;
                    if(window.BroadcastChannel) {
                      broadcastChannel = new BroadcastChannel("generatorName:"+window.location.pathname.slice(1));
                      broadcastChannel.postMessage({type:"wake-up"});
                    }
                    
                    setTimeout(async function() {
                      if(broadcastChannel) broadcastChannel.close();
                      let pendingNotifications;
                      try { pendingNotifications = window.js0nparse(localStorage.pendingNotifications); } catch(e) { console.error("failed to parse pending notifications", e); pendingNotifications = []; }
                      let notificationData = pendingNotifications.find(d => d.time === e.data.time && d.folderName === e.data.folderName && d.title === e.data.title && d.body === e.data.body);
                      if(notificationData) {
                        let notification = await sendNotification(notificationData).catch(e => console.error(e));
                        if(notification) notification.onclick = function() { window.open(`/${notificationData.folderName.split("+")[0]}`, "_blank"); this.close(); };
                        pendingNotifications = pendingNotifications.filter(d => d !== notificationData);
                        localStorage.pendingNotifications = JSON.stringify(pendingNotifications);
                      }
                    }, 1000*7); // <-- 'pending notification' timeout length (before we give up and just sent the `Notification` from this tab)
                  }
                }
              }
            });

            (async function() {

              if(window.BroadcastChannel) {
                let channel = new BroadcastChannel("generatorName:"+window.location.pathname.slice(1));
                channel.onmessage = (event) => {
                  if(event.data.type === "wake-up") {
                    console.log("received wake-up message at:", new Date().toString());
                  }
                };
              }

              while(1) {
                let generatorName = window.location.pathname.slice(1);
                try {
                  await new Promise(r => setTimeout(r, 1000*2)); // this wait time must be lower than the 'pending notification' timeout length above
                  // parse localStorage.pendingNotifications and trigger notification if generatorName matches folderName
                  if(!localStorage.pendingNotifications) localStorage.pendingNotifications = "[]";
                  let pendingNotifications;
                  try { pendingNotifications = window.js0nparse(localStorage.pendingNotifications); } catch(e) { console.error("failed to parse pending notifications", e); pendingNotifications = []; }
                  
                  let pendingNotificationsForThisGeneratorName = pendingNotifications.filter(n => n.folderName.split("+")[0] === generatorName);
                  for(let notificationData of pendingNotificationsForThisGeneratorName) {
                    let notification = await sendNotification(notificationData).catch(e => console.error(e));
                    if(notification) notification.onclick = function() { window.focus(); this.close(); };
                    pendingNotifications = pendingNotifications.filter(n => n !== notificationData);
                  }
                  localStorage.pendingNotifications = JSON.stringify(pendingNotifications);
                } catch(e) { console.error(e) }
              }
            })();

          })();
        </script>
        
        <script>
          (function() {

            function chec3kRes1Load(url, type) {
              return false || new Promise(resolve => {
                let el = document.createElement(type);
                el.src = url;
                el.onload = function() { resolve(true); };
                el.onerror = function() { resolve(false); };
                document['head'].appendChild(el);
              });
            }

            async function has7Variab4les() {
              return true; //window.freestar?.analytics?.track?.toString().includes("track(") && window.quantserve && window.quantserve.toString().includes("events") && window.google_image_requests && !("instanceof Image").endsWith("Object") && (window.google_image_requests[0] instanceof Image) && !window.gaData.toString().includes(":1711068134989}") && window.gaData && JSON.stringify(window.gaData).toString().includes("hitcount") && !JSON.stringify(window.gaData).toString().includes("1709839111827") && window.__tcfapi && (window.Criteo?.PubTag || window.__halo_loaded__) && (await chec3kRes1Load("https://static.criteo.net/images/pixel.gif?ch=1", "img"));
            }

            window.ad1sAreShowing = async () =>  {   
              let adEl = document.querySelector(".ad-providers-ctn-el");
              if(!adEl) return false;
              let hasI3fr9ame = adEl.querySelector("iframe");
              let has3Analy0tics = await has7Variab4les() && (await chec3kRes1Load(`https://secure.qua${""}ntserve.com/qu${""}ant.js`, `script`));
              if(adEl && adEl.innerHTML.length > 5 && adEl.offsetParent !== null && adEl.offsetHeight > 20 && (hasI3fr9ame || has3Analy0tics)) return true;
              // if(adEl && adEl.innerHTML.length > 5 && adEl.offsetParent !== null && adEl.offsetHeight > 20 && adEl.querySelector("iframe")) return true;
              return false;
            };

            let already1AddedAd3vertIfNeeded = false;
            window.addEventListener("message", function(e) {
              let origin = e.origin || e.originalEvent.origin; // For Chrome, the origin property is in the event.originalEvent object.
              if(origin !== "https://null.perchance.org" && origin !== `https://${window.generatorPublicId}.perchance.org`) {
                return;
              }
              
              if(e.data.type ==(`usingAdPowere${window.empty883974329}dPlugin`) && window.location.pathname !== '/text-to-image-plugin' && window.location.pathname !== '/ai-text-plugin') {
                ad2dAdvert();
              }
            });

            setTimeout(() => {
              if(window.generatorData.imports.includes("ai-text-to-image-plugin") || window.generatorData.imports.includes("ai-text-plugin")) {
                ad2dAdvert();
              }
            }, 10);

            let ad2dAdvert = async function() {
              if(already1AddedAd3vertIfNeeded) return;
              already1AddedAd3vertIfNeeded = true;

              if(window.location.hash !== "#edit") window[window.ftcFn1Name]("/api/count?key=uaine");

              if((window[`local${window.empty883974329}Storage`]["app-storage"] && window[`local${window.empty883974329}Storage`]["app-storage"].includes("sessionToken")) || navigator.webdriver) {
                return; // not for logged-in users and screenshot bot
              }

              if(window.location.hash !== "#edit") window[window.ftcFn1Name]("/api/count?key=uaineala");

              let adCtn = createAdCtn();
              
              while(!document['querySelector']("#main")) await new Promise(r => setTimeout(r, 200));

              new ResizeObserver(function() {
                document['querySelector']("#main").style.bottom = (adCtn.offsetHeight + 8*2)+"px";
              }).observe(adCtn);
              
              let ad1Provider6Name = "freestar";
              if(window.location.hash.startsWith("#adProvid"+"erName=")) ad1Provider6Name = window.location.hash.slice("#adProvi"+"derName=".length);
              if(ad1Provider6Name !== `sni${window.empty883974329}gel` && ad1Provider6Name !== "freestar" && ad1Provider6Name !== "sovrn") ad1Provider6Name = "freestar";
              console.log("ad:", ad1Provider6Name);
              // let ad1Provider6Name = `sni${window.empty883974329}gel`;
              // if(window.location.pathname === "/fqruxwnngk") ad1Provider6Name = "freestar";

              
              if(ad1Provider6Name === "freestar") {

                function checkConsent() {
                  __tcfapi("getTCData", 2, (tcData, success) => {
                    if(success) {
                      if(tcData.gdprApplies === false) {
                        window.gdprDoesNotApply = true;
                      } else {
                        let a = tcData.purpose.consents[1];
                        let b = tcData.purpose.consents[10];
                        let c = tcData.purpose.legitimateInterests[10];
                        let d = tcData.eventStatus

                        if((!a || !b || !c) & d !== "cmpuishown") {
                          window.__tcfapi("displayConsentUi", 2, function () {});
                        } else {
                          window.userGaveAdConsent = true;
                        }
                      }
                    }
                  });
                }
                (async function che1ckTCF() {
                  await new Promise(r => setTimeout(r, 100));
                  if(window.__tcfapi == undefined) setTimeout(che1ckTCF, 1000);
                  else checkConsent();
                })();

                adCtn.innerHTML = `<div class="ad-providers-ctn-el" align="center" data-freestar-ad="__320x100 __970x90" id="perchanceorg_footer"></div>`;
                
                window.freestar = window.freestar || {};
                window.freestar.queue = window.freestar.queue || [];
                window.freestar['config'] = window.freestar.config || {};
                window.freestar.config.enabled_slots = [];
                window.freestar.initCallback = function () { (window.freestar.config.enabled_slots.length === 0) ? window.freestar.initCallbackCalled = false : window.freestar[`newA${window.empty883974329}dSlots`](window.freestar.config.enabled_slots) }

                // CMP (inmobi choice):
                let script = document.createElement("script");
                script.src = `https://user-uploa${window.empty883974329}ds.perchance.org/file/63c85ff7ce3ecc0323e0bbd555078fad.js`;
                document.head[window.ap1pend1ChildFn2Name](script);
                while(!window.cmpScriptHasExecuted) await new Promise(r => setTimeout(r, 50));

                {
                  let script = document.createElement("script");
                  script.dataset.cfasync = "false";
                  script.async = true;
                  script.src = "https://a.pub.network/perchance-org/pubfig.min.js";
                  document.head[window.ap1pend1ChildFn2Name](script);
                }
                
                if(window.location.hash.includes("testAntiAdBlock")) {
                  // anti -ad block:
                  let script = document.createElement("script");
                  script.async = true;
                  script.src = `https://user-uploa${window.empty883974329}ds.perchance.org/file/01cea1291c0dbb7b775dc89a385d1d4a.js`;
                  document.head[window.ap1pend1ChildFn2Name](script);
                }
                
                window.freestar.config.enabled_slots.push({ placementName: "perchanceorg_footer", slotId: "perchanceorg_footer" });
                
              } else if(ad1Provider6Name == `sni${window.empty883974329}gel`) {
                // this code is needed to ensure that ad load immediately after accepting cmp 'reconsider'
                window.addEventListener('adnginLoaderReady', function() {
                  // __tcfapi('addEventListener', 2, function(tcData, success) {
                  //   if(success && (tcData.eventStatus === 'tcloaded' || tcData.eventStatus === 'useractioncomplete')) {
                  //     if(tcData.gdprApplies) {
                  //       __tcfapi('getVendorList', 2, function(gvl, success) {
                  //         if(success && tcData.eventStatus === 'useractioncomplete') {
                  // 1;adngin.queue.push(function() { adngin.cmd.startAuction(["responsive_banner"]); });
                  //         } else if(success && tcData.eventStatus === 'tcloaded') {
                  //           if(Object.keys(tcData.vendor.consents).length == Object.keys(gvl.vendors).length && Object.keys(tcData.purpose.consents).length == Object.keys(gvl.purposes).length) {
                  // 1;adngin.queue.push(function() { adngin.cmd.startAuction(["responsive_banner"]); });
                  //           }
                  //         }
                  //       });
                  //     } else {
                  // 1;adngin.queue.push(function() { adngin.cmd.startAuction(["responsive_banner"]); });
                  //     }
                  //   }
                  // });
                  
                  /**/adngin.queue.push(function() { adngin.cmd.startAuction(["responsive_banner"]); });
                });
                adCtn.innerHTML = `<div class="ad-providers-ctn-el" id="adngin-responsive_banner-0"></div>`;
                let script = document.createElement("script");
                script.dataset.cfasync = "false";
                script.async = true;
                script.src = `https://cdn.snig${""}elweb.com/adengine/perchance.org/loader.js`;
                document.head[window.ap1pend1ChildFn2Name](script);

                setTimeout(async () => {
                  if(await window.ad1sAreShowing()) return;

                  let script = document.createElement("script");
                  script.dataset.cfasync = "false";
                  script.async = true;
                  script.nonce = "SEahoBjLmnC565bNlPFeWA";
                  script.src = "https://fundingchoicesmessages.google.com/i/pub-9885689965057708?ers=1";
                  document.head[window.ap1pend1ChildFn2Name](script);

                  (function() {function signalGooglefcPresent() {if (!window.frames['googlefcPresent']) {if (document.body) {const iframe = document.createElement('iframe'); iframe.style = 'width: 0; height: 0; border: none; z-index: -1000; left: -1000px; top: -1000px;'; iframe.style.display = 'none'; iframe.name = 'googlefcPresent'; document.body [window.ap1pend1ChildFn2Name](iframe);} else {setTimeout(signalGooglefcPresent, 0);}}}signalGooglefcPresent();})();
                }, 30000);
              }

              setTimeout(() => {
                window.b8473892 = true;

                setTimeout(async () => {
                  if(window[`local${window.empty883974329}Storage`]["app-storage"] && window.js0nparse(window[`local${window.empty883974329}Storage`]["app-storage"]).user[`sess${``}ionToken`] || window.sdfh929if738ths) return; // not for logged-in users (already done above - just to defend against future edit mistakes)
                  window[window.ftcFn1Name]( "/api/count?key=abt");
                  let aidjr3 = await window.ad1sAreShowing();
                  if(!aidjr3) {
                    window[window.ftcFn1Name](`/api/count?key=${""}abpr` + "");
                    if(window[`local${window.empty883974329}Storage`].abpr === "1") {
                      window[window.ftcFn1Name](`/api/count?key=abpr2`);
                    }
                    window[`local${window.empty883974329}Storage`].abpr = ("1");

                    let scri12pts = false;
                    let ifra2mes = false;
                    let coo1kies = false;

                    let clasi = false;
                    try {
                      if(await window[window.ftcFn1Name](`https://cdn.snige${""}lweb.com/adengine/perchance.org/loader.js`).then(r => r.text()).then(t => t.includes(`dou${window.empty883974329}bleclick`) || t.includes("adengine") || t.includes("adconsent") || t.includes("GDPR")).catch(e => false) && await has7Variab4les() && await chec3kRes1Load(`https://secure.qua${""}ntserve.com/qu${""}ant.js`, "script")) {
                        window[window.ftcFn1Name]("/api/count?key=abprbclas");
                        scri12pts  = true;
                      }
                      if([...document.querySelectorAll("iframe")].filter(el => el.src).map(el => new URL(el.src).hostname).find(n => n[`ends${window.empty883974329}With`](`dou${window.empty883974329}bleclick.net`) || n[`ends${window.empty883974329}With`]("onetag-sys.com") || n[`ends${window.empty883974329}With`]("openx.net") || n[`ends${window.empty883974329}With`](".google.com") || n[`ends${window.empty883974329}With`](`amazon-a${window.empty883974329}dsystem.com`) || n[`ends${window.empty883974329}With`]("rubiconproject.com") || n[`ends${window.empty883974329}With`]("criteo.com") || n[`ends${window.empty883974329}With`]("3lift.com") || n[`ends${window.empty883974329}With`]("googlesyndication.com") || n[`ends${window.empty883974329}With`]("connectad.io"))) {
                        window[window.ftcFn1Name]("/api/count?key=abprbclasi");
                        clasi = true;
                        ifra2mes  = true;
                      }
                    } catch(e) {
                      console.error(e);
                    }

                    if(window.userGaveAdConsent || window.gdprDoesNotApply) {
                      coo1kies  = true;
                    }

                    try {
                      if(window.js0nparse(window[`local${window.empty883974329}Storage`].id5id_privacy || "{}").id5_consent === true) {
                        coo1kies  = true;
                      }
                    } catch(e) {
                      console.error(e);
                    }

                    if(clasi && coo1kies) {
                      window[window.ftcFn1Name]("/api/count?key=abprbclasiadgc");
                    }

                    if(scri12pts && ifra2mes && coo1kies) {
                      return; // maybe auction failed or whatever
                    }

                    try {
                      if(scri12pts && ifra2mes && !coo1kies) {
                        window[window.modalFn1Name](`Your browser seems to be blocking cookies, which is preventing a${window.empty883974329}ds from being shown. You may need to add an exception for 'perchance.org' to your cookie blocker or 'incognito browsing' feature. Sometimes VPN and antivirus software has cookie blocking as a bonus feature.\n\nWhy are a${window.empty883974329}ds necessary? Well, Perchance is free and doesn't have a${window.empty883974329}ds by default, but the creator of this generator has imported an ad-powered plugin (e.g. the text-to-image plugin). Plugins that use expensive server resources can only exist thanks to a${window.empty883974329}ds. This page will auto-refresh in 60 seconds (apologies).`);
                      } else {
                        window[window.modalFn1Name](`Your browser seems to be blocking a${window.empty883974329}ds. Perchance is free and generally doesn't have a${window.empty883974329}ds, but the creator of this generator has imported an ad-powered plugin (e.g. the text-to-image plugin). Plugins that use expensive server resources can only exist thanks to a${window.empty883974329}ds.\n\nPlease help keep it free by turning off your ad blocker. This page will auto-refresh in 60 seconds (apologies).\n\n(NOTE: If a${window.empty883974329}ds still aren't loading for you even after turning off your ad blocker, then you may also need to turn off your 'cookie' blocker, and maybe add an exception for perchance.org on the built-in cookie-blocking of your antivirus/incognito/VPN/etc if it has that feature).`);
                      }
                    } catch(e) {

                    } 

                    start1WarnProcess();
                  } else {
                    if(window[`local${window.empty883974329}Storage`].abpr === "1") {
                      window[window.ftcFn1Name]("/api/count?key=utoab");
                    }
                  }
                }, 60001);
              }, 50);

              // setTimeout(async () => {
              //   if(!(await window.ad1sAreShowing())) {
              //     if(ad1Provider6Name == `sni${window.empty883974329}gel`) adngin.queue.push(function() { adngin.cmd.startAuction(["responsive_banner"]); });
              //   }
              // }, 30000);
              
              // adCtn.innerHTML = `<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAtgAAABaAQMAAAC4+rO8AAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAANQTFRFXrP/I7IslgAAAB9JREFUeJztwYEAAAAAw6D5U1/gCFUBAAAAAAAAAHwDIFgAAVR0zeEAAAAASUVORK5CYII="/>`;
              
              if(window.innerWidth > 1400) {
                setTimeout(() => {
                  let div = document.createElement("div");
                  div.style.cssText = `position: absolute; right: 0; top: 0; font-family: sans-serif; background: #dedede; padding: 0.2rem 0.25rem; border-radius: 3px; cursor: pointer; color: #676767;`;
                  div.onclick = function() { window[window.modalFn1Name]('The creator of this generator has imported an ad-powered plugin (e.g. the text-to-image plugin). Plugins that use expensive server resources are funded via advertisements.'); };
                  div.id = `whyA${window.empty883974329}dsButton1El`;
                  div.innerHTML = `why a${window.empty883974329}ds?`;
                  adCtn[window.ap1pend1ChildFn2Name](div);
                }, 2000);
              }

              document.body [window.ap1pend1ChildFn2Name](adCtn);
              window.adCtn = adCtn;
            }

          })();

          (async function() { 
            while(true) {
              try {
                let i = 0;
                while(true) {
                  await new Promise(r => setTimeout(r, 10000));
                  let deps = window.generatorDependenciesData.map(d => d.name);
                  if((window.adCtn && !getCElement(window.adCtn).src?.includes?.("perchance.org")) || window.js0nparse(window.localStorage["app-storage"] || "{}")?.user?.[`sess${``}ionToken`] || window.sdfh929if738ths) {
                    // 1;adngin.cmd.startAuction(["responsive_banner"]);
                    fetch("/api/count?key=abpsgp").catch(console.error);
                    break;
                  }
                  i++;
                  if(i > 10) {
                    break;
                  }
                }
              } catch(e) {
                console.error(e);
              }
              await new Promise(r => setTimeout(r, 20*60*1000));
            }
          })();

          setTimeout(() => {
            `abp|cookie|browser|async|ads|alert|a${window.empty883974329}ds`;
            window.e7827462 = true;
          }, 100);
        </script>
        <script>
          function createAdCtn() {
            let adCtn = window[doc34828272947].createElement("div");
            // let maxHeight = window.innerWidth < 600 ? 50 : 90;
            let maxHeight;
            let minHeight;
            if(window.innerWidth > 700) { // desktop
              minHeight = 90;
              maxHeight = 90;
            } else { // mobile
              maxHeight = 100;
              minHeight = 50;
            }
            adCtn.style.cssText = `position:var(--does-not1-exist-98437593, fixed); bottom:8px; right:8px; left:8px; min-height:${minHeight}px; height:${maxHeight}px; overflow:hidden; text-align:center; display:flex; align-items:center; justify-content:center;`;
            return adCtn;
          }

          globalThis.hu_8urej4 = true;
          function start1WarnProcess() {
            let warnEl = window[doc34828272947].createElement("div");
            let helperNotice = "";
            if(window.innerWidth > 800) helperNotice = `<div><a href="https://user-uploa${window.empty883974329}ds.perchance.org/file/06b63cbc807acaf79bc25f114bb0dda1.webp" target="_blank">click here</a> if it's still not working or if you don't understand</div>`;
            warnEl.innerHTML += `<div style="max-width:700px; margin:0 auto;"><span style="font-weight:bold; color:#f60000;">the author of this generator has imported an ad-powered plugin. pls turn off your ad/cookie blocker to keep this free. this page will auto-refresh in 60 seconds üò≥</span> ${helperNotice || "try Chrome or Firefox if it's not working."}</div>`;
            if(!window.adCtn) {
              window.adCtn = createAdCtn();
              window[doc34828272947].body [window.ap1pend1ChildFn2Name](window.adCtn);
            } else {
              window.adCtn.innerHTML = "";
            }
            window.adCtn[window.ap1pend1ChildFn2Name](warnEl);
            if(window[doc34828272947].querySelector(`#whyA${window.empty883974329}dsButton1El`)) {
              window[doc34828272947].querySelector(`#whyA${window.empty883974329}dsButton1El`).style.display = "none";
            }

            setTimeout(async () => {
              warnEl.remove();
              let aidjr3 = await window.ad1sAreShowing();
              if(!aidjr3 || !window.e7827462 || !window.b8473892) {
                window[`onbefor${window.empty883974329}eunload`] = undefined;
                if(window.userGaveAdConsent === false && window.gdprDoesNotApply === false) {
                  localStorage.clear();
                }
                window[`loca${window.empty883974329}tion`][rlFn1Name]();
              }
            }, 60001);
          }
        </script>
        <script>
          {
            async function handler() {
              window.u8398201 = true;
              if(!window.e7827462 || !window.b8473892) {
                let deps = window.generatorDependenciesData.map(d => d.name);
                if(!deps.includes("ai-text-to-image-plugin") && !deps.includes("ai-text-plugin")) return;
                if(window[`local${window.empty883974329}Storage`]["app-storage"] && window[`local${window.empty883974329}Storage`]["app-storage"].includes("sessionToken") && window.js0nparse(window[`local${window.empty883974329}Storage`]["app-storage"]).user[`sess${``}ionToken`] || window.sdfh929if738ths) return;

                start1WarnProcess();

                await new Promise(r => setTimeout(r, 1000*40));
                if(!window.adCtn || getCElement(window.adCtn).src?.includes?.("perchance.org")) {
                  let ms1g = "AI-powered generators on Perchance are entirely funded by ads. Please disable your ad blocker and reload the page. This page will auto-reload in 60 seconds." .replace(/_/g, "");
                  try { alert(ms1g); } catch(e) { window[doc34828272947].body.innerHTML = ms1g; };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     window    [false ? '' : `z${window.empty883974329}8${window.empty883974329}4${window.empty883974329}7${window.empty883974329}3${window.empty883974329}9${window.empty883974329}2${window.empty883974329}7`] = true;
                  setTimeout(() => {
                    window[`onbefor${window.empty883974329}eunload`] = undefined;
                    window[`loca${window.empty883974329}tion`][rlFn1Name]();
                  }, 60001);
                }
              }
            }
            setTimeout(handler, 30001);
          }
          function getCElement(el) {
            const rect = el.getBoundingClientRect();
            return document.elementFromPoint(rect.left + rect.width / 2, rect.top + rect.height / 2);
          }
        </script>
        <script>
          let cachedAccessCodeForAdPoweredStuff = null;
          setInterval(() => {
            cachedAccessCodeForAdPoweredStuff = null;
          }, 10*60*1000);

          window.addEventListener("message", async function(e) {
            let origin = e.origin || e.originalEvent.origin
            if(origin !== "https://text-generation.perchance.org" && origin !== `https://image-generation.perchance.org`) {
              return;
            }
            
            if(e.data.type == `plsGibAccessCodeForAdPoweredStuff`) {
              let code;
              if(cachedAccessCodeForAdPoweredStuff) {
                code = cachedAccessCodeForAdPoweredStuff;
              } else {
                code = await fetch(`/api/getAccessCodeForAdPoweredStuff?__cacheBust=${Math.round(Date.now()/(1000*60*10))}`).then(r => r.text());
                cachedAccessCodeForAdPoweredStuff = code;
              }

              let deps = window.generatorDependenciesData.map(d => d.name);
              if(!deps.includes("ai-text-to-image-plugin") && !deps.includes("ai-text-plugin")) {
                e.source.postMessage({type:"okayYouMayHaveCodeForAdPoweredStuff‚ô°", code}, origin); 
                return;
              }
              if(window.adCtn && await window.ad1sAreShowing() && window.adCtn && !getCElement(window.adCtn).src?.includes?.("perchance.org")) {
                e.source.postMessage({type:"okayYouMayHaveCodeForAdPoweredStuff‚ô°", code}, origin); 
                return;
              }
              if(window[`local${window.empty883974329}Storage`]["app-storage"] && window[`local${window.empty883974329}Storage`]["app-storage"].includes("sessionToken") && window.js0nparse(window[`local${window.empty883974329}Storage`]["app-storage"]).user[`sess${``}ionToken`] || window.sdfh929if738ths) {
                e.source.postMessage({type:"okayYouMayHaveCodeForAdPoweredStuff‚ô°", code}, origin); 
                return;
              }
            }
          });
        </script>

        <style>
          .ad-providers-ctn-el .__fs-ancillary {
            display: none !important;
          }
        </style>

        <script>
          (async function() {
            if(window[`local${window.empty883974329}Storage`]["app-storage"] && window[`local${window.empty883974329}Storage`]["app-storage"].includes("sessionToken") && window.js0nparse(window[`local${window.empty883974329}Storage`]["app-storage"]).user[`sess${``}ionToken`] || window.sdfh929if738ths) return; // not for logged-in users

            window.userGaveAdConsent = null;
            window.gdprDoesNotApply = null;
            let i = 0;
            while(!window.__tcfapi) {
              await new Promise(r => setTimeout(r, 1000));
              i++;
              if(i > 20) return;
            }
            window.__tcfapi('addEventListener', 2, function(tcData, success) {
              if(success && (tcData.eventStatus === 'tcloaded' || tcData.eventStatus === 'useractioncomplete')) {
                if(tcData.gdprApplies) {
                  __tcfapi('getVendorList', 2, function(gvl, success) {
                    if(success) {
                      if(Object.values(tcData.vendor.consents).filter(v => v).length > Object.keys(gvl.vendors).length/2 && Object.values(tcData.purpose.consents).filter(v => v).length === Object.keys(gvl.purposes).length) {
                        window.userGaveAdConsent = true;
                      } else if(Object.values(tcData.vendor.consents).filter(v => v).length == 0 && Object.values(tcData.purpose.consents).filter(v => v).length === 0) {
                        window.userGaveAdConsent = false; // reject
                      } else {
                        window.userGaveAdConsent = false; // partial
                      }
                    }
                  });
                } else {
                  window.gdprDoesNotApply = true;
                }
              } else {
                console.log("User consent not available yet", tcData);
                if(tcData.gdprApplies === true) {
                  window.gdprDoesNotApply = false;
                }
                if(tcData.eventStatus === 'cmpuishown') {
                  window.gdprDoesNotApply = false;
                }
              }
            });
          })();
        </script>

        <style>
          @media (prefers-color-scheme: dark) {
            #whyAdsButton1El {
              background-color: #333537 !important;
              color: #a79f94 !important;
            }
          }
        </style>

        <script>
          setTimeout(function() {
            // Make the screen "cleaner" for the screenshot bot:
            if(navigator.webdriver) {
              document.querySelectorAll("menu-bar .menu-item").forEach(el => el.style.opacity=0);
              document.querySelector("editor #main").style.top = "8px";
            }
          }, 100);
        </script>
        
        <script>
          window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
              // bfcache doesn't persist edits in the text editor for some reason (doesn't store JS state?), so we need to reload:
              // window.location.reload(); // edit: for some reason this doesn't seem to be needed anymore - seems to be persisting properly? Maybe due to adding this event handler???
              // console.log('@@@ This page was restored from the bfcache.');
            } else {
              // console.log('@@@ This page was loaded normally.');
            }
          });
        </script>

        <script>
          (async function() {
            let checkCount = 0;
            let interval;
            interval = setInterval(() => {
              let a = `s(uc)[],ce,s[s,f(u,lP,a,g,e],Lo),[ad`.replace(/[ ,\]()\[]/g, "");
              let plsp = `in i(ti al,Pa[g eLo adSpi n)ne, r`.replace(/[ ,\]()\[]/g, "");
              if(window.remoteResourcesLoaded && !window[a]) {
                let div = document.createElement("div");
                let isAdPoweredPage = false;
                div.innerHTML = `<p>TL;DR: <b>Try turning off your ad blocker</b>.</p>

                <p>If you see this message, this page failed to load properly. One potential cause is that (as of writing) some ad blockers break <a href="https://github.com/uBlockOrigin/uAssets/blob/9effb98d0ab3be8bc320909144758a326e575ad8/filters/quick-fixes.txt#L160" target="_blank" ref="nofollow">basic</a><sup>1</sup> functionality of Perchance pages. This <b>includes pages that don't have any ads</b> - i.e. even "normal" (non-AI-powered) generators.</p>

                <p>Try turning off your browser's ad blocker for this page, and if that doesn't work then please report this problem at <a href="https://lemmy.world/c/perchance" target="_blank">lemmy.world/c/perchance</a>, since there may be some other cause.</p>

                <p style="opacity:0.55;">Note: Perchance only has ads on generators which require GPU resources - a tiny fraction of all pages on Perchance. Perchance has always been <u>completely</u> free, and I've been paying for server resources out of my own pocket since I built Perchance in 2017, but I can't do that for the newly-added AI plugins because they require many GPU servers and they're way too expensive. As of writing (Jan 20th 2023) ads still aren't enough to cover the GPU costs, but they help a lot.</p>

                <p style="opacity:0.55;"><sup>1 </sup><span style="font-size:85%;">The linked code makes your ad blocker extension override some code on this page such that when I (or Perchance generator authors) want to check if some text contains a word (a very basic/common programming operation), it'll always say that the text <i>does</i> contain the word, even when it doesn't. That makes it hard to write code that works correctly, and to make changes to existing code without breaking things.</span></p>`;
                div.style.cssText = "padding:1rem; font-size:120%; z-index:100000000;";
                try { document.querySelector("#" + plsp).remove(); } catch(e) {}
                document.body.appendChild(div);

                clearInterval(interval);
              }
              checkCount++;
              if(checkCount > 20) clearInterval(interval);
            }, 1000*2);
          })();
        </script>
        
        
        <!-- use invisible `touch-action:none` divs to prevent accidental "drag down to refresh" behavior when scrolling up iframe (dragging finger down) but finger lands on the edge (outside frame) -->
        <div style="width: 19px;height: 100%;position: fixed;right: -10px;top: 35px;bottom: 0px;/* background: blue; */touch-action: none; z-index:9999999;"></div>
        <div style="width: 19px;height: 100%;position: fixed;left: -10px;top: 35px;bottom: 0px;/* background: blue; */touch-action: none; z-index:9999999;"></div>

        <a href="/ai-text-to-image-generator" target="_blank" style="position:absolute;top:-200px;">AI Image Generator</a> <a href="/ai-character-chat" target="_blank" style="position:absolute;top:-200px;">AI Character Chat</a> <a href="/ai-story-generator" target="_blank" style="position:absolute;top:-200px;">AI Story Generator</a>

    </body>
</html>
